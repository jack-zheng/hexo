<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/hexo/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/hexo/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/hexo/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/hexo/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="UgODgWVmvTsdD--vjodDR3tPUZRWM3i7JpHzbYejxUM">

<link rel="stylesheet" href="/hexo/css/main.css">


<link rel="stylesheet" href="/hexo/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/hexo/',
    scheme: 'Muse',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="我是张江搬砖小码农, 知识搬运工">
<meta property="og:type" content="website">
<meta property="og:title" content="Jackpot">
<meta property="og:url" content="https://jack-zheng.github.io/hexo/page/10/index.html">
<meta property="og:site_name" content="Jackpot">
<meta property="og:description" content="我是张江搬砖小码农, 知识搬运工">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Jack Zheng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://jack-zheng.github.io/hexo/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Jackpot</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/hexo/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jackpot</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-tags">

    <a href="/hexo/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/hexo/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/hexo/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/jack-zheng" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jack-zheng.github.io/hexo/hexo/2021/04/16/Design-pattern-iterator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/jack.jpg">
      <meta itemprop="name" content="Jack Zheng">
      <meta itemprop="description" content="我是张江搬砖小码农, 知识搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jackpot">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/hexo/2021/04/16/Design-pattern-iterator/" class="post-title-link" itemprop="url">迭代器模式</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-16 17:39:36" itemprop="dateCreated datePublished" datetime="2021-04-16T17:39:36+08:00">2021-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-16 13:29:44" itemprop="dateModified" datetime="2022-02-16T13:29:44+08:00">2022-02-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p><strong>The Iterator Pattern</strong> provides a way to access the elements of an aggregate object sequentially without exposing its underlying representation.<br>迭代器模式可以让我们在不需要知道一个集合的具体实现的情况下，依次访问集合中的各个元素</p>
</blockquote>
<p>it also places the task of traveral(遍历) on the iterator object, not on the aggregate, which simplifies the aggregate interface and implementation, and places the responsibility where it should be.</p>
<blockquote>
<p><strong>Design Principle:</strong> A class should have only one reason to change</p>
</blockquote>
<h2 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">skinparam linetype ortho</span><br><span class="line"></span><br><span class="line">Interface Aggregate &#123;</span><br><span class="line">    +Iterator createIterator()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Interface Iterator &#123;</span><br><span class="line">    +Object next()</span><br><span class="line">    +boolean hasNext()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class ConcreateAgg implements Aggregate &#123;</span><br><span class="line">    +Iterator createIterator()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class ConcreateIter implements Iterator &#123;</span><br><span class="line">    +Object next()</span><br><span class="line">    +boolean hasNext()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Client</span><br><span class="line"></span><br><span class="line">Aggregate -&gt; Client</span><br><span class="line">Client -&gt; Iterator</span><br><span class="line">ConcreateAgg -&gt; ConcreateIter</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<img  src=http://www.plantuml.com/plantuml/svg/fOzB3i8m34JN-1HUWYgkW42ike4pk95f0_bKZYk147SdKLKex13PH7cU6K-sIKbqy0xInOQUX3mw6rXlFMCKxI907PJbH8PnrxR2BIdZ7HPLdJ5f53J2cKtFvGeUSzDBLZp7vin6CV1LimxpgPeO7LF0Zj9XnDbk7AM4-nZ6xBmOhUyTUmwQVkdn5LI6ywH_oZcR8m3UPTQR2OvN0TC2-FXBKSuhFG40>

<p>ASCII 版本图示:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+------------------+                              +--------------------+                                                                             </span><br><span class="line">|  &lt;&lt;interface&gt;&gt;   |         +-----------+        |   &lt;&lt;interface&gt;&gt;    |                                                                             </span><br><span class="line">|    Aggregate     |&lt;--------|  Client   |------&gt; |      Iterator      |                                                                             </span><br><span class="line">|------------------|         |           |        |--------------------|                                                                             </span><br><span class="line">| createIterator() |         +-----------+        | hasNext()          |                                                                             </span><br><span class="line">|                  |                              | next()             |                                                                             </span><br><span class="line">+------------------+                              | remove()           |                                                                             </span><br><span class="line">        ^                                         +--------------------+                                                                             </span><br><span class="line">        |                                                     ^                                                                                      </span><br><span class="line">        |                                                     |                                                                                      </span><br><span class="line">        |                                                     |                                                                                      </span><br><span class="line">        |                                                     |                                                                                      </span><br><span class="line">+--------------------+                            +--------------------+                                                                             </span><br><span class="line">| ConcreateAggregate |---------------------------&gt;| ConcreateIterator  |                                                                             </span><br><span class="line">|--------------------|                            |--------------------|                                                                             </span><br><span class="line">| createIterator()   |                            | hasNext()          |                                                                             </span><br><span class="line">|                    |                            | next()             |                                                                             </span><br><span class="line">+--------------------+                            | remove()           |                                                                             </span><br><span class="line">                                                  +--------------------+                                                                             </span><br></pre></td></tr></table></figure>

<h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2><p>现在你是餐饮部的大老板了，上周你刚收购了两家餐厅，现在你要整合他们的业务，将他们的菜单合并以统一的用户体验，所幸，他们的底层菜品条目是一致的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MenuItem</span> </span>&#123;</span><br><span class="line">    String name;</span><br><span class="line">    String description;</span><br><span class="line">    <span class="keyword">boolean</span> vegetarian;</span><br><span class="line">    <span class="keyword">double</span> price;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MenuItem</span><span class="params">(String name, String description, <span class="keyword">boolean</span> vegetarian, <span class="keyword">double</span> price)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.description = description;</span><br><span class="line">        <span class="keyword">this</span>.vegetarian = vegetarian;</span><br><span class="line">        <span class="keyword">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter and setter</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name + <span class="string">&quot;, desc:&#x27;&quot;</span> + description + <span class="string">&#x27;\&#x27;&#x27;</span> +  <span class="string">&quot;, vegetarian:&quot;</span> + vegetarian + <span class="string">&quot;, price:&quot;</span> + price;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两家店铺的菜单实现代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 煎饼电，通过 List 来存储菜单</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PancakeHouseMenu</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;MenuItem&gt; menuItems;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PancakeHouseMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        menuItems = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        addItem(<span class="string">&quot;K &amp; B’s Pancake Breakfast&quot;</span>, <span class="string">&quot;Pancakes with scrambled eggs, and toast&quot;</span>, <span class="keyword">true</span>, <span class="number">2.99</span>);</span><br><span class="line">        addItem(<span class="string">&quot;Regular Pancake Breakfast&quot;</span>, <span class="string">&quot;Pancakes with fried eggs, sausage&quot;</span>, <span class="keyword">false</span>, <span class="number">2.99</span>);</span><br><span class="line">        addItem(<span class="string">&quot;Blueberry Pancakes&quot;</span>, <span class="string">&quot;Pancakes made with fresh blueberries&quot;</span>, <span class="keyword">true</span>, <span class="number">3.49</span>);</span><br><span class="line">        addItem(<span class="string">&quot;Waffles&quot;</span>, <span class="string">&quot;Waffles, with your choice of blueberries or strawberries&quot;</span>, <span class="keyword">true</span>, <span class="number">3.59</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addItem</span><span class="params">(String name, String description, <span class="keyword">boolean</span> vegetarian, <span class="keyword">double</span> price)</span> </span>&#123;</span><br><span class="line">        MenuItem menuItem = <span class="keyword">new</span> MenuItem(name, description, vegetarian, price);</span><br><span class="line">        menuItems.add(menuItem);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ArrayList&lt;MenuItem&gt; <span class="title">getMenuItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> menuItems;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 小吃店，通过 Array 存储菜单</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DinerMenu</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> MAX_ITEMS = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">int</span> numberOfItems = <span class="number">0</span>;</span><br><span class="line">    MenuItem[] menuItems;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DinerMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        menuItems = <span class="keyword">new</span> MenuItem[MAX_ITEMS];</span><br><span class="line">        addItem(<span class="string">&quot;Vegetarian BLT&quot;</span>, <span class="string">&quot; (Fakin’)Bacon with lettuce &amp; tomato on whole wheat&quot;</span>, <span class="keyword">true</span>, <span class="number">2.99</span>);</span><br><span class="line">        addItem(<span class="string">&quot;BLT&quot;</span>, <span class="string">&quot;Bacon with lettuce &amp; tomato on whole wheat&quot;</span>, <span class="keyword">false</span>, <span class="number">2.99</span>);</span><br><span class="line">        addItem(<span class="string">&quot;Soup of the day&quot;</span>, <span class="string">&quot;Soup of the day, with a side of potato salad&quot;</span>, <span class="keyword">false</span>, <span class="number">3.29</span>);</span><br><span class="line">        addItem(<span class="string">&quot;Hotdog&quot;</span>, <span class="string">&quot;A hot dog, with saurkraut, relish, onions, topped with cheese&quot;</span>, <span class="keyword">false</span>, <span class="number">3.05</span>);</span><br><span class="line">        addItem(<span class="string">&quot;Steamed Veggies and Brown Rice&quot;</span>, <span class="string">&quot;Steamed vegetables over brown rice&quot;</span>, <span class="keyword">false</span>, <span class="number">3.99</span>);</span><br><span class="line">        addItem(<span class="string">&quot;Pasta&quot;</span>, <span class="string">&quot;Spaghetti with Marinara Sauce, and a slice of sourdough bread&quot;</span>, <span class="keyword">false</span>, <span class="number">3.89</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addItem</span><span class="params">(String name, String description, <span class="keyword">boolean</span> vegetarian, <span class="keyword">double</span> price)</span> </span>&#123;</span><br><span class="line">        MenuItem menuItem = <span class="keyword">new</span> MenuItem(name, description, vegetarian, price);</span><br><span class="line">        <span class="keyword">if</span> (numberOfItems &gt;= MAX_ITEMS) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Sorry, menu is full !Can’t add item to menu&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            menuItems[numberOfItems] = menuItem;</span><br><span class="line">            numberOfItems = numberOfItems + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MenuItem[] getMenuItems() &#123;</span><br><span class="line">        <span class="keyword">return</span> menuItems;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在没有做重构的情况下，每当你想要打印所有的菜单，你就得用两个循环，分别 loop 一下这两家店的菜单, 并且更糟糕的是，下次你再收购店面，你就必须再改一次这部分代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoopMenu</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MenuItem[] dinerMenu = <span class="keyword">new</span> DinerMenu().getMenuItems();</span><br><span class="line">        <span class="keyword">for</span> (MenuItem menu : dinerMenu) &#123;</span><br><span class="line">            System.out.println(menu);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;MenuItem&gt; menuItemList = <span class="keyword">new</span> PancakeHouseMenu().getMenuItems();</span><br><span class="line">        <span class="keyword">for</span> (MenuItem menuItem : menuItemList) &#123;</span><br><span class="line">            System.out.println(menuItem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了解决这个问题，我们新建一个 Iterator 接口来解决这个问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Object <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为小吃店新建一个 Iterator 实现并在小吃点的菜单中添加返回 Iterator 的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DinerMenuIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    MenuItem[] items;</span><br><span class="line">    <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DinerMenuIterator</span><span class="params">(MenuItem[] items)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.items = items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// position 这里不用做 +1 处理，拿长度为 1 的 arr 做例子。初始化后，调用 hasNext()，0 &lt; 1 &amp;&amp; obj != null 返回 true</span></span><br><span class="line">        <span class="keyword">return</span> position &lt; items.length &amp;&amp; items[position] != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MenuItem item = items[position];</span><br><span class="line">        position++;</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DinerMenu</span> </span>&#123;</span><br><span class="line">    <span class="comment">// duplicated before</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">createIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DinerMenuIterator(menuItems);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对煎饼摊做同样的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PancakeHouseMenuIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    List&lt;MenuItem&gt; menuItemList;</span><br><span class="line">    <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PancakeHouseMenuIterator</span><span class="params">(List&lt;MenuItem&gt; menuItemList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.menuItemList = menuItemList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position &lt; menuItemList.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MenuItem item = menuItemList.get(position);</span><br><span class="line">        position++;</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PancakeHouseMenu</span> </span>&#123;</span><br><span class="line">    <span class="comment">// duplicated before</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">createIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PancakeHouseMenuIterator(menuItems);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IteratorClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Iterator it1 = <span class="keyword">new</span> PancakeHouseMenu().createIterator();</span><br><span class="line">        Iterator it2 = <span class="keyword">new</span> DinerMenu().createIterator();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;MENU\n----\nBREAKFAST&quot;</span>);</span><br><span class="line">        printMenu(it1);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;\nLUNCH&quot;</span>);</span><br><span class="line">        printMenu(it2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printMenu</span><span class="params">(Iterator it)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            System.out.println(it.next());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MENU</span></span><br><span class="line"><span class="comment">// ----</span></span><br><span class="line"><span class="comment">// BREAKFAST</span></span><br><span class="line"><span class="comment">// K &amp; B’s Pancake Breakfast, 2.99 -- Pancakes with scrambled eggs, and toast</span></span><br><span class="line"><span class="comment">// Regular Pancake Breakfast, 2.99 -- Pancakes with fried eggs, sausage</span></span><br><span class="line"><span class="comment">// Blueberry Pancakes, 3.49 -- Pancakes made with fresh blueberries</span></span><br><span class="line"><span class="comment">// Waffles, 3.59 -- Waffles, with your choice of blueberries or strawberries</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LUNCH</span></span><br><span class="line"><span class="comment">// Vegetarian BLT, 2.99 --  (Fakin’)Bacon with lettuce &amp; tomato on whole wheat</span></span><br><span class="line"><span class="comment">// BLT, 2.99 -- Bacon with lettuce &amp; tomato on whole wheat</span></span><br><span class="line"><span class="comment">// Soup of the day, 3.29 -- Soup of the day, with a side of potato salad</span></span><br><span class="line"><span class="comment">// Hotdog, 3.05 -- A hot dog, with saurkraut, relish, onions, topped with cheese</span></span><br><span class="line"><span class="comment">// Steamed Veggies and Brown Rice, 3.99 -- Steamed vegetables over brown rice</span></span><br><span class="line"><span class="comment">// Pasta, 3.89 -- Spaghetti with Marinara Sauce, and a slice of sourdough bread</span></span><br></pre></td></tr></table></figure>

<p>其实 Java util 包下有自己的 Iterator 实现，集合类是这个设计模式的重度使用者，下面我们用官方实现替换我们自己的实现。</p>
<p>代码会更简单，除了在各 class 文件中引入的引用外，PancakeHouseMenuIterator 可以删除， 在 PancakeHouseMenu 的 createIterator() 直接返回 List.iterator() 即可。</p>
<p>为了让实现更精简，我们还可以抽象出一个 Menu 类作为基类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Menu</span> </span>&#123;</span><br><span class="line">    <span class="function">Iterator&lt;MenuItem&gt; <span class="title">createIterator</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后两个 Menu 实体类实现这个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DinerMenu</span> <span class="keyword">implements</span> <span class="title">Menu</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PancakeHouseMenu</span> <span class="keyword">implements</span> <span class="title">Menu</span></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端中通过 Menu 基类访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IteratorClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Menu menu1 = <span class="keyword">new</span> PancakeHouseMenu();</span><br><span class="line">        Menu menu2 = <span class="keyword">new</span> DinerMenu();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;MENU\n----\nBREAKFAST&quot;</span>);</span><br><span class="line">        printMenu(menu1);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;\nLUNCH&quot;</span>);</span><br><span class="line">        printMenu(menu2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">        Iterator&lt;MenuItem&gt; it = menu.createIterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            System.out.println(it.next());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样最大的好处是，客户端只和接口做交互，不需要关心具体实现，这就是传说中的 面向接口编程</p>
<p>时隔半个月，你又收购了一家咖啡店，是时候测试一下你的策略是否好使了。咖啡店菜单如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CafeMenu</span> </span>&#123;</span><br><span class="line">    Hashtable menuItems = <span class="keyword">new</span> Hashtable();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CafeMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        addItem(<span class="string">&quot;Veggie Burger and Air Fries&quot;</span>, <span class="string">&quot;Veggie burger on a whole wheat bun, lettuce, tomato, and fries&quot;</span>, <span class="keyword">true</span>, <span class="number">3.99</span>);</span><br><span class="line">        addItem(<span class="string">&quot;Soup of the day&quot;</span>, <span class="string">&quot;A cup of the soup of the day, with a side salad&quot;</span>, <span class="keyword">false</span>, <span class="number">3.69</span>);</span><br><span class="line">        addItem(<span class="string">&quot;Burrito&quot;</span>, <span class="string">&quot;A large burrito, with whole pinto beans, salsa, guacamole&quot;</span>, <span class="keyword">true</span>, <span class="number">4.29</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addItem</span><span class="params">(String name, String description, <span class="keyword">boolean</span> vegetarian, <span class="keyword">double</span> price)</span> </span>&#123;</span><br><span class="line">        MenuItem menuItem = <span class="keyword">new</span> MenuItem(name, description, vegetarian, price);</span><br><span class="line">        menuItems.put(menuItem.getName(), menuItem);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Hashtable <span class="title">getItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> menuItems;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们按照之前的重构方案，让他实现 Menu 接口并提对应的方法实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CafeMenu</span> <span class="keyword">implements</span> <span class="title">Menu</span></span>&#123;</span><br><span class="line">    Hashtable&lt;String, MenuItem&gt; menuItems = <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CafeMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        addItem(<span class="string">&quot;Veggie Burger and Air Fries&quot;</span>, <span class="string">&quot;Veggie burger on a whole wheat bun, lettuce, tomato, and fries&quot;</span>, <span class="keyword">true</span>, <span class="number">3.99</span>);</span><br><span class="line">        addItem(<span class="string">&quot;Soup of the day&quot;</span>, <span class="string">&quot;A cup of the soup of the day, with a side salad&quot;</span>, <span class="keyword">false</span>, <span class="number">3.69</span>);</span><br><span class="line">        addItem(<span class="string">&quot;Burrito&quot;</span>, <span class="string">&quot;A large burrito, with whole pinto beans, salsa, guacamole&quot;</span>, <span class="keyword">true</span>, <span class="number">4.29</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addItem</span><span class="params">(String name, String description, <span class="keyword">boolean</span> vegetarian, <span class="keyword">double</span> price)</span> </span>&#123;</span><br><span class="line">        MenuItem menuItem = <span class="keyword">new</span> MenuItem(name, description, vegetarian, price);</span><br><span class="line">        menuItems.put(menuItem.getName(), menuItem);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Hashtable&lt;String, MenuItem&gt; <span class="title">getItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> menuItems;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator&lt;MenuItem&gt; <span class="title">createIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> menuItems.values().iterator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 IteratorClient 中添加对应的调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IteratorClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Menu menu1 = <span class="keyword">new</span> PancakeHouseMenu();</span><br><span class="line">        Menu menu2 = <span class="keyword">new</span> DinerMenu();</span><br><span class="line">        Menu menu3 = <span class="keyword">new</span> CafeMenu();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;MENU\n----\nBREAKFAST&quot;</span>);</span><br><span class="line">        printMenu(menu1);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;\nLUNCH&quot;</span>);</span><br><span class="line">        printMenu(menu2);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;\n DRINK&quot;</span>);</span><br><span class="line">        printMenu(menu3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">        Iterator&lt;MenuItem&gt; it = menu.createIterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            System.out.println(it.next());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MENU</span></span><br><span class="line"><span class="comment">// ----</span></span><br><span class="line"><span class="comment">// BREAKFAST</span></span><br><span class="line"><span class="comment">// K &amp; B’s Pancake Breakfast, 2.99 -- Pancakes with scrambled eggs, and toast</span></span><br><span class="line"><span class="comment">// Regular Pancake Breakfast, 2.99 -- Pancakes with fried eggs, sausage</span></span><br><span class="line"><span class="comment">// Blueberry Pancakes, 3.49 -- Pancakes made with fresh blueberries</span></span><br><span class="line"><span class="comment">// Waffles, 3.59 -- Waffles, with your choice of blueberries or strawberries</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LUNCH</span></span><br><span class="line"><span class="comment">// Vegetarian BLT, 2.99 --  (Fakin’)Bacon with lettuce &amp; tomato on whole wheat</span></span><br><span class="line"><span class="comment">// BLT, 2.99 -- Bacon with lettuce &amp; tomato on whole wheat</span></span><br><span class="line"><span class="comment">// Soup of the day, 3.29 -- Soup of the day, with a side of potato salad</span></span><br><span class="line"><span class="comment">// Hotdog, 3.05 -- A hot dog, with saurkraut, relish, onions, topped with cheese</span></span><br><span class="line"><span class="comment">// Steamed Veggies and Brown Rice, 3.99 -- Steamed vegetables over brown rice</span></span><br><span class="line"><span class="comment">// Pasta, 3.89 -- Spaghetti with Marinara Sauce, and a slice of sourdough bread</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  DRINK</span></span><br><span class="line"><span class="comment">// Soup of the day, 3.69 -- A cup of the soup of the day, with a side salad</span></span><br><span class="line"><span class="comment">// Burrito, 4.29 -- A large burrito, with whole pinto beans, salsa, guacamole</span></span><br></pre></td></tr></table></figure>

<p>一切和预期的一样 ╮(￣▽￣””)╭</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jack-zheng.github.io/hexo/hexo/2021/04/15/Docker-quick-start/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/jack.jpg">
      <meta itemprop="name" content="Jack Zheng">
      <meta itemprop="description" content="我是张江搬砖小码农, 知识搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jackpot">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/hexo/2021/04/15/Docker-quick-start/" class="post-title-link" itemprop="url">Docker 弹射起步</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-15 19:59:17" itemprop="dateCreated datePublished" datetime="2021-04-15T19:59:17+08:00">2021-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-16 13:29:44" itemprop="dateModified" datetime="2022-02-16T13:29:44+08:00">2022-02-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo/categories/%E5%BC%B9%E5%B0%84%E8%B5%B7%E6%AD%A5/" itemprop="url" rel="index">
                    <span itemprop="name">弹射起步</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>63k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>57 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><a href="#学后总结">学后总结</a></li>
<li><a href="#虚拟机-vs-容器">虚拟机 Vs 容器</a></li>
<li><a href="#常用命令">常用命令</a></li>
<li><a href="#nginx-镜像操作实践">Nginx 镜像操作实践</a></li>
<li><a href="#tomcat-镜像操作实践">Tomcat 镜像操作实践</a></li>
<li><a href="#部署-es--kibana-操作实践">部署 ES + kibana 操作实践</a></li>
<li><a href="#可视化">可视化</a></li>
<li><a href="#docker-镜像加载原理">Docker 镜像加载原理</a></li>
<li><a href="#制作镜像">制作镜像</a></li>
<li><a href="#数据卷">数据卷</a></li>
<li><a href="#安装-mysql-操作实践">安装 MySQL 操作实践</a></li>
<li><a href="#具名挂载-vs-匿名挂载">具名挂载 Vs 匿名挂载</a></li>
<li><a href="#数据共享">数据共享</a></li>
<li><a href="#初识-dockerfile">初识 Dockerfile</a></li>
<li><a href="#dockerfile">Dockerfile</a></li>
<li><a href="#cmd-vs-entrypoint">CMD Vs ENTRYPOINT</a></li>
<li><a href="#实战-制作-tomcat-镜像">实战： 制作 Tomcat 镜像</a></li>
<li><a href="#docker0-网络详解">docker0 网络详解</a></li>
<li><a href="#--link">–link</a></li>
<li><a href="#自定义网络">自定义网络</a></li>
<li><a href="#网络联通">网络联通</a></li>
<li><a href="#实战部署-redis-集群">实战：部署 Redis 集群</a></li>
<li><a href="#springboot-微服务打包-docker-镜像">SpringBoot 微服务打包 Docker 镜像</a></li>
<li><a href="#docker-compose">Docker Compose</a></li>
<li><a href="#安装">安装</a></li>
<li><a href="#官方起步教程">官方起步教程</a></li>
<li><a href="#yaml-规则">YAML 规则</a></li>
<li><a href="#实战">实战</a></li>
<li><a href="#docker-swarm">Docker Swarm</a></li>
<li><a href="#raft-协议">Raft 协议</a></li>
<li><a href="#搭建集群">搭建集群</a></li>
<li><a href="#概念总结">概念总结</a></li>
<li><a href="#以后还要学-go">以后还要学 Go</a></li>
<li><a href="#问题">问题</a></li>
</ul>
<h2 id="学后总结"><a href="#学后总结" class="headerlink" title="学后总结"></a>学后总结</h2><ul>
<li>基本了解了 docker 相关的整个生态的基本情况</li>
<li>熟悉了 docker 的基本用法</li>
<li>有机会要学一下 Go 语言</li>
</ul>
<h2 id="虚拟机-Vs-容器"><a href="#虚拟机-Vs-容器" class="headerlink" title="虚拟机 Vs 容器"></a>虚拟机 Vs 容器</h2><ul>
<li>虚拟机运行整个系统，在系统上安装运行软件</li>
<li>容器内的应用直接运行在宿主机内，容器没有自己的内核，也没有虚拟硬件</li>
</ul>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker client 信息显示</span></span><br><span class="line">docker version  <span class="comment"># docker engin, api 等的版本信息</span></span><br><span class="line">docker info     <span class="comment"># docker 环境信息，包括 image, container 数量，内核版本等</span></span><br><span class="line">docker --<span class="built_in">help</span>   <span class="comment"># 帮助</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像相关命令</span></span><br><span class="line">docker pull [OPTIONS] NAME[:TAG|@DIGEST]    <span class="comment"># 拉镜像</span></span><br><span class="line"><span class="comment"># Host&gt; docker pull mysql                   # 没有指定 tag 就默认下载 latest 版本</span></span><br><span class="line"><span class="comment"># Using default tag: latest</span></span><br><span class="line"><span class="comment"># latest: Pulling from library/mysql</span></span><br><span class="line"><span class="comment"># f7ec5a41d630: Already exists </span></span><br><span class="line"><span class="comment"># 9444bb562699: Pull complete               # 分层下载， docker image 的核心，联合文件系统</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># e47da95a5aab: Pull complete </span></span><br><span class="line"><span class="comment"># Digest: sha256:04ee7141256e83797ea4a84a4d31b1f1bc10111c8d1bc1879d52729ccd19e20a # 签名</span></span><br><span class="line"><span class="comment"># Status: Downloaded newer image for mysql:latest</span></span><br><span class="line"><span class="comment"># docker.io/library/mysql:latest            # 真实地址，等价于 docker pull docker.io/library/mysql:latest</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用参数</span></span><br><span class="line"><span class="comment"># -f: 强制删除</span></span><br><span class="line">docker rmi [OPTIONS] IMAGE [IMAGE...]               <span class="comment"># 删除镜像</span></span><br><span class="line">docker rmi -f $(docker images -aq)                  <span class="comment"># 组合命令，删除全部镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器相关</span></span><br><span class="line"><span class="comment"># 常用参数</span></span><br><span class="line"><span class="comment"># --name=&quot;my_name&quot;          # 指定容器名字</span></span><br><span class="line"><span class="comment"># -d                        # 后台运行</span></span><br><span class="line"><span class="comment"># -it                       # 交互方式运行，进去容器查看, 示例: docker run -it centos /bin/bash</span></span><br><span class="line"><span class="comment"># -p                        # 指定端口</span></span><br><span class="line"><span class="comment">#   -p ip:主机端口:容器端口</span></span><br><span class="line"><span class="comment">#   -p 主机端口:容器端口</span></span><br><span class="line"><span class="comment">#   -p 容器端口</span></span><br><span class="line"><span class="comment"># -P                        # 随机指定端口</span></span><br><span class="line"><span class="comment"># 常见坑：docker 容器使用后台运行，必须要给一个前台进程，如果 docker 发现没有应用就会自动停止</span></span><br><span class="line"><span class="comment"># 比如启动 nginx 容器，如果没有 -it 参数，容器就会立刻停止，ps 之后不会显示这个容器，加 -a 可以</span></span><br><span class="line">docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成临时 log</span></span><br><span class="line">docker run -d centos /bin/sh -c <span class="string">&quot;while true;do echo testlog;sleep 1;done&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -t                # 时间戳</span></span><br><span class="line"><span class="comment"># -f                # 持续打印</span></span><br><span class="line"><span class="comment"># --tail num        # 输出n条</span></span><br><span class="line"><span class="comment"># sample: docker logs -tf --tail 10 627b379be47a</span></span><br><span class="line">docker logs [OPTIONS] CONTAINER         <span class="comment"># 输出 console log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -a                # 所有容器, 包括已经停止的</span></span><br><span class="line"><span class="comment"># -aq               # 只显示容器 id</span></span><br><span class="line"><span class="comment"># -n=2 or -n 2      # 最近创建的2个容器</span></span><br><span class="line">docker ps [OPTIONS] <span class="comment"># 显示容器信息</span></span><br><span class="line"></span><br><span class="line">ctrl + p + q        <span class="comment"># 交互模式下推出容器并后台运行。mac 也是这个命令，不过 vscode 里不好使，应该是快捷键冲突</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -f                                                    # 强制移除</span></span><br><span class="line"><span class="comment"># sample: docker rm -f $(docker ps -qa)                 # 删除所有</span></span><br><span class="line"><span class="comment"># sample: docker ps -aq | xargs docker rm               # 通过 Linux pip 方式删除所有</span></span><br><span class="line">docker rm [OPTIONS] CONTAINER [CONTAINER...]            <span class="comment"># 删除容器，不能删除正在运行的容器，除非加 -f</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除由某个 image 生成的所有 containers</span></span><br><span class="line"><span class="comment"># 这里有个小技巧，先通过 docker ps 打印一下，避免误删：docker ps -a --filter ancestor=nginx</span></span><br><span class="line">docker rm -f $(docker ps -aq --filter ancestor=nginx)</span><br><span class="line"></span><br><span class="line">docker start [OPTIONS] CONTAINER [CONTAINER...]         <span class="comment"># 启动停止的容器</span></span><br><span class="line">docker restart [OPTIONS] CONTAINER [CONTAINER...]       <span class="comment"># 重启容器</span></span><br><span class="line">docker stop [OPTIONS] CONTAINER [CONTAINER...]          <span class="comment"># 停止容器</span></span><br><span class="line">docker docker <span class="built_in">kill</span> [OPTIONS] CONTAINER [CONTAINER...]   <span class="comment"># stop 报错了可以用这个强制杀进程</span></span><br><span class="line"></span><br><span class="line">docker top CONTAINER [ps OPTIONS]                       <span class="comment"># 显示容器中的进程, 如下显示志之前 log 例子的 top 信息</span></span><br><span class="line"><span class="comment"># docker top 627b379be47a</span></span><br><span class="line"><span class="comment"># UID          PID          PPID         C            STIME               TTY          TIME         CMD</span></span><br><span class="line"><span class="comment"># root         12866         12840       0            10:29               ?            00:00:00     /bin/bash -c while true; do echo testlog; sleep 1; done</span></span><br><span class="line"></span><br><span class="line">docker inspect [OPTIONS] NAME|ID [NAME|ID...]           <span class="comment"># 显示容器底层信息, 包括 id, image, 共享卷，网络等信息</span></span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Id&quot;: &quot;247d2a88573fdb2893a90a3d35275bfaa2889f7fa450d875456646ed684643d4&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Created&quot;: &quot;2021-04-20T13:06:45.2632089Z&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Path&quot;: &quot;/bin/sh&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Args&quot;: [</span></span><br><span class="line"><span class="comment">#             &quot;-c&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;while true;do echo testlog;sleep 1;done&quot;</span></span><br><span class="line"><span class="comment">#         ],</span></span><br><span class="line"><span class="comment">#         &quot;State&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;Status&quot;: &quot;running&quot;,</span></span><br><span class="line"><span class="comment">#             ...</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Image&quot;: &quot;sha256:300e315adb2f96afe5f0b2780b87f28ae95231fe3bdd1e16b9ba606307728f55&quot;,</span></span><br><span class="line"><span class="comment">#         ...</span></span><br><span class="line"><span class="comment">#         &quot;GraphDriver&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;Data&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/80783254f01fcdde559ac63ff7503d2dc317929d0328fb1c66846f9e519d98df/work&quot;</span></span><br><span class="line"><span class="comment">#                 ...</span></span><br><span class="line"><span class="comment">#             &#125;,</span></span><br><span class="line"><span class="comment">#             &quot;Name&quot;: &quot;overlay2&quot;</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Mounts&quot;: [],</span></span><br><span class="line"><span class="comment">#         &quot;Config&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             ...</span></span><br><span class="line"><span class="comment">#             &quot;Cmd&quot;: [</span></span><br><span class="line"><span class="comment">#                 &quot;/bin/sh&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;-c&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;while true;do echo testlog;sleep 1;done&quot;</span></span><br><span class="line"><span class="comment">#             ],</span></span><br><span class="line"><span class="comment">#             &quot;Image&quot;: &quot;centos&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;Volumes&quot;: null,</span></span><br><span class="line"><span class="comment">#             &quot;WorkingDir&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;Entrypoint&quot;: null,</span></span><br><span class="line"><span class="comment">#             &quot;OnBuild&quot;: null,</span></span><br><span class="line"><span class="comment">#             &quot;Labels&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;org.label-schema.build-date&quot;: &quot;20201204&quot;,</span></span><br><span class="line"><span class="comment">#                 ...</span></span><br><span class="line"><span class="comment">#             &#125;</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;NetworkSettings&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;Bridge&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#             ...</span></span><br><span class="line"><span class="comment">#             &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;Networks&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;bridge&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                     &quot;IPAMConfig&quot;: null,</span></span><br><span class="line"><span class="comment">#                     &quot;Links&quot;: null,</span></span><br><span class="line"><span class="comment">#                     &quot;Aliases&quot;: null,</span></span><br><span class="line"><span class="comment">#                     &quot;NetworkID&quot;: &quot;2fbb6bb1ed5e760a8350664377ea726ffbf35fab4794d45926ab9f9f9bd28d8a&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;EndpointID&quot;: &quot;aa43be83ff078d4c2dbdff62a2e69217ef2e17c0585edfecdcda030dca3aef0f&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;IPPrefixLen&quot;: 16,</span></span><br><span class="line"><span class="comment">#                     &quot;IPv6Gateway&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;GlobalIPv6PrefixLen&quot;: 0,</span></span><br><span class="line"><span class="comment">#                     &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;DriverOpts&quot;: null</span></span><br><span class="line"><span class="comment">#                 &#125;</span></span><br><span class="line"><span class="comment">#             &#125;</span></span><br><span class="line"><span class="comment">#         &#125;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sample: docker exec -it 627b379be47a /bin/bash </span></span><br><span class="line">docker <span class="built_in">exec</span> [OPTIONS] CONTAINER COMMAND [ARG...]        <span class="comment"># 进入容器，开启一个新的终端</span></span><br><span class="line">       </span><br><span class="line">docker attach [OPTIONS] CONTAINER                       <span class="comment"># 进去容器，为当前正在执行的终端</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker cp ./myyyyyy.tar  9b41928f2fb3:/</span></span><br><span class="line">docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|-      <span class="comment"># 容器和宿主机之间文件**互相**拷贝, - 这个符号可以操作 tar，查了一下没使用案例，测试失败</span></span><br><span class="line">docker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-镜像操作实践"><a href="#Nginx-镜像操作实践" class="headerlink" title="Nginx 镜像操作实践"></a>Nginx 镜像操作实践</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">docker search nginx         <span class="comment"># 从官方 repo 搜索镜像</span></span><br><span class="line"><span class="comment"># NAME                               DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span></span><br><span class="line"><span class="comment"># nginx                              Official build of Nginx.                        14752     [OK]</span></span><br><span class="line"><span class="comment"># jwilder/nginx-proxy                Automated Nginx reverse proxy for docker con…   2018                 [OK]</span></span><br><span class="line"></span><br><span class="line">docker pull nginx                               <span class="comment"># 下载镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -d                        # 后台运行</span></span><br><span class="line"><span class="comment"># --name:my-nginx           # 自定义容器名称</span></span><br><span class="line"><span class="comment"># -p                        # 指定端口号</span></span><br><span class="line">docker run -d --name nginx01 -p 3344:80 nginx   <span class="comment"># 启动容器</span></span><br><span class="line"></span><br><span class="line">curl localhost:3344                             <span class="comment"># 访问暴露的地址测试是否成功启动, 返回页面如下</span></span><br><span class="line"><span class="comment"># &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="comment"># &lt;html&gt;</span></span><br><span class="line"><span class="comment"># &lt;head&gt;</span></span><br><span class="line"><span class="comment"># &lt;title&gt;Welcome to nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># &lt;body&gt;</span></span><br><span class="line"><span class="comment"># &lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"># &lt;p&gt;If you see this page, the nginx web server is successfully installed and</span></span><br><span class="line"><span class="comment"># working. Further configuration is required.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># &lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="comment"># &lt;/body&gt;</span></span><br><span class="line"><span class="comment"># &lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it nginx01 /bin/bash               <span class="comment"># 进入容器</span></span><br><span class="line">whereis nginx                                   <span class="comment"># linux 基础命令，查看配置</span></span><br></pre></td></tr></table></figure>

<h2 id="Tomcat-镜像操作实践"><a href="#Tomcat-镜像操作实践" class="headerlink" title="Tomcat 镜像操作实践"></a>Tomcat 镜像操作实践</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --rm      # 一般用于测试，用完即删除</span></span><br><span class="line">docker run -it --rm tomcat:9.0                      <span class="comment"># tomcat docker 镜像官方命令，可以达到测试完毕，推出即删除的效果</span></span><br><span class="line"></span><br><span class="line">docker run -d -p 3355:8080 --name tomcat01 tomcat   <span class="comment"># 容器命名为 tomcat01 跑在 3355 端口</span></span><br><span class="line">curl localhost:3355                                 <span class="comment"># 访问测试, 访问失败</span></span><br><span class="line"><span class="comment"># &lt;!doctype html&gt;...&lt;/b&gt; The origin server did not find a current representation for the target resource or is not willing to disclose that one exists...&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat01 /bin/bash                  <span class="comment"># 进入容器查看原因</span></span><br><span class="line"></span><br><span class="line">cp -r webapps.dist/* webapps                        <span class="comment"># 官方镜像 webapps 文件夹为空，样板页面放到了 webapps.dist 下了。拷贝一下，问题解决</span></span><br></pre></td></tr></table></figure>

<h2 id="部署-ES-kibana-操作实践"><a href="#部署-ES-kibana-操作实践" class="headerlink" title="部署 ES + kibana 操作实践"></a>部署 ES + kibana 操作实践</h2><p>ES 的问题：</p>
<ul>
<li>ES 暴露的接口多</li>
<li>ES 十分耗内存</li>
<li>ES 数据需要备份</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sample of official:</span></span><br><span class="line"><span class="comment">#   docker network create somenetwork</span></span><br><span class="line"><span class="comment">#   docker run -d --name elasticsearch --net somenetwork -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:tag</span></span><br><span class="line">docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e <span class="string">&quot;discovery.type=single-node&quot;</span> elasticsearch:7.6.2</span><br><span class="line"></span><br><span class="line">docker stats            <span class="comment"># 实时显示容器的资源使用情况</span></span><br><span class="line"><span class="comment"># CONTAINER ID   NAME            CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O       PIDS</span></span><br><span class="line"><span class="comment"># 5e20f16bed99   elasticsearch   1.01%     1.332GiB / 15.64GiB   8.52%     836B / 0B   106MB / 729kB   46</span></span><br><span class="line"></span><br><span class="line">curl localhost:9200     <span class="comment"># 发送请求测试</span></span><br><span class="line"><span class="comment"># &#123;</span></span><br><span class="line"><span class="comment">#   &quot;name&quot; : &quot;4d87cd0d4ff6&quot;,</span></span><br><span class="line"><span class="comment">#   &quot;cluster_name&quot; : &quot;docker-cluster&quot;,</span></span><br><span class="line"><span class="comment">#   &quot;cluster_uuid&quot; : &quot;ojWX85pITJyL7WkVnoKZcA&quot;,</span></span><br><span class="line"><span class="comment">#   &quot;version&quot; : &#123;</span></span><br><span class="line"><span class="comment">#     &quot;number&quot; : &quot;7.6.2&quot;,</span></span><br><span class="line"><span class="comment">#    ...</span></span><br><span class="line"><span class="comment">#   &#125;,</span></span><br><span class="line"><span class="comment">#   &quot;tagline&quot; : &quot;You Know, for Search&quot;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -e        # 启动时添加环境配置，sample: ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; 修改内存配置, 再次查看 stats 可以看到内存使用量变化</span></span><br><span class="line">docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e <span class="string">&quot;discovery.type=single-node&quot;</span> -e ES_JAVA_OPTS=<span class="string">&quot;-Xms64m -Xmx512m&quot;</span> elasticsearch:7.6.2</span><br><span class="line"><span class="comment"># CONTAINER ID   NAME            CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O    PIDS</span></span><br><span class="line"><span class="comment"># 7a804bd391d6   elasticsearch   229.04%   318.1MiB / 15.64GiB   1.99%     766B / 0B   0B / 246kB   27</span></span><br></pre></td></tr></table></figure>

<h2 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h2><ul>
<li>Portainer - 图形化管理工具</li>
<li>Rancher - CI/CD</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 访问 localhost:9000 可见页面</span></span><br><span class="line">docker run -d -p 8000:8000 -p 9000:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce</span><br></pre></td></tr></table></figure>

<h2 id="Docker-镜像加载原理"><a href="#Docker-镜像加载原理" class="headerlink" title="Docker 镜像加载原理"></a>Docker 镜像加载原理</h2><p>UnionFS 联合文件系统，分层，轻量级且高性能。有机会再做扩展。</p>
<h2 id="制作镜像"><a href="#制作镜像" class="headerlink" title="制作镜像"></a>制作镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -a                # 作者</span></span><br><span class="line"><span class="comment"># -m                # commit 信息</span></span><br><span class="line"><span class="comment"># 630bab3ed5c2      # 修改过的 container id</span></span><br><span class="line"><span class="comment"># tomcat02:1.0      # 新镜像名称:版本号</span></span><br><span class="line">docker commit -a=<span class="string">&#x27;jzheng&#x27;</span> -m=<span class="string">&#x27;add webapps&#x27;</span> 630bab3ed5c2 tomcat02:1.0</span><br><span class="line">docker images</span><br><span class="line"><span class="comment"># REPOSITORY            TAG            IMAGE ID       CREATED         SIZE</span></span><br><span class="line"><span class="comment"># tomcat02              1.0            67be5e0517c6   7 seconds ago   672MB</span></span><br></pre></td></tr></table></figure>

<h2 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h2><p>docker 容器删除之后，运行时产生的数据也会一起删除，为了保留这些数据，我们有了数据卷技术。通过数据卷技术，我们将容器中数据同步到宿主机，容器之间也可以通过这个技术做数据共享。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -v, --volume list         # 挂载数据卷(Bind mount a volume)</span></span><br><span class="line"><span class="comment"># sample: docker run -it -v /Users/id/tmp/mount:/home centos /bin/bash</span></span><br><span class="line">docker run -it -v host_addr:container_addr [REPOSITORY[:TAG]]</span><br><span class="line"><span class="comment"># 测试 tomcat 时发现，-v 会以本地的文件夹为基准</span></span><br><span class="line"><span class="comment"># sample: docker run -d --name my-tomcat -P -v /Users/jack/tmp/mount:/usr/local/tomcat/webapps.dist tomcat</span></span><br><span class="line"><span class="comment"># 问题：</span></span><br><span class="line"><span class="comment">#   1. 本地路径必须是全路径 &#x27;./mount&#x27; 会查找失败</span></span><br><span class="line"><span class="comment">#   2. 挂载之后会以本地文件为基准，比如上例，webapps.dist 挂载到本地后，进入容器，这个文件夹下原有的文件都没了</span></span><br><span class="line"></span><br><span class="line">docker inspect [OPTIONS] NAME|ID [NAME|ID...]       <span class="comment"># 通过 inspect 可以看到具体的挂载信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># &quot;Mounts&quot;: [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Type&quot;: &quot;bind&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Source&quot;: &quot;/Users/jack/tmp/mount&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Destination&quot;: &quot;/usr/local/tomcat/webapps.dist&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Mode&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;RW&quot;: true,</span></span><br><span class="line"><span class="comment">#         &quot;Propagation&quot;: &quot;rprivate&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ],</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">停止容器，修改宿主机下的同步文件夹内容，容器启动后改动会同步到容器中</span><br></pre></td></tr></table></figure>

<h2 id="安装-MySQL-操作实践"><a href="#安装-MySQL-操作实践" class="headerlink" title="安装 MySQL 操作实践"></a>安装 MySQL 操作实践</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># -e MYSQL_ROOT_PASSWORD=my-secret-pw           # 按官方镜像文档提示，启动容器时设置密码</span></span><br><span class="line">docker run -d -p 3000:3306 -v /Users/id/tmp/mysql/conf:/etc/mysql/conf.d -v /Users/id/tmp/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 --name=mysql01 mysql:5.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 DBeaver，链接数据库，报错：`Unable to load authentication plugin &#x27;caching_sha2_password&#x27;.`</span></span><br><span class="line"><span class="comment"># 搜索之后，发现是 mysql 驱动有跟新，需要修稿客户端的 pom, 升级到 8.x 就行。DBeaver 直接就在创建选项里给了方案，选 8.x 那个就行 [GitIssue](https://github.com/dbeaver/dbeaver/issues/4691)</span></span><br><span class="line"><span class="comment"># 使用高版本的 Mysql connection 还是有问题，不过 msg 变了：`Public Key Retrieval is not allowed`</span></span><br><span class="line"><span class="comment"># 搜索之后，发现还要改配置, connection setting -&gt; Driver properties -&gt; &#x27;allowPlblicKeyRetrieval&#x27; 改为 true</span></span><br><span class="line"><span class="comment"># 还有问题。。。继续抛错：`Access denied for user &#x27;root&#x27;@&#x27;localhost&#x27; (using password: YES)`</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql01 /bin/bash               <span class="comment"># 进去容器，输入 `mysql -u root -p` 尝试登陆，成功。推测是链接客户端的问题</span></span><br><span class="line">ps -ef | grep mysql                             <span class="comment"># 查看了一下，突然想起来，本地我也有安装 mysql 可能有冲突。果断将之前安装的 docker mysql 删除，重新指定一个新的端口，用 DBeaver 链接，成功！</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过客户端创建一个新的数据库 new_test, 在本地映射的 data 目录下 ls 一下，可以看到新数据库文件可以同步创建</span></span><br><span class="line"><span class="comment"># &gt; ~/tmp/mydb/data ls</span></span><br><span class="line"><span class="comment"># auto.cnf           ca.pem             client-key.pem     ib_logfile0        ibdata1            mysql              performance_schema public_key.pem     server-key.pem</span></span><br><span class="line"><span class="comment"># ca-key.pem         client-cert.pem    ib_buffer_pool     ib_logfile1        ibtmp1             new_test           private_key.pem    server-cert.pem    sys</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除容器，本地文件依然存在！</span></span><br></pre></td></tr></table></figure>

<h2 id="具名挂载-Vs-匿名挂载"><a href="#具名挂载-Vs-匿名挂载" class="headerlink" title="具名挂载 Vs 匿名挂载"></a>具名挂载 Vs 匿名挂载</h2><p>具名挂载和匿名挂载是 <code>docker run</code> 命令中 <code>-v</code> 参数不同的使用情况。在明确指定挂载路径时(比如之前 mysql 和 tomcat 测试时的挂载指定), 通过 <code>docker volume ls</code> 可以看到是不会生产临时文件夹的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">docker volume rm $(docker volume ls -q)             <span class="comment"># 参考 rm 示例，删除所有的 volume, 准备测试环境</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -v path_in_container                              # 匿名挂载, 不指定宿主机挂载目录</span></span><br><span class="line">docker run -d --name my-tomcat01 -P -v /usr/<span class="built_in">local</span>/tomcat/webapps.dist tomcat</span><br><span class="line"></span><br><span class="line">docker volume ls                                    <span class="comment"># 查看卷情况</span></span><br><span class="line"><span class="comment"># DRIVER    VOLUME NAME</span></span><br><span class="line"><span class="comment"># local     0cd33950f5d8a050e61e58eaddae66b397db7b0e6968d40a1908a469c8386b03</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -v name:path_in_container                         # 具名挂载, 名字:容器中挂载点地址</span></span><br><span class="line">docker run -d --name my-tomcat02 -P -v tomcat02-volume:/usr/<span class="built_in">local</span>/tomcat/webapps.dist tomcat</span><br><span class="line"><span class="comment"># DRIVER    VOLUME NAME</span></span><br><span class="line"><span class="comment"># local     0cd33950f5d8a050e61e58eaddae66b397db7b0e6968d40a1908a469c8386b03</span></span><br><span class="line"><span class="comment"># local     tomcat02-volum</span></span><br><span class="line"></span><br><span class="line">docker volume inspect juming-nginx                  <span class="comment"># 使用 inspect 查看挂载点具体信息</span></span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;CreatedAt&quot;: &quot;2021-04-26T12:20:25Z&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Labels&quot;: null,</span></span><br><span class="line"><span class="comment">#         &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/tomcat02-volume/_data&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat02-volume&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Options&quot;: null,</span></span><br><span class="line"><span class="comment">#         &quot;Scope&quot;: &quot;local&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 总结：</span></span><br><span class="line"><span class="comment">#   -v path-in-container                  # 匿名挂载</span></span><br><span class="line"><span class="comment">#   -v volume-name:path-in-container      # 具名挂载</span></span><br><span class="line"><span class="comment">#   -v host-path:path-in-container        # 指定路径挂载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他使用方式，加 ro/rw 参数：</span></span><br><span class="line"><span class="comment">#   -v host-path:path-in-container:ro/rw</span></span><br><span class="line"><span class="comment">#       ro: read only, 只能通过宿主机改变，容器内部不能改变</span></span><br><span class="line"><span class="comment">#       rw: read and write, 默认的权限设置</span></span><br></pre></td></tr></table></figure>

<h2 id="数据共享"><a href="#数据共享" class="headerlink" title="数据共享"></a>数据共享</h2><p>多个容器之间是可以实现同步数据的效果的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">docker volume rm $(docker volume ls -q)                             <span class="comment"># 删除卷，准备实验环境</span></span><br><span class="line"></span><br><span class="line">docker run -it -d --name myos01 mycentos                            <span class="comment"># 启动自制容器作为父容器</span></span><br><span class="line"></span><br><span class="line">docker volume ls                                                    <span class="comment"># 两个挂载卷创建完毕</span></span><br><span class="line"><span class="comment"># DRIVER              VOLUME NAME</span></span><br><span class="line"><span class="comment"># local               8532efd6dabd0254bf5cec28de4df8225e4b633b91d83e13d80ba3ea97a9b314 &lt;- volume01</span></span><br><span class="line"><span class="comment"># local               b398a216526cfe3a52f71a92c383694f73b91900dbe57159c02ab63040078c21 &lt;- volume02</span></span><br><span class="line"></span><br><span class="line">docker run -it -d --name myos02 --volumes-from myos01 mycentos      <span class="comment"># 启动子容器, 查看卷信息，没有新建卷</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it myos01 /bin/bash                                    <span class="comment"># 进入容器 myos01</span></span><br><span class="line"><span class="built_in">cd</span> volume01 &amp;&amp; touch new.txt                                        <span class="comment"># 进入测试文件夹，新建测试文件</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it myos02 /bin/bash                                    <span class="comment"># 进入容器 myos02</span></span><br><span class="line">d volume01 &amp;&amp; ls                                                    <span class="comment"># 查看文件列表</span></span><br><span class="line"><span class="comment"># new.txt                                                           # 文件创建成功</span></span><br><span class="line"></span><br><span class="line">docker rm -f myos01                                                 <span class="comment"># 删除父容器</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it myos02 /bin/bash                                    <span class="comment"># 进入容器 myos02</span></span><br><span class="line">d volume01 &amp;&amp; ls                                                    <span class="comment"># 查看文件列表</span></span><br><span class="line"><span class="comment"># new.txt                                                           # 文件创建成功</span></span><br></pre></td></tr></table></figure>

<p>结论：</p>
<ul>
<li>数据卷容器的生命周期一直持续到没有容器使用为止</li>
<li>一旦持久化到本地，本地数据是不会删除的</li>
</ul>
<p>PS: 就我看还不如说，数据卷挂载的时候会在宿主机上创建一个对应的挂载点，文件都存在那里的，所以就算容器删了数据还是存在的</p>
<h2 id="初识-Dockerfile"><a href="#初识-Dockerfile" class="headerlink" title="初识 Dockerfile"></a>初识 Dockerfile</h2><p>用来构建 docker 镜像的文件</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile 示例，</span></span><br><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载两个卷</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">&quot;volume01&quot;</span>, <span class="string">&quot;volume02&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dockerfile 中只能有一条 CMD 指令，如果要执行多个 cmd 可以用 &amp;&amp; 链接</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;-----end-----&quot;</span> &amp;&amp; /bin/bash</span></span><br></pre></td></tr></table></figure>

<p>创建镜像文件并启动容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -f file-path          # 指定 Dockerfile 路径</span></span><br><span class="line"><span class="comment"># -t name:tag           # 为镜像取名，打 tag</span></span><br><span class="line">docker build [OPTIONS] PATH | URL | -</span><br><span class="line"><span class="comment"># sample: docker build -t mycentos .</span></span><br><span class="line"></span><br><span class="line">docker images           <span class="comment"># 查看新建 image 是否成功</span></span><br><span class="line"><span class="comment"># REPOSITORY       TAG                IMAGE ID       CREATED         SIZE</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># mycentos         0.1                1fa2eebe33e7   3 days ago      282MB</span></span><br><span class="line"><span class="comment"># docker images 查看自建的镜像</span></span><br><span class="line"></span><br><span class="line">docker run -it --name myos mycentos     <span class="comment"># 启动测试</span></span><br><span class="line"><span class="comment"># ----- end file -------                # 自定义 log 输出成功</span></span><br><span class="line"><span class="comment"># [root@ab726584ad36 /]# ls -al         # 两个新文件夹 volume1, volume2 创建成功</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># drwxr-xr-x   2 root root 4096 Apr 27 06:34 volume01</span></span><br><span class="line"><span class="comment"># drwxr-xr-x   2 root root 4096 Apr 27 06:34 volume02</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> volume1 &amp;&amp; ehco <span class="string">&quot;test&quot;</span> &gt;&gt; new_file.txt       <span class="comment"># 在 volume1 文件夹下创建一个测试文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 volume1 中新建文件 echo &quot;new&quot; &gt;&gt; new_file.txt</span></span><br><span class="line">docker inspect myos</span><br><span class="line"><span class="comment"># &quot;Mounts&quot;: [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Type&quot;: &quot;volume&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;f8d5471d593bd05dc18d5ce04a09353f805113408b15b3557dafb71b84bdd73b&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Source&quot;: &quot;/var/lib/docker/volumes/f8d5471d593bd05dc18d5ce04a09353f805113408b15b3557dafb71b84bdd73b/_data&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Destination&quot;: &quot;volume02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Mode&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;RW&quot;: true,</span></span><br><span class="line"><span class="comment">#         &quot;Propagation&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Type&quot;: &quot;volume&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;a4940f45b4573330e4db3964ad7534543404fc37eaacce797eff664744240337&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Source&quot;: &quot;/var/lib/docker/volumes/a4940f45b4573330e4db3964ad7534543404fc37eaacce797eff664744240337/_data&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Destination&quot;: &quot;volume01&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Mode&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;RW&quot;: true,</span></span><br><span class="line"><span class="comment">#         &quot;Propagation&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /var/lib/docker/volumes/a4940f45b4573330e4db3964ad7534543404fc37eaacce797eff664744240337/_data &amp;&amp; ls     <span class="comment"># 查看挂载目录下的文件列表</span></span><br><span class="line"><span class="comment"># new_file.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面这个查看挂载文件的操作只能在 Linux 系统上做， Windows 和 MacOS 系统上的 docker 都是通过虚拟机启动的，虽然能看到类似的信息，但是本机上是不能访问挂载文件夹的</span></span><br></pre></td></tr></table></figure>

<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>A Dockerfile is a text document that contains all the commands a user could call on the command line to assemble an image.</p>
<p>构建镜像的步骤：</p>
<ol>
<li>创建 Dockerfile 文件</li>
<li>docker build 构建镜像</li>
<li>docker run 运行镜像</li>
<li>docker push 发布镜像</li>
</ol>
<p>文件格式注：</p>
<ul>
<li>每个保留关键字都必须是大写的字母</li>
<li>执行顺序从上倒下</li>
<li><code>#</code> 表示注释</li>
<li>每个指令都会创建提交一个新的镜像层，并提交</li>
</ul>
<p>常用指令：</p>
<p>参考<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">官方文档</a></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span>            <span class="comment"># 基础镜像，起点</span></span><br><span class="line"><span class="keyword">MAINTAINER</span>      <span class="comment"># 作者</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">             <span class="comment"># 镜像构建的时候需要运行的命令</span></span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash">             <span class="comment"># 步骤，比如添加tomcat 压缩包</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash">         <span class="comment"># 镜像工作目录</span></span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash">          <span class="comment"># 挂载目录</span></span></span><br><span class="line"><span class="keyword">EXPOSE</span>          <span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash">             <span class="comment"># 指定容器启动的时候运行的命令，只有最后一个会生效，可被替代</span></span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash">      <span class="comment"># 指定容器启动时运行的命令，可以追加命令</span></span></span><br><span class="line"><span class="keyword">ONBUILD</span>         <span class="comment"># 当构建一个被继承的 Dockerfile 就会运行 ONBUILD指令，触发指令</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash">            <span class="comment"># 类似 ADD， 将文件拷贝到镜像中</span></span></span><br><span class="line"><span class="keyword">ENV</span>             <span class="comment"># 设置环境变量</span></span><br></pre></td></tr></table></figure>

<p>实践案例：构建自己的 centos</p>
<p>编写 dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> jzheng&lt;jzheng@my.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MYPATH /usr/local</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$MYPATH</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install vim</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install net-tools</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CMD echo $MYPATH &amp;&amp; echo &quot;---- end ----&quot; &amp;&amp; /bin/bash 会出问题</span></span><br><span class="line"><span class="comment"># docker run -it --name my01 myos</span></span><br><span class="line"><span class="comment"># /usr/local</span></span><br><span class="line"><span class="comment"># ----end----</span></span><br><span class="line"><span class="comment"># /bin/sh: CMD: command not found</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /bin/bash</span></span><br></pre></td></tr></table></figure>

<p>运行构建命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">docker build -f Dockerfile -t mycentos .            <span class="comment"># 开始构建，mac 和 linux 上给的 log 有差别</span></span><br><span class="line"><span class="comment"># Sending build context to Docker daemon 2.048 kB</span></span><br><span class="line"><span class="comment"># Step 1/8 : FROM centos                            # 每一个 step 都会生产一个新的镜像文件</span></span><br><span class="line"><span class="comment">#  ---&gt; 300e315adb2f</span></span><br><span class="line"><span class="comment"># Step 2/8 : MAINTAINER jzheng&lt;jzheng@my.com&gt;</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in e71638786ebe</span></span><br><span class="line"><span class="comment">#  ---&gt; 6dda844c25cb</span></span><br><span class="line"><span class="comment"># Removing intermediate container e71638786ebe</span></span><br><span class="line"><span class="comment"># Step 3/8 : ENV MYPATH /usr/local</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in ad27737ada75</span></span><br><span class="line"><span class="comment">#  ---&gt; 9a617502fc06</span></span><br><span class="line"><span class="comment"># Removing intermediate container ad27737ada75</span></span><br><span class="line"><span class="comment"># Step 4/8 : WORKDIR $MYPATH</span></span><br><span class="line"><span class="comment">#  ---&gt; 79d1c3e4be51</span></span><br><span class="line"><span class="comment"># Removing intermediate container ea4189b4b4eb</span></span><br><span class="line"><span class="comment"># Step 5/8 : RUN yum -y install vim</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in 27be499e2b36</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS Linux 8 - AppStream                      9.7 MB/s | 6.3 MB     00:00</span></span><br><span class="line"><span class="comment"># CentOS Linux 8 - BaseOS                         2.8 MB/s | 2.3 MB     00:00</span></span><br><span class="line"><span class="comment"># CentOS Linux 8 - Extras                          13 kB/s | 9.6 kB     00:00</span></span><br><span class="line"><span class="comment"># Dependencies resolved.</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment">#  Package             Arch        Version                   Repository      Size</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment"># Installing:</span></span><br><span class="line"><span class="comment">#  vim-enhanced        x86_64      2:8.0.1763-15.el8         appstream      1.4 M</span></span><br><span class="line"><span class="comment"># Installing dependencies:</span></span><br><span class="line"><span class="comment">#  gpm-libs            x86_64      1.20.7-15.el8             appstream       39 k</span></span><br><span class="line"><span class="comment">#  vim-common          x86_64      2:8.0.1763-15.el8         appstream      6.3 M</span></span><br><span class="line"><span class="comment">#  vim-filesystem      noarch      2:8.0.1763-15.el8         appstream       48 k</span></span><br><span class="line"><span class="comment">#  which               x86_64      2.21-12.el8               baseos          49 k</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Transaction Summary</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment"># Install  5 Packages</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Total download size: 7.8 M</span></span><br><span class="line"><span class="comment"># Installed size: 30 M</span></span><br><span class="line"><span class="comment"># Downloading Packages:</span></span><br><span class="line"><span class="comment"># (1/5): gpm-libs-1.20.7-15.el8.x86_64.rpm        860 kB/s |  39 kB     00:00</span></span><br><span class="line"><span class="comment"># (2/5): vim-filesystem-8.0.1763-15.el8.noarch.rp 4.1 MB/s |  48 kB     00:00</span></span><br><span class="line"><span class="comment"># (3/5): vim-enhanced-8.0.1763-15.el8.x86_64.rpm   13 MB/s | 1.4 MB     00:00</span></span><br><span class="line"><span class="comment"># (4/5): vim-common-8.0.1763-15.el8.x86_64.rpm     38 MB/s | 6.3 MB     00:00</span></span><br><span class="line"><span class="comment"># (5/5): which-2.21-12.el8.x86_64.rpm             435 kB/s |  49 kB     00:00</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Total                                           7.7 MB/s | 7.8 MB     00:01</span></span><br><span class="line"><span class="comment"># CentOS Linux 8 - AppStream                      1.6 MB/s | 1.6 kB     00:00</span></span><br><span class="line"><span class="comment"># warning: /var/cache/dnf/appstream-02e86d1c976ab532/packages/gpm-libs-1.20.7-15.el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID 8483c65d: NOKEY</span></span><br><span class="line"><span class="comment"># Importing GPG key 0x8483C65D:</span></span><br><span class="line"><span class="comment">#  Userid     : &quot;CentOS (CentOS Official Signing Key) &lt;security@centos.org&gt;&quot;</span></span><br><span class="line"><span class="comment">#  Fingerprint: 99DB 70FA E1D7 CE22 7FB6 4882 05B5 55B3 8483 C65D</span></span><br><span class="line"><span class="comment">#  From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial</span></span><br><span class="line"><span class="comment"># Key imported successfully</span></span><br><span class="line"><span class="comment"># Running transaction check</span></span><br><span class="line"><span class="comment"># Transaction check succeeded.</span></span><br><span class="line"><span class="comment"># Running transaction test</span></span><br><span class="line"><span class="comment"># Transaction test succeeded.</span></span><br><span class="line"><span class="comment"># Running transaction</span></span><br><span class="line"><span class="comment">#   Preparing        :                                                        1/1</span></span><br><span class="line"><span class="comment">#   Installing       : which-2.21-12.el8.x86_64                               1/5</span></span><br><span class="line"><span class="comment">#   Installing       : vim-filesystem-2:8.0.1763-15.el8.noarch                2/5</span></span><br><span class="line"><span class="comment">#   Installing       : vim-common-2:8.0.1763-15.el8.x86_64                    3/5</span></span><br><span class="line"><span class="comment">#   Installing       : gpm-libs-1.20.7-15.el8.x86_64                          4/5</span></span><br><span class="line"><span class="comment">#   Running scriptlet: gpm-libs-1.20.7-15.el8.x86_64                          4/5</span></span><br><span class="line"><span class="comment">#   Installing       : vim-enhanced-2:8.0.1763-15.el8.x86_64                  5/5</span></span><br><span class="line"><span class="comment">#   Running scriptlet: vim-enhanced-2:8.0.1763-15.el8.x86_64                  5/5</span></span><br><span class="line"><span class="comment">#   Running scriptlet: vim-common-2:8.0.1763-15.el8.x86_64                    5/5</span></span><br><span class="line"><span class="comment">#   Verifying        : gpm-libs-1.20.7-15.el8.x86_64                          1/5</span></span><br><span class="line"><span class="comment">#   Verifying        : vim-common-2:8.0.1763-15.el8.x86_64                    2/5</span></span><br><span class="line"><span class="comment">#   Verifying        : vim-enhanced-2:8.0.1763-15.el8.x86_64                  3/5</span></span><br><span class="line"><span class="comment">#   Verifying        : vim-filesystem-2:8.0.1763-15.el8.noarch                4/5</span></span><br><span class="line"><span class="comment">#   Verifying        : which-2.21-12.el8.x86_64                               5/5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installed:</span></span><br><span class="line"><span class="comment">#   gpm-libs-1.20.7-15.el8.x86_64         vim-common-2:8.0.1763-15.el8.x86_64</span></span><br><span class="line"><span class="comment">#   vim-enhanced-2:8.0.1763-15.el8.x86_64 vim-filesystem-2:8.0.1763-15.el8.noarch</span></span><br><span class="line"><span class="comment">#   which-2.21-12.el8.x86_64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Complete!</span></span><br><span class="line"><span class="comment">#  ---&gt; 07a9459e3208</span></span><br><span class="line"><span class="comment"># Removing intermediate container 27be499e2b36</span></span><br><span class="line"><span class="comment"># Step 6/8 : RUN yum -y install net-tools</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in 9dd0c1e98a2f</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Last metadata expiration check: 0:00:07 ago on Tue Apr 27 08:30:37 2021.</span></span><br><span class="line"><span class="comment"># Dependencies resolved.</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment">#  Package         Architecture Version                        Repository    Size</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment"># Installing:</span></span><br><span class="line"><span class="comment">#  net-tools       x86_64       2.0-0.52.20160912git.el8       baseos       322 k</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Transaction Summary</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment"># Install  1 Package</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Total download size: 322 k</span></span><br><span class="line"><span class="comment"># Installed size: 942 k</span></span><br><span class="line"><span class="comment"># Downloading Packages:</span></span><br><span class="line"><span class="comment"># net-tools-2.0-0.52.20160912git.el8.x86_64.rpm   1.6 MB/s | 322 kB     00:00</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Total                                           519 kB/s | 322 kB     00:00</span></span><br><span class="line"><span class="comment"># Running transaction check</span></span><br><span class="line"><span class="comment"># Transaction check succeeded.</span></span><br><span class="line"><span class="comment"># Running transaction test</span></span><br><span class="line"><span class="comment"># Transaction test succeeded.</span></span><br><span class="line"><span class="comment"># Running transaction</span></span><br><span class="line"><span class="comment">#   Preparing        :                                                        1/1</span></span><br><span class="line"><span class="comment">#   Installing       : net-tools-2.0-0.52.20160912git.el8.x86_64              1/1</span></span><br><span class="line"><span class="comment">#   Running scriptlet: net-tools-2.0-0.52.20160912git.el8.x86_64              1/1</span></span><br><span class="line"><span class="comment">#   Verifying        : net-tools-2.0-0.52.20160912git.el8.x86_64              1/1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installed:</span></span><br><span class="line"><span class="comment">#   net-tools-2.0-0.52.20160912git.el8.x86_64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Complete!</span></span><br><span class="line"><span class="comment">#  ---&gt; d4af6e7280be</span></span><br><span class="line"><span class="comment"># Removing intermediate container 9dd0c1e98a2f</span></span><br><span class="line"><span class="comment"># Step 7/8 : EXPOSE 80</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in 8258f5335635</span></span><br><span class="line"><span class="comment">#  ---&gt; 612fbdec4589</span></span><br><span class="line"><span class="comment"># Removing intermediate container 8258f5335635</span></span><br><span class="line"><span class="comment"># Step 8/8 : CMD /bin/bash</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in 1e7dc8bd18cb</span></span><br><span class="line"><span class="comment">#  ---&gt; 8ce94727fa9f</span></span><br><span class="line"><span class="comment"># Removing intermediate container 1e7dc8bd18cb</span></span><br><span class="line"><span class="comment"># Successfully built 8ce94727fa9f</span></span><br><span class="line"></span><br><span class="line">docker run -it --rm myos</span><br><span class="line"><span class="comment"># [root@af8b74546536 local]# pwd</span></span><br><span class="line"><span class="comment"># /usr/local                                # 起始目录已经和设定的一样发生了变化, 输入 ifconfig 和 vim 也能正常运行</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">history</span> myos                         <span class="comment"># 查看 image 构建历史, 可以查看热门 image 学习构建过程</span></span><br><span class="line"><span class="comment"># IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT</span></span><br><span class="line"><span class="comment"># 8ce94727fa9f        4 minutes ago       /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;/b...   0 B</span></span><br><span class="line"><span class="comment"># 612fbdec4589        4 minutes ago       /bin/sh -c #(nop)  EXPOSE 80/tcp                0 B</span></span><br><span class="line"><span class="comment"># d4af6e7280be        4 minutes ago       /bin/sh -c yum -y install net-tools             23.3 MB</span></span><br><span class="line"><span class="comment"># 07a9459e3208        4 minutes ago       /bin/sh -c yum -y install vim                   58 MB</span></span><br><span class="line"><span class="comment"># 79d1c3e4be51        4 minutes ago       /bin/sh -c #(nop) WORKDIR /usr/local            0 B</span></span><br><span class="line"><span class="comment"># 9a617502fc06        4 minutes ago       /bin/sh -c #(nop)  ENV MYPATH=/usr/local        0 B</span></span><br><span class="line"><span class="comment"># 6dda844c25cb        4 minutes ago       /bin/sh -c #(nop)  MAINTAINER jzheng&lt;jzhen...   0 B</span></span><br><span class="line"><span class="comment"># 300e315adb2f        4 months ago        /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0 B</span></span><br><span class="line"><span class="comment"># &lt;missing&gt;           4 months ago        /bin/sh -c #(nop)  LABEL org.label-schema....   0 B</span></span><br><span class="line"><span class="comment"># &lt;missing&gt;           4 months ago        /bin/sh -c #(nop) ADD file:bd7a2aed6ede423...   209 MB</span></span><br></pre></td></tr></table></figure>

<h2 id="CMD-Vs-ENTRYPOINT"><a href="#CMD-Vs-ENTRYPOINT" class="headerlink" title="CMD Vs ENTRYPOINT"></a>CMD Vs ENTRYPOINT</h2><p>CMD 只有最后一个命令会生效 由下面的 file 构建的 image, run 时只会输出 2</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;2&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>创建 Dockerfile 测试 CMD 命令</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-a&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>测试：构建镜像, 运行容器查看输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">docker build -t cmdtest .</span><br><span class="line"><span class="comment"># Sending build context to Docker daemon 2.048 kB</span></span><br><span class="line"><span class="comment"># Step 1/2 : FROM centos</span></span><br><span class="line"><span class="comment">#  ---&gt; 300e315adb2f</span></span><br><span class="line"><span class="comment"># Step 2/2 : CMD ls -al</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in e8e0790ae8f3</span></span><br><span class="line"><span class="comment">#  ---&gt; 513ebac8ebef</span></span><br><span class="line"><span class="comment"># Removing intermediate container e8e0790ae8f3</span></span><br><span class="line"><span class="comment"># Successfully built 513ebac8ebef</span></span><br><span class="line"></span><br><span class="line">docker run cmdtest</span><br><span class="line"><span class="comment"># .</span></span><br><span class="line"><span class="comment"># ..</span></span><br><span class="line"><span class="comment"># .dockerenv</span></span><br><span class="line"><span class="comment"># bin</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># sys</span></span><br><span class="line"><span class="comment"># tmp</span></span><br><span class="line"><span class="comment"># usr</span></span><br><span class="line"><span class="comment"># var</span></span><br><span class="line"></span><br><span class="line">docker run cmdtest -l               <span class="comment"># 如果想要追加 `l` 给出 `ls -al` 的效果怎么办？直接在 run 后接参数会报错</span></span><br><span class="line"><span class="comment"># container_linux.go:235: starting container process caused &quot;exec: \&quot;-l\&quot;: executable file not found in $PATH&quot;</span></span><br><span class="line"><span class="comment"># /usr/bin/docker-current: Error response from daemon: oci runtime error: container_linux.go:235: starting container process caused &quot;exec: \&quot;-l\&quot;: executable file not found in $PATH&quot;.</span></span><br><span class="line"></span><br><span class="line">docker run cmdtest ls -al         <span class="comment"># 输入完整命令可以达到想要的效果，就是有点冗余</span></span><br><span class="line"><span class="comment"># total 56</span></span><br><span class="line"><span class="comment"># drwxr-xr-x  1 root root 4096 Apr 27 08:49 .</span></span><br><span class="line"><span class="comment"># drwxr-xr-x  1 root root 4096 Apr 27 08:49 ..</span></span><br><span class="line"><span class="comment"># -rwxr-xr-x  1 root root    0 Apr 27 08:49 .dockerenv</span></span><br><span class="line"><span class="comment"># lrwxrwxrwx  1 root root    7 Nov  3 15:22 bin -&gt; usr/bin</span></span><br><span class="line"><span class="comment"># drwxr-xr-x  5 root root  340 Apr 27 08:49 dev</span></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>如果想要直接接命令参数，可以用 ENTRYPOINT</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-a&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker build -f mydockerfile -t entrypointtest .        <span class="comment"># 构建镜像</span></span><br><span class="line"></span><br><span class="line">docker run entrypointtest -l                            <span class="comment"># 启动容器时直接加参数即可</span></span><br><span class="line"><span class="comment"># total 56</span></span><br><span class="line"><span class="comment"># drwxr-xr-x  1 root root 4096 Apr 27 08:53 .</span></span><br><span class="line"><span class="comment"># drwxr-xr-x  1 root root 4096 Apr 27 08:53 ..</span></span><br><span class="line"><span class="comment"># -rwxr-xr-x  1 root root    0 Apr 27 08:53 .dockerenv</span></span><br><span class="line"><span class="comment"># lrwxrwxrwx  1 root root    7 Nov  3 15:22 bin -&gt; usr/bin</span></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<h2 id="实战：-制作-Tomcat-镜像"><a href="#实战：-制作-Tomcat-镜像" class="headerlink" title="实战： 制作 Tomcat 镜像"></a>实战： 制作 Tomcat 镜像</h2><p>PS: 做这个练习前可以先本地安装 tomcat + JDK 找找感觉</p>
<ol>
<li>准备镜像文件 + tomcat压缩包 + JDK压缩包</li>
<li>编写 Dockerfile 文件</li>
</ol>
<p>Google 搜索名字可直接下载压缩包 <code>jdk-8u202-linux-x64.tar.gz</code> + <code>apache-tomcat-9.0.22.tar.gz</code></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer=<span class="string">&quot;jzheng@aa.com&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> readme.txt /usr/<span class="built_in">local</span>/readme.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> jdk-8u202-linux-x64.tar.gz /usr/<span class="built_in">local</span>/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> apache-tomcat-9.0.22.tar.gz /usr/<span class="built_in">local</span>/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install vim</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MYPATH /usr/local</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$MYPATH</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/local/jdk1.<span class="number">8.0</span>_11</span><br><span class="line"><span class="keyword">ENV</span> CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"><span class="keyword">ENV</span> CATALINA_HOME /usr/local/apache-tomcat-<span class="number">9.0</span>.<span class="number">22</span></span><br><span class="line"><span class="keyword">ENV</span> CATALINA_BASH /usr/local/apache-tomcat-<span class="number">9.0</span>.<span class="number">22</span></span><br><span class="line"><span class="keyword">ENV</span> PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /usr/<span class="built_in">local</span>/apache-tomcat-9.0.22/bin/startup.sh &amp;&amp; tail -F /usr/<span class="built_in">local</span>/apache-tomcat-9.0.22/bin/logs/catalina.out</span></span><br></pre></td></tr></table></figure>

<p>构建镜像 <code>docker build -t diytomcat .</code>, 由于使用官方标准的名字 Dockerfile 就不需要用 -f 参数了, 构建 log 如下</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[+] Building 119.9s (11/11) FINISHED                                                                                                             </span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                                                                        0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 677B                                                                                                        0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                                           0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                                             0.0s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/centos:latest                                                                            0.0s</span><br><span class="line"> =&gt; [internal] load build context                                                                                                           3.6s</span><br><span class="line"> =&gt; =&gt; transferring context: 205.02MB                                                                                                       3.6s</span><br><span class="line"> =&gt; CACHED [1/6] FROM docker.io/library/centos                                                                                              0.0s</span><br><span class="line"> =&gt; [2/6] COPY readme.txt /usr/local/readme.txt                                                                                             0.3s</span><br><span class="line"> =&gt; [3/6] ADD jdk-8u202-linux-x64.tar.gz /usr/local/                                                                                        4.8s</span><br><span class="line"> =&gt; [4/6] ADD apache-tomcat-9.0.22.tar.gz /usr/local/                                                                                       0.4s</span><br><span class="line"> =&gt; [5/6] RUN yum -y install vim                                                                                                          109.1s</span><br><span class="line"> =&gt; [6/6] WORKDIR /usr/local                                                                                                                0.0s</span><br><span class="line"> =&gt; exporting to image                                                                                                                      1.7s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                                                     1.7s</span><br><span class="line"> =&gt; =&gt; writing image sha256:4be1d03815380be7ca336c90e33b928890b5c604d646646b6087303385b0c8c0                                                0.0s </span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/diytomcat                                                                                                0.0s </span><br></pre></td></tr></table></figure>

<p>启动镜像，并为之挂载节点 <code>docker run -d -p 9090:8080 --name mytomcat -v /Users/jack/tmp/tmount/test:/usr/local/apache-tomcat-9.0.22/webapps/test -v /Users/jack/tmp/tmount/tomcatlogs:/usr/local/apache-tomcat-9.0.22/logs diytomcat</code></p>
<p>查看本地 logs 文件，报错</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; cat catalina.out </span><br><span class="line">/usr/local/apache-tomcat-9.0.22/bin/catalina.sh: line 464: /usr/local/jdk1.8.0_11/bin/java: No such file or directory</span><br></pre></td></tr></table></figure>

<p>检查后发现我下载的是 <code>jdk-8u202-linux-x64</code> 和视频上的不一样，很多地方变量都错了，改了重新 build 一下</p>
<p>突发奇想：虽然配置错了，但是我其实是可以直接进到终端重新配置使 Java 生效的，但是回头整个 follow 过了一下，发现还是不行，无法暴露端口。。。</p>
<p>再次查看 logs 日志，并访问 localhost:9090 tomcat 启动成功 (●°u°●)​ 」</p>
<p>在本地 test 目录下创建测试用页面</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── WEB-INF</span><br><span class="line">│   └── web.xml</span><br><span class="line">└── index.jsp</span><br><span class="line"></span><br><span class="line">// index.jsp 内容如下</span><br><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;title&gt;hello, docker&lt;/title&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Hello World!&lt;/h2&gt;</span><br><span class="line"> &lt;%System.out.println(&quot;-------my test web logs--------&quot;);%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">// web.xml 内容如下</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;web-app version=&quot;2.4&quot; </span><br><span class="line">    xmlns=&quot;http://java.sun.com/xml/ns/j2ee&quot; </span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/j2ee </span><br><span class="line">        http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot;&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure>

<p>直接访问 localhost:9090/test 可以看到新写的页面显示成功, logs 下的 catalina.out 会输出 jsp 里的打印信息</p>
<h2 id="docker0-网络详解"><a href="#docker0-网络详解" class="headerlink" title="docker0 网络详解"></a>docker0 网络详解</h2><p>这部分实验需要在 Linux 环境下测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">ip addr         <span class="comment"># 终端测试命令</span></span><br><span class="line"><span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000               # 本机回环地址</span></span><br><span class="line"><span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"><span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 ::1/128 scope host</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000     # 阿里云内网地址</span></span><br><span class="line"><span class="comment">#     link/ether 00:16:3e:23:6b:3f brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="comment">#     inet 172.28.231.212/20 brd 172.28.239.255 scope global dynamic eth0</span></span><br><span class="line"><span class="comment">#        valid_lft 315353600sec preferred_lft 315353600sec</span></span><br><span class="line"><span class="comment">#     inet6 fe80::216:3eff:fe23:6b3f/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default           # docker0地址</span></span><br><span class="line"><span class="comment">#     link/ether 02:42:79:29:30:37 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="comment">#     inet 172.17.0.1/16 scope global docker0</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 fe80::42:79ff:fe29:3037/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line">docker run -d -P --name tomcat01 tomcat                     <span class="comment"># 启动测试容器</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat01 ip addr                            <span class="comment"># 进入容器查看本机地址，可以看到网卡名 eth0@if55，地址 172.17.0.2/16</span></span><br><span class="line"><span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span></span><br><span class="line"><span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"><span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 ::1/128 scope host</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 54: eth0@if55: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></span><br><span class="line"><span class="comment">#     link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span></span><br><span class="line"><span class="comment">#     inet 172.17.0.2/16 scope global eth0</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 fe80::42:acff:fe11:2/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line">ping 172.17.0.2     <span class="comment"># 回到宿主机，ping 容器，可以 ping 通, mac 不能 ping 通，应该是 OS 差异导致的</span></span><br><span class="line"><span class="comment"># PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.038 ms</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [原理] 我们每启动一个 docker 容器，docker 就会给 docker 容器分配一个 ip，只要安装了 docker 就会有一个 docker0，采用桥接模式，使用 veth-pair 技术。</span></span><br><span class="line"></span><br><span class="line">ip addr             <span class="comment"># 再次查看 ip 地址，可以看到有一个新的网卡 veth9a205ef@if54 生成了</span></span><br><span class="line"><span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span></span><br><span class="line"><span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"><span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 ::1/128 scope host</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span></span><br><span class="line"><span class="comment">#     link/ether 00:16:3e:23:6b:3f brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="comment">#     inet 172.28.231.212/20 brd 172.28.239.255 scope global dynamic eth0</span></span><br><span class="line"><span class="comment">#        valid_lft 315353315sec preferred_lft 315353315sec</span></span><br><span class="line"><span class="comment">#     inet6 fe80::216:3eff:fe23:6b3f/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></span><br><span class="line"><span class="comment">#     link/ether 02:42:79:29:30:37 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="comment">#     inet 172.17.0.1/16 scope global docker0</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 fe80::42:79ff:fe29:3037/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 55: veth9a205ef@if54: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span></span><br><span class="line"><span class="comment">#     link/ether e2:a0:b1:2d:41:18 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span></span><br><span class="line"><span class="comment">#     inet6 fe80::e0a0:b1ff:fe2d:4118/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line">docker run -P -d --name tomcat02 tomcat         <span class="comment"># 启动新的容器，观察网卡信息</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat ip addr</span><br><span class="line"><span class="comment"># 56: eth0@if57: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></span><br><span class="line"><span class="comment">#     link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span></span><br><span class="line"><span class="comment">#     inet 172.17.0.3/16 scope global eth0</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 fe80::42:acff:fe11:3/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line">ip addr                                         <span class="comment"># 宿主机和容器新增网卡对应关系 veth5b8ed66@if56 - eth0@if57</span></span><br><span class="line"><span class="comment"># 57: veth5b8ed66@if56: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span></span><br><span class="line"><span class="comment">#     link/ether ae:21:12:09:51:01 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span></span><br><span class="line"><span class="comment">#     inet6 fe80::ac21:12ff:fe09:5101/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat02 ping 172.17.02        <span class="comment"># 在 tomcat02 中尝试 ping tomcat01, 可以 ping 通</span></span><br><span class="line"><span class="comment"># PING 172.17.02 (172.17.0.2) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.066 ms</span></span><br><span class="line"></span><br><span class="line">docker rm -f tomcat01                           <span class="comment"># 删除测试容器</span></span><br><span class="line"></span><br><span class="line">ip addr                                         <span class="comment"># 对应的虚拟网卡也被删除</span></span><br></pre></td></tr></table></figure>

<p>新建容器生产的网卡都是成对出现的，这里采用 veth-pair 技术，一端连着协议，一端彼此相连</p>
<p>veth-pair 充当一个桥梁，链接各种虚拟网络设备</p>
<p>docker0 相当于一个虚拟路由器, 通信模型如下</p>
<p><img src="docker_network.png" alt="docker network"></p>
<p>tomcat01 和 tomcat02 都是公用一个路由(docker0), 所有容器不指定网络的情况下，都使用 docker0 作为路由，docker 会给容器分配默认的可用 ip</p>
<p>255.255.0.1/16: 16 表示前 16 位为同一个网络</p>
<p><img src="docker_network01.png" alt="docker network02"></p>
<p>Docker 中所有的网络接口都是虚拟的，虚拟的转发效率高</p>
<h2 id="–link"><a href="#–link" class="headerlink" title="–link"></a>–link</h2><blockquote>
<p>思考：我们编写一个微服务， database url=ip…，项目不重启，数据库 ip 换掉了，配置就失效了。我们是否可以通过指定名字进行访问</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it tomcat01 ping tomcat02                          <span class="comment"># 默认通过 name 是不能 ping 通的</span></span><br><span class="line"><span class="comment"># ping: tomcat02: Name or service not known</span></span><br><span class="line"></span><br><span class="line">docker run -d -P --name tomcat03 --link tomcat02 tomcat         <span class="comment"># 启动容器时加入 --link 参数即可实现上述效果</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat03 ping tomcat02                </span><br><span class="line"><span class="comment"># PING tomcat02 (172.17.0.3) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat02 (172.17.0.3): icmp_seq=1 ttl=64 time=0.077 ms</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat02 (172.17.0.3): icmp_seq=2 ttl=64 time=0.050 ms</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat02 ping tomcat03                          <span class="comment"># 但是反向是 ping 不通的！！?</span></span><br><span class="line"><span class="comment"># ping: tomcat03: Name or service not known</span></span><br><span class="line"></span><br><span class="line">docker network ls                                               <span class="comment"># 使用 docker network ls 查看当前网络配置</span></span><br><span class="line"><span class="comment"># NETWORK ID          NAME                DRIVER              SCOPE</span></span><br><span class="line"><span class="comment"># ceb0592c9055        bridge              bridge              local</span></span><br><span class="line"><span class="comment"># 5ac97b2cf390        host                host                local</span></span><br><span class="line"><span class="comment"># 03f71a7f47f1        none                null                local</span></span><br><span class="line"></span><br><span class="line">docker inspect bridge                                           <span class="comment"># bridge 即 docker0 的网卡，包含 tomcat01-03 的网络信息</span></span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;bridge&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Id&quot;: &quot;ceb0592c9055bd94767114d43e3677b18fd8a41a2afe6966d64551b71a09041c&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Created&quot;: &quot;2021-04-27T15:19:48.803023317+08:00&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Scope&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;bridge&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EnableIPv6&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;IPAM&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;Driver&quot;: &quot;default&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;Options&quot;: null,</span></span><br><span class="line"><span class="comment">#             &quot;Config&quot;: [</span></span><br><span class="line"><span class="comment">#                 &#123;</span></span><br><span class="line"><span class="comment">#                     &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;,  # 子网掩码，最多可配 256*256 个子节点</span></span><br><span class="line"><span class="comment">#                     &quot;Gateway&quot;: &quot;172.17.0.1&quot;     # 默认网关，docker0</span></span><br><span class="line"><span class="comment">#                 &#125;</span></span><br><span class="line"><span class="comment">#             ]</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Internal&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;Attachable&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;Containers&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;2d12d505984e201296ecf26c6705405dc0fd67fd2f837f2a9c0deadbe690eb06&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;Name&quot;: &quot;tomcat02&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;EndpointID&quot;: &quot;4a71a36b8e3c04febdc0bdc0c86a3d5fdbf2b39daec75dcef3873acf5d017c37&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv4Address&quot;: &quot;172.17.0.3/16&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#             &#125;,</span></span><br><span class="line"><span class="comment">#             &quot;4adfd9b9e4a50876d65a1786ea188e7d0b4b0c0099747b3f3bb1e460be5f0849&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;Name&quot;: &quot;tomcat03&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;EndpointID&quot;: &quot;debaf9ed00b14992dc700a1d30ada54be9f12206139483d490d87e7ac055da0f&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;MacAddress&quot;: &quot;02:42:ac:11:00:04&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv4Address&quot;: &quot;172.17.0.4/16&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#             &#125;,</span></span><br><span class="line"><span class="comment">#             &quot;c1d873b0967c6c41929099f2898a0478eb91538b5d889c4d38ea74f29a3f4433&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;Name&quot;: &quot;tomcat01&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;EndpointID&quot;: &quot;28e9076a4c9b56044588ca3993a6d481e08989a78ebe82c7b6632b17d437f79c&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#             &#125;</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Options&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.bridge.default_bridge&quot;: &quot;true&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.bridge.enable_icc&quot;: &quot;true&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.bridge.enable_ip_masquerade&quot;: &quot;true&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.bridge.host_binding_ipv4&quot;: &quot;0.0.0.0&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.bridge.name&quot;: &quot;docker0&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.driver.mtu&quot;: &quot;1500&quot;</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Labels&quot;: &#123;&#125;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line">docker inspect tomcat03                     <span class="comment"># 查看 link 配置</span></span><br><span class="line"><span class="comment"># &quot;Links&quot;: [</span></span><br><span class="line"><span class="comment">#     &quot;/tomcat02:/tomcat03/tomcat02&quot;</span></span><br><span class="line"><span class="comment"># ],</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat03 cat /etc/hosts     <span class="comment"># 查看 tomcat03 的 host 配置, --link 会修改容器 hosts 配置达到绑定 ip 的效果</span></span><br><span class="line"><span class="comment"># 127.0.0.1    localhost</span></span><br><span class="line"><span class="comment"># ::1    localhost ip6-localhost ip6-loopback</span></span><br><span class="line"><span class="comment"># fe00::0    ip6-localnet</span></span><br><span class="line"><span class="comment"># ff00::0    ip6-mcastprefix</span></span><br><span class="line"><span class="comment"># ff02::1    ip6-allnodes</span></span><br><span class="line"><span class="comment"># ff02::2    ip6-allrouters</span></span><br><span class="line"><span class="comment"># 172.17.0.3    tomcat02 2d12d505984e</span></span><br><span class="line"><span class="comment"># 172.17.0.4    4adfd9b9e4a5</span></span><br><span class="line"></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># CONTAINER ID   IMAGE     COMMAND             CREATED             STATUS             PORTS                     NAMES</span></span><br><span class="line"><span class="comment"># 4ccaa4545718   tomcat    &quot;catalina.sh run&quot;   15 minutes ago      Up 15 minutes      0.0.0.0:55004-&gt;8080/tcp   tomcat03</span></span><br><span class="line"><span class="comment"># c5012b364397   tomcat    &quot;catalina.sh run&quot;   17 minutes ago      Up 17 minutes      0.0.0.0:55003-&gt;8080/tcp   tomcat02</span></span><br><span class="line"><span class="comment"># 3bf7596cfde9   tomcat    &quot;catalina.sh run&quot;   About an hour ago   Up About an hour   0.0.0.0:55002-&gt;8080/tcp   tomcat01</span></span><br></pre></td></tr></table></figure>

<p>本质：–link 就是在 hosts 中增加了一个域名劫持效果，但是现在这种做法已经<strong>不推荐了！！！</strong></p>
<h2 id="自定义网络"><a href="#自定义网络" class="headerlink" title="自定义网络"></a>自定义网络</h2><p>通过自定义网络可以达到容器互联的效果</p>
<p>网络模式：</p>
<ul>
<li>brige: 桥接模式 - 默认</li>
<li>none: 不配置</li>
<li>host: 和宿主机共享网络</li>
<li>container: 容器网络连通 - 用的少，局限大</li>
</ul>
<p>我们使用命令 <code>docker run -d -P --name tomcat01 tomcat</code> 创建容器时，会默认带有 <code>--net bridge</code> 的参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --driver bridge 桥接模式</span></span><br><span class="line"><span class="comment"># --subnet 192.168.0.0/16 子网掩码</span></span><br><span class="line"><span class="comment"># --gateway 192.168.0.1 网关</span></span><br><span class="line">docker network create --driver bridge --subnet 192.168.0.0/16 --gateway 192.168.0.1 mynet       <span class="comment"># 创建自定义网络</span></span><br><span class="line"></span><br><span class="line">docker network ls                                                                        </span><br><span class="line"><span class="comment"># NETWORK ID          NAME                DRIVER              SCOPE</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># 5a8dc0f2df06        mynet               bridge              local</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">docker network inspect mynet       </span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;mynet&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Id&quot;: &quot;5a8dc0f2df0667684167d7e219c53f4657ae4d89690afef54659080ddbc52e1e&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Created&quot;: &quot;2021-04-27T17:55:26.42981439+08:00&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Scope&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;bridge&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EnableIPv6&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;IPAM&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;Driver&quot;: &quot;default&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;Options&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">#             &quot;Config&quot;: [</span></span><br><span class="line"><span class="comment">#                 &#123;</span></span><br><span class="line"><span class="comment">#                     &quot;Subnet&quot;: &quot;192.168.0.0/16&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;Gateway&quot;: &quot;192.168.0.1&quot;</span></span><br><span class="line"><span class="comment">#                 &#125;</span></span><br><span class="line"><span class="comment">#             ]</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Internal&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;Attachable&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;Containers&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Options&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Labels&quot;: &#123;&#125;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加容器到自定义网络</span></span><br><span class="line">docker run -d -P --name tomcat01 --net mynet tomcat         </span><br><span class="line">docker run -d -P --name tomcat02 --net mynet tomcat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次查看 mynet 信息可以看到新建容器已经加入到网络中</span></span><br><span class="line">docker network inspect mynet                       </span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#  ...   </span></span><br><span class="line"><span class="comment"># &quot;Containers&quot;: &#123;</span></span><br><span class="line"><span class="comment">#     &quot;4075fa56e6edc165fead5290085747455d5fbe2ad7bafc06e62a118c481b3f5b&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;793ff48b6a30c18e2f4372e99bb0bb06ea830a609bfd1b4fb9292e8b3dd77326&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:03&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;192.168.0.3/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &quot;b8e4896497b05f77ae5e3c5c3cc998500d68dc4eb2cdad2702fa90e33fd56b28&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat01&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;23f5a636ccf43e96b1734bd5572dcc2c53997dbf8087bf04474433fe645bf40e&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;192.168.0.2/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># &#125;,</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat02 ping tomcat01              <span class="comment"># 重复之前 --link 的实验，容器间通过 name 互相 ping. 自定义网络虽然没有特殊设置，但是可以直接通过 name 连接</span></span><br><span class="line"><span class="comment"># PING tomcat01 (192.168.0.2) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat01.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.206 ms</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat01.mynet (192.168.0.2): icmp_seq=2 ttl=64 time=0.294 ms</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat01 ping tomcat02</span><br><span class="line"><span class="comment"># PING tomcat02 (192.168.0.3) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat02.mynet (192.168.0.3): icmp_seq=1 ttl=64 time=0.170 ms</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat02.mynet (192.168.0.3): icmp_seq=2 ttl=64 time=0.290 ms</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义网络 docker 已经帮我们维护好了对应关系，推荐使用</span></span><br><span class="line"><span class="comment"># 比如 redis, mysql 集群网络互相隔离，保证集群的安全和健康</span></span><br></pre></td></tr></table></figure>

<h2 id="网络联通"><a href="#网络联通" class="headerlink" title="网络联通"></a>网络联通</h2><p>如何让一个容器连接到另一个网络，比如 docker0 中的 容器连接到 mynet</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认 docker0 网络下新建测试容器 tomcat03</span></span><br><span class="line">docker run -d -P --name tomcat03 tomcat </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker network connect --<span class="built_in">help</span>           <span class="comment"># 查看使用方式</span></span><br><span class="line"><span class="comment"># Usage:  docker network connect [OPTIONS] NETWORK CONTAINER</span></span><br><span class="line"><span class="comment"># Connect a container to a network</span></span><br><span class="line"><span class="comment"># Options:</span></span><br><span class="line"><span class="comment">#       --alias strings           Add network-scoped alias for the container</span></span><br><span class="line"><span class="comment">#       --driver-opt strings      driver options for the network</span></span><br><span class="line"><span class="comment">#       --ip string               IPv4 address (e.g., 172.30.100.104)</span></span><br><span class="line"><span class="comment">#       --ip6 string              IPv6 address (e.g., 2001:db8::33)</span></span><br><span class="line"><span class="comment">#       --link list               Add link to another container</span></span><br><span class="line"><span class="comment">#       --link-local-ip strings   Add a link-local address for the container</span></span><br><span class="line"></span><br><span class="line">docker network connect mynet tomcat03</span><br><span class="line"></span><br><span class="line">docker network inspect mynet            <span class="comment"># 再次查看 mynet 信息，可以看到 tomcat3 已经加入网络，即一个容器两个地址</span></span><br><span class="line"><span class="comment"># &quot;Containers&quot;: &#123;</span></span><br><span class="line"><span class="comment">#     &quot;4075fa56e6edc165fead5290085747455d5fbe2ad7bafc06e62a118c481b3f5b&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;793ff48b6a30c18e2f4372e99bb0bb06ea830a609bfd1b4fb9292e8b3dd77326&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:03&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;192.168.0.3/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &quot;76c7258757f99e4d4efc565f5e305452277fdd700a783a5387c71b54275df506&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat03&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;fbad841162867dfc73872cfa997ef99c099fde95e8b58de76ca9ccdb3ff4359e&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:04&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;192.168.0.4/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &quot;b8e4896497b05f77ae5e3c5c3cc998500d68dc4eb2cdad2702fa90e33fd56b28&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat01&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;23f5a636ccf43e96b1734bd5572dcc2c53997dbf8087bf04474433fe645bf40e&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;192.168.0.2/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># &#125;,</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat01 ping tomcat03              <span class="comment"># tomcat01, 03 互 ping 测试</span></span><br><span class="line"><span class="comment"># PING tomcat03 (192.168.0.4) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat03.mynet (192.168.0.4): icmp_seq=1 ttl=64 time=0.131 ms</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat03.mynet (192.168.0.4): icmp_seq=2 ttl=64 time=0.123 ms</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat03 ping tomcat01</span><br><span class="line"><span class="comment"># PING tomcat01 (192.168.0.2) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat01.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.085 ms</span></span><br></pre></td></tr></table></figure>

<h2 id="实战：部署-Redis-集群"><a href="#实战：部署-Redis-集群" class="headerlink" title="实战：部署 Redis 集群"></a>实战：部署 Redis 集群</h2><p>部署三主三从节点</p>
<p><img src="redis.png" alt="redis"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet 172.38.0.0/16 redis          <span class="comment"># 创建 redis 网络</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将下面的内容放入 redis.sh 使用 sh redis.sh 创建配置文件</span></span><br><span class="line"><span class="comment">################# SH START #################</span></span><br><span class="line"><span class="keyword">for</span> port <span class="keyword">in</span> $(seq 1 6); \</span><br><span class="line"><span class="keyword">do</span> \</span><br><span class="line">mkdir -p /root/mydata/redis/node-<span class="variable">$&#123;port&#125;</span>/conf</span><br><span class="line">touch /root/mydata/redis/node-<span class="variable">$&#123;port&#125;</span>/conf/redis.conf</span><br><span class="line">cat  EOF &gt; /root/mydata/redis/node-<span class="variable">$&#123;port&#125;</span>/conf/redis.conf</span><br><span class="line">port 6379 </span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">cluster-enabled yes </span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.38.0.1<span class="variable">$&#123;port&#125;</span></span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly yes</span><br><span class="line">EOF</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">################# SH END #################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 redis 节点示例</span></span><br><span class="line">docker run -p 6371:6379 -p 16371:16379 --name redis-1 \</span><br><span class="line">-v /root/mydata/redis/node-1/data:/data \</span><br><span class="line">-v /root/mydata/redis/node-1/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d --net redis --ip 172.38.0.11 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 shell 脚本创建所有 redis 容器</span></span><br><span class="line"><span class="comment">################# SH START #################</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> $(seq 1 6); \</span><br><span class="line"><span class="keyword">do</span> \</span><br><span class="line">docker run -p 637<span class="variable">$&#123;n&#125;</span>:6379 -p 1637<span class="variable">$&#123;n&#125;</span>:16379 --name redis-<span class="variable">$&#123;n&#125;</span> \</span><br><span class="line">-v /root/mydata/redis/node-<span class="variable">$&#123;n&#125;</span>/data:/data \</span><br><span class="line">-v /root/mydata/redis/node-<span class="variable">$&#123;n&#125;</span>/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d --net redis --ip 172.38.0.1<span class="variable">$&#123;n&#125;</span> redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">################# SH END #################</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-1 /bin/sh         <span class="comment"># 进入 redis 容器, redis 容器中并没有 bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建集群</span></span><br><span class="line">redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379 172.38.0.16:6379 --cluster-replicas 1</span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span></span><br><span class="line"><span class="comment"># Master[0] -&gt; Slots 0 - 5460</span></span><br><span class="line"><span class="comment"># Master[1] -&gt; Slots 5461 - 10922</span></span><br><span class="line"><span class="comment"># Master[2] -&gt; Slots 10923 - 16383</span></span><br><span class="line"><span class="comment"># Adding replica 172.38.0.15:6379 to 172.38.0.11:6379</span></span><br><span class="line"><span class="comment"># Adding replica 172.38.0.16:6379 to 172.38.0.12:6379</span></span><br><span class="line"><span class="comment"># Adding replica 172.38.0.14:6379 to 172.38.0.13:6379</span></span><br><span class="line"><span class="comment"># M: 4abbca8e1511fc4a04e8b410e35a93af1392bc62 172.38.0.11:6379</span></span><br><span class="line"><span class="comment">#    slots:[0-5460] (5461 slots) master</span></span><br><span class="line"><span class="comment"># M: 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 172.38.0.12:6379</span></span><br><span class="line"><span class="comment">#    slots:[5461-10922] (5462 slots) master</span></span><br><span class="line"><span class="comment"># M: 0d6d16438bcb68bf89109b2e91dc6b71208ea113 172.38.0.13:6379</span></span><br><span class="line"><span class="comment">#    slots:[10923-16383] (5461 slots) master</span></span><br><span class="line"><span class="comment"># S: c47e77a26e9c1186b489003c00f1a9c647e913c2 172.38.0.14:6379</span></span><br><span class="line"><span class="comment">#    replicates 0d6d16438bcb68bf89109b2e91dc6b71208ea113</span></span><br><span class="line"><span class="comment"># S: 69fa6ac41672b325cfce023353ea3a35181ca873 172.38.0.15:6379</span></span><br><span class="line"><span class="comment">#    replicates 4abbca8e1511fc4a04e8b410e35a93af1392bc62</span></span><br><span class="line"><span class="comment"># S: c7b681f08fbbe568c5fcb2bddf88660ec3d217bf 172.38.0.16:6379</span></span><br><span class="line"><span class="comment">#    replicates 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c</span></span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">&#x27;yes&#x27;</span> to accept): yes</span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span><br><span class="line"><span class="comment"># Waiting for the cluster to join</span></span><br><span class="line"><span class="comment"># ....</span></span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Performing Cluster Check (using node 172.38.0.11:6379)</span></span><br><span class="line"><span class="comment"># M: 4abbca8e1511fc4a04e8b410e35a93af1392bc62 172.38.0.11:6379</span></span><br><span class="line"><span class="comment">#    slots:[0-5460] (5461 slots) master</span></span><br><span class="line"><span class="comment">#    1 additional replica(s)</span></span><br><span class="line"><span class="comment"># S: c47e77a26e9c1186b489003c00f1a9c647e913c2 172.38.0.14:6379</span></span><br><span class="line"><span class="comment">#    slots: (0 slots) slave</span></span><br><span class="line"><span class="comment">#    replicates 0d6d16438bcb68bf89109b2e91dc6b71208ea113</span></span><br><span class="line"><span class="comment"># M: 0d6d16438bcb68bf89109b2e91dc6b71208ea113 172.38.0.13:6379</span></span><br><span class="line"><span class="comment">#    slots:[10923-16383] (5461 slots) master</span></span><br><span class="line"><span class="comment">#    1 additional replica(s)</span></span><br><span class="line"><span class="comment"># M: 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 172.38.0.12:6379</span></span><br><span class="line"><span class="comment">#    slots:[5461-10922] (5462 slots) master</span></span><br><span class="line"><span class="comment">#    1 additional replica(s)</span></span><br><span class="line"><span class="comment"># S: 69fa6ac41672b325cfce023353ea3a35181ca873 172.38.0.15:6379</span></span><br><span class="line"><span class="comment">#    slots: (0 slots) slave</span></span><br><span class="line"><span class="comment">#    replicates 4abbca8e1511fc4a04e8b410e35a93af1392bc62</span></span><br><span class="line"><span class="comment"># S: c7b681f08fbbe568c5fcb2bddf88660ec3d217bf 172.38.0.16:6379</span></span><br><span class="line"><span class="comment">#    slots: (0 slots) slave</span></span><br><span class="line"><span class="comment">#    replicates 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c</span></span><br><span class="line"><span class="comment"># [OK] All nodes agree about slots configuration.</span></span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Check for open slots...</span></span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Check slots coverage...</span></span><br><span class="line"><span class="comment"># [OK] All 16384 slots covered.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line">redis-cli -c </span><br><span class="line"><span class="comment"># 127.0.0.1:6379&gt; cluster info</span></span><br><span class="line"><span class="comment"># cluster_state:ok</span></span><br><span class="line"><span class="comment"># cluster_slots_assigned:16384</span></span><br><span class="line"><span class="comment"># cluster_slots_ok:16384</span></span><br><span class="line"><span class="comment"># cluster_slots_pfail:0</span></span><br><span class="line"><span class="comment"># cluster_slots_fail:0</span></span><br><span class="line"><span class="comment"># cluster_known_nodes:6</span></span><br><span class="line"><span class="comment"># cluster_size:3</span></span><br><span class="line"><span class="comment"># cluster_current_epoch:6</span></span><br><span class="line"><span class="comment"># cluster_my_epoch:1</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_ping_sent:203</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_pong_sent:201</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_sent:404</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_ping_received:196</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_pong_received:203</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_meet_received:5</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_received:404</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; cluster nodes </span><br><span class="line"><span class="comment"># (error) ERR Unknown subcommand or wrong number of arguments for &#x27;noes&#x27;. Try CLUSTER HELP.</span></span><br><span class="line"><span class="comment"># 127.0.0.1:6379&gt; cluster nodes </span></span><br><span class="line"><span class="comment"># c47e77a26e9c1186b489003c00f1a9c647e913c2 172.38.0.14:6379@16379 slave 0d6d16438bcb68bf89109b2e91dc6b71208ea113 0 1619257734941 4 connected</span></span><br><span class="line"><span class="comment"># 0d6d16438bcb68bf89109b2e91dc6b71208ea113 172.38.0.13:6379@16379 master - 0 1619257736000 3 connected 10923-16383</span></span><br><span class="line"><span class="comment"># 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 172.38.0.12:6379@16379 master - 0 1619257736471 2 connected 5461-10922</span></span><br><span class="line"><span class="comment"># 4abbca8e1511fc4a04e8b410e35a93af1392bc62 172.38.0.11:6379@16379 myself,master - 0 1619257734000 1 connected 0-5460</span></span><br><span class="line"><span class="comment"># 69fa6ac41672b325cfce023353ea3a35181ca873 172.38.0.15:6379@16379 slave 4abbca8e1511fc4a04e8b410e35a93af1392bc62 0 1619257735453 5 connected</span></span><br><span class="line"><span class="comment"># c7b681f08fbbe568c5fcb2bddf88660ec3d217bf 172.38.0.16:6379@16379 slave 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 0 1619257735554 6 connected</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> a b             <span class="comment"># 从 log 看出，值存到了 13 节点中，下面将 13 节点容器 stop, 通过 get 测试备份是否生效</span></span><br><span class="line"><span class="comment"># -&gt; Redirected to slot [15495] located at 172.38.0.13:6379</span></span><br><span class="line"><span class="comment"># OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启一个新的终端，查看 13 节点信息</span></span><br><span class="line">docker inspect redis</span><br><span class="line"><span class="comment"># &quot;319cc5bc69cf7d6875a7244b089f832e800d21f1de9d1b24a09367a2e368ea60&quot;: &#123;</span></span><br><span class="line"><span class="comment">#     &quot;Name&quot;: &quot;redis-3&quot;,</span></span><br><span class="line"><span class="comment">#     &quot;EndpointID&quot;: &quot;4419d36052f0849869b8227db835b9cffb0e053ba593730c0f76904a9465fa92&quot;,</span></span><br><span class="line"><span class="comment">#     &quot;MacAddress&quot;: &quot;02:42:ac:26:00:0d&quot;,</span></span><br><span class="line"><span class="comment">#     &quot;IPv4Address&quot;: &quot;172.38.0.13/16&quot;,</span></span><br><span class="line"><span class="comment">#     &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">docker stop redis-3</span><br><span class="line"></span><br><span class="line">172.38.0.13:6379&gt; get a             <span class="comment"># 回到原来的终端进行 get 操作</span></span><br><span class="line"><span class="comment"># Error: Operation timed out</span></span><br><span class="line"><span class="comment"># /data #                           # 默认直接从原来的 13 节点拿了，服务停了，回到了 11 节点的 data 目录，再通过 redis-cli -c 进去集群终端 get a 信息从 14 节点，备份节点返回</span></span><br><span class="line"></span><br><span class="line">redis-cli -c</span><br><span class="line">127.0.0.1:6379&gt; get a               <span class="comment"># 从 log 可以看到值是从备份节点 14 拿到的</span></span><br><span class="line"><span class="comment"># -&gt; Redirected to slot [15495] located at 172.38.0.14:6379</span></span><br><span class="line"><span class="comment"># &quot;b&quot;</span></span><br><span class="line"></span><br><span class="line">172.38.0.14:6379&gt; cluster nodes     <span class="comment"># 通过 nodes 命令查看节点信息可以看到 13 挂了 172.38.0.13:6379@16379 master,fail, slave 直接翻身农奴把歌唱</span></span><br><span class="line"><span class="comment"># 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 172.38.0.12:6379@16379 master - 0 1619258378445 2 connected 5461-10922</span></span><br><span class="line"><span class="comment"># 0d6d16438bcb68bf89109b2e91dc6b71208ea113 172.38.0.13:6379@16379 master,fail - 1619258032356 1619258031341 3 connected</span></span><br><span class="line"><span class="comment"># c47e77a26e9c1186b489003c00f1a9c647e913c2 172.38.0.14:6379@16379 myself,master - 0 1619258377000 7 connected 10923-16383</span></span><br><span class="line"><span class="comment"># 4abbca8e1511fc4a04e8b410e35a93af1392bc62 172.38.0.11:6379@16379 master - 0 1619258377432 1 connected 0-5460</span></span><br><span class="line"><span class="comment"># c7b681f08fbbe568c5fcb2bddf88660ec3d217bf 172.38.0.16:6379@16379 slave 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 0 1619258377533 6 connected</span></span><br><span class="line"><span class="comment"># 69fa6ac41672b325cfce023353ea3a35181ca873 172.38.0.15:6379@16379 slave 4abbca8e1511fc4a04e8b410e35a93af1392bc62 0 1619258376415 5 connected</span></span><br></pre></td></tr></table></figure>

<h2 id="SpringBoot-微服务打包-Docker-镜像"><a href="#SpringBoot-微服务打包-Docker-镜像" class="headerlink" title="SpringBoot 微服务打包 Docker 镜像"></a>SpringBoot 微服务打包 Docker 镜像</h2><ol>
<li>构建 springboot 的 helloword 项目</li>
<li>打包应用</li>
<li>编写 dockerfile</li>
<li>构建镜像</li>
<li>发布运行</li>
</ol>
<p>到 Spring Initializr 去打包一个 Hello Word demo 进行测试</p>
<p>Application 同级建一个 controller 文件夹，其下创建 HelloController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello from springboot.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>右键运行 application，访问 localhost:8080/hello 得到字符串</p>
<p>maven task -&gt; Lifecycle -&gt; package 打包工程, jar 包会生成在 target 目录下</p>
<p>右键 open in terminal, 运行 <code>java -jar demo-0.0.1-SNAPSHOT.jar</code> 测试 jar 包是否能正常工作</p>
<p>在 target 目录下新建 Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> *.jar /app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;--server.port=8080&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>在 target 目录下 build image <code>docker build -t myspringapp .</code></p>
<p>等待结束后查看新建是否成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker images </span><br><span class="line"><span class="comment"># REPOSITORY                                          TAG                IMAGE ID       CREATED              SIZE</span></span><br><span class="line"><span class="comment"># myspringapp                                         latest             8b39ad3c5928   About a minute ago   660MB</span></span><br></pre></td></tr></table></figure>

<p>测试运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一次忘了加 -P 导致容器端口没有暴露出来，直接就不能访问了</span></span><br><span class="line">docker run -d -P --name spapp myspringapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看映射地址</span></span><br><span class="line">docker ps</span><br><span class="line"><span class="comment"># CONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS         PORTS                     NAMES</span></span><br><span class="line"><span class="comment"># 0b4da52a4593   myspringapp   &quot;java -jar /app.jar …&quot;   3 seconds ago   Up 2 seconds   0.0.0.0:55010-&gt;8080/tcp   spapp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问测试</span></span><br><span class="line">curl localhost:55010/hello</span><br><span class="line"><span class="comment"># Hello from springboot.</span></span><br></pre></td></tr></table></figure>

<h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p>Dockerfile 单个容器，Docker Compose 定义运行多个容器</p>
<p>Using Compose is basically a three-step process:</p>
<ol>
<li>Define your app’s environment with a Dockerfile so it can be reproduced anywhere.</li>
<li>Define the services that make up your app in <code>docker-compose.yml</code> so they can be run together in an isolated environment.</li>
<li>Run <code>docker compose up</code> and the Docker compose command starts and runs your entire app. You can alternatively run docker-compose up using the docker-compose binary.</li>
</ol>
<p>重要概念：</p>
<ul>
<li>服务 services, 容器，应用（web, redis…）</li>
<li>项目 project，一组关联的容器</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>Mac 的 docker-compose 工具集是和客户端整合在一起的，所以不需要单独安装，直接可以使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker-compose version</span><br><span class="line"><span class="comment"># docker-compose version 1.28.5, build c4eb3a1f</span></span><br><span class="line"><span class="comment"># docker-py version: 4.4.4</span></span><br><span class="line"><span class="comment"># CPython version: 3.9.0</span></span><br><span class="line"><span class="comment"># OpenSSL version: OpenSSL 1.1.1h  22 Sep 202</span></span><br></pre></td></tr></table></figure>

<p>Linux 安装</p>
<ol>
<li>从 github 下载(源文件)[sudo curl -L “<a target="_blank" rel="noopener" href="https://github.com/docker/compose/releases/download/1.29.1/docker-compose-$">https://github.com/docker/compose/releases/download/1.29.1/docker-compose-$</a>(uname -s)-$(uname -m)” -o /usr/local/bin/docker-compose]</li>
<li>修改权限 <code>sudo chmod +x /usr/local/bin/docker-compose</code></li>
<li>测试运行 <code>docker compose --version</code></li>
</ol>
<h2 id="官方起步教程"><a href="#官方起步教程" class="headerlink" title="官方起步教程"></a>官方起步教程</h2><ol>
<li>写应用</li>
<li>Dockerfile 应用打包为镜像</li>
<li>Docker-compose yaml 文件整合所有 services</li>
<li>启动 compose 项目(docker-compose up .)</li>
</ol>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br><span class="line"></span><br><span class="line"># 创建网络</span><br><span class="line">Creating network &quot;composetest_default&quot; with the default driver</span><br><span class="line"></span><br><span class="line"># 根据 compose 文件构建</span><br><span class="line">Building web</span><br><span class="line">[+] Building 19.7s (13/13) FINISHED                                                                                  </span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                                            0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 324B                                                                            0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                               0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                 0.0s</span><br><span class="line"> =&gt; resolve image config for docker.io/docker/dockerfile:1                                                      3.6s</span><br><span class="line"> =&gt; docker-image://docker.io/docker/dockerfile:1@sha256:e2a8561e419ab1ba6b2fe6cbdf49fd92b95912df1cf7d313c3e2230a333fdbcc                                          1.5s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/docker/dockerfile:1@sha256:e2a8561e419ab1ba6b2fe6cbdf49fd92b95912df1cf7d313c3e2230a333fdbcc                                              0.0s</span><br><span class="line"> =&gt; =&gt; sha256:e2a8561e419ab1ba6b2fe6cbdf49fd92b95912df1cf7d313c3e2230a333fdbcc 1.69kB / 1.69kB                  0.0s</span><br><span class="line"> =&gt; =&gt; sha256:e3ee2e6b536452d876b1c5aa12db9bca51b8f52b2505178cae6d13e33daeed2b 528B / 528B                      0.0s</span><br><span class="line"> =&gt; =&gt; sha256:86e43bba076d67c1a890cbc07813806b11eca53843dc643202d939b986c8c332 1.21kB / 1.21kB                  0.0s</span><br><span class="line"> =&gt; =&gt; sha256:3cc8e449ce9f6e0752ede8f50a7334bf0c7b2d24d76da2ffae7aa6a729dd1da4 9.64MB / 9.64MB                  0.8s</span><br><span class="line"> =&gt; =&gt; extracting sha256:3cc8e449ce9f6e0752ede8f50a7334bf0c7b2d24d76da2ffae7aa6a729dd1da4                       0.3s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/python:3.7-alpine                                            2.7s</span><br><span class="line"> =&gt; [1/6] FROM docker.io/library/python:3.7-alpine@sha256:3b0e1a61106a4c73d1253a86b7765b41d87d1122eb70f99c6de06f0b64edc434                                        2.2s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/library/python:3.7-alpine@sha256:3b0e1a61106a4c73d1253a86b7765b41d87d1122eb70f99c6de06f0b64edc434                                        0.0s</span><br><span class="line"> =&gt; =&gt; sha256:a7ad1a75a9998a18ceb4b3e77ebc933525c48a5e9b1dd6abf258e86f537a7fbf 281.27kB / 281.27kB              0.6s</span><br><span class="line"> =&gt; =&gt; sha256:37ce6546d5dd0143d2fd48adccb48cd0f46c5c2587ce49a53fbd9bd1c5816665 10.57MB / 10.57MB                1.1s</span><br><span class="line"> =&gt; =&gt; sha256:3b0e1a61106a4c73d1253a86b7765b41d87d1122eb70f99c6de06f0b64edc434 1.65kB / 1.65kB                  0.0s</span><br><span class="line"> =&gt; =&gt; sha256:d7c477920ed69ca5744ae133810c519a5ea72ab2da3edf542375d48e10742720 1.37kB / 1.37kB                  0.0s</span><br><span class="line"> =&gt; =&gt; sha256:c46f62f378d72f9a78c4fb150000c479f2bf9095f5616b9f85a8387437e7592c 7.85kB / 7.85kB                  0.0s</span><br><span class="line"> =&gt; =&gt; sha256:540db60ca9383eac9e418f78490994d0af424aab7bf6d0e47ac8ed4e2e9bcbba 2.81MB / 2.81MB                  0.5s</span><br><span class="line"> =&gt; =&gt; extracting sha256:540db60ca9383eac9e418f78490994d0af424aab7bf6d0e47ac8ed4e2e9bcbba                       0.2s</span><br><span class="line"> =&gt; =&gt; sha256:ec9e91bed5a295437fbb8a07b8af46fd69d7dd5beb7ac009c839292454bb3d31 234B / 234B                      1.0s</span><br><span class="line"> =&gt; =&gt; sha256:c629b5f73da8f1113e9c8257d16fc65a95b812483506f56e418183e0d618f07e 2.16MB / 2.16MB                  1.3s</span><br><span class="line"> =&gt; =&gt; extracting sha256:a7ad1a75a9998a18ceb4b3e77ebc933525c48a5e9b1dd6abf258e86f537a7fbf                       0.1s</span><br><span class="line"> =&gt; =&gt; extracting sha256:37ce6546d5dd0143d2fd48adccb48cd0f46c5c2587ce49a53fbd9bd1c5816665                       0.5s</span><br><span class="line"> =&gt; =&gt; extracting sha256:ec9e91bed5a295437fbb8a07b8af46fd69d7dd5beb7ac009c839292454bb3d31                       0.0s</span><br><span class="line"> =&gt; =&gt; extracting sha256:c629b5f73da8f1113e9c8257d16fc65a95b812483506f56e418183e0d618f07e                       0.2s</span><br><span class="line"> =&gt; [internal] load build context                                                                               0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 1.08kB                                                                             0.0s</span><br><span class="line"> =&gt; [2/6] WORKDIR /code                                                                                         0.1s</span><br><span class="line"> =&gt; [3/6] RUN apk add --no-cache gcc musl-dev linux-headers                                                     3.8s</span><br><span class="line"> =&gt; [4/6] COPY requirements.txt requirements.txt                                                                0.0s</span><br><span class="line"> =&gt; [5/6] RUN pip install -r requirements.txt                                                                   4.7s</span><br><span class="line"> =&gt; [6/6] COPY . .                                                                                              0.0s</span><br><span class="line"> =&gt; exporting to image                                                                                          0.7s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                         0.7s</span><br><span class="line"> =&gt; =&gt; writing image sha256:fa0cb4f4c056d1b79ddddb5ec6e21659cb3d84cad4a28d361775161cbe281811                    0.0s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/composetest_web                                                              0.0s</span><br><span class="line">Successfully built fa0cb4f4c056d1b79ddddb5ec6e21659cb3d84cad4a28d361775161cbe281811</span><br><span class="line">WARNING: Image for service web was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.</span><br><span class="line">Pulling redis (redis:alpine)...</span><br><span class="line">alpine: Pulling from library/redis</span><br><span class="line">540db60ca938: Already exists</span><br><span class="line">29712d301e8c: Pull complete</span><br><span class="line">8173c12df40f: Pull complete</span><br><span class="line">0be901b3c77d: Pull complete</span><br><span class="line">c33773bf45b4: Pull complete</span><br><span class="line">6eeb0c30f7e7: Pull complete</span><br><span class="line">Digest: sha256:f9577ac6e68c70b518e691406f2bebee49d8db22118fc87bad3b39c16a1cb46e</span><br><span class="line">Status: Downloaded newer image for redis:alpine</span><br><span class="line">Creating composetest_web_1   ... done</span><br><span class="line">Creating composetest_redis_1 ... done</span><br><span class="line">Attaching to composetest_redis_1, composetest_web_1</span><br><span class="line">redis_1  | 1:C 25 Apr 2021 06:45:13.848 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">redis_1  | 1:C 25 Apr 2021 06:45:13.848 # Redis version=6.2.2, bits=64, commit=00000000, modified=0, pid=1, just started</span><br><span class="line">redis_1  | 1:C 25 Apr 2021 06:45:13.848 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf</span><br><span class="line">redis_1  | 1:M 25 Apr 2021 06:45:13.849 * monotonic clock: POSIX clock_gettime</span><br><span class="line">redis_1  | 1:M 25 Apr 2021 06:45:13.849 * Running mode=standalone, port=6379.</span><br><span class="line">redis_1  | 1:M 25 Apr 2021 06:45:13.849 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">redis_1  | 1:M 25 Apr 2021 06:45:13.849 # Server initialized</span><br><span class="line">redis_1  | 1:M 25 Apr 2021 06:45:13.850 * Ready to accept connections</span><br><span class="line">web_1    |  * Serving Flask app &quot;app.py&quot;</span><br><span class="line">web_1    |  * Environment: production</span><br><span class="line">web_1    |    WARNING: This is a development server. Do not use it in a production deployment.</span><br><span class="line">web_1    |    Use a production WSGI server instead.</span><br><span class="line">web_1    |  * Debug mode: off</span><br><span class="line">web_1    |  * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)</span><br><span class="line">web_1    | 172.20.0.1 - - [25/Apr/2021 06:45:42] &quot;GET / HTTP/1.1&quot; 200 -</span><br><span class="line">web_1    | 172.20.0.1 - - [25/Apr/2021 06:45:42] &quot;GET /favicon.ico HTTP/1.1&quot; 404 -</span><br><span class="line">web_1    | 172.20.0.1 - - [25/Apr/2021 06:45:46] &quot;GET / HTTP/1.1&quot; 200 -</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line"><span class="comment"># CONTAINER ID   IMAGE             COMMAND                  CREATED         STATUS         PORTS                    NAMES</span></span><br><span class="line"><span class="comment"># 621dc8726fe9   composetest_web   &quot;flask run&quot;              8 minutes ago   Up 8 minutes   0.0.0.0:5000-&gt;5000/tcp   composetest_web_1</span></span><br><span class="line"><span class="comment"># 6945405369e2   redis:alpine      &quot;docker-entrypoint.s…&quot;   8 minutes ago   Up 8 minutes   6379/tcp                 composetest_redis_1</span></span><br><span class="line"></span><br><span class="line">docker network ls</span><br><span class="line"><span class="comment"># NETWORK ID     NAME                      DRIVER    SCOPE</span></span><br><span class="line"><span class="comment"># 39a92d7cce05   bridge                    bridge    local</span></span><br><span class="line"><span class="comment"># f713400ac914   composetest_default       bridge    local &lt;- compose 启动之后会创建一个对应的网络，和之前的 log 匹配</span></span><br><span class="line"></span><br><span class="line">docker network inspect composetest_default</span><br><span class="line"><span class="comment"># &quot;Containers&quot;: &#123;</span></span><br><span class="line"><span class="comment">#     &quot;621dc8726fe93265134ead255af6cd572f7a6d82a802a97edd53780248f749dd&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;composetest_web_1&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;000a2b25cc2ffc6b1d86eca556dd06cac05ff6bb70a2cd37d5cce4054559c993&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:ac:14:00:02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;172.20.0.2/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &quot;6945405369e252c5537743244ed60a7c740f713c20d1df4e0318cf929411f169&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;composetest_redis_1&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;857a5962c8220bd8972e6793c5ff521503b6e293d31155b8268a8949bfb4bb72&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:ac:14:00:03&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;172.20.0.3/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># &#125;,</span></span><br></pre></td></tr></table></figure>

<p>注意点：app 中 redis 是通过域名绑定的 <code>cache = redis.Redis(host=&#39;redis&#39;, port=6379)</code> 并不是指定 IP，这里已经用到了 docker 里面的网络了</p>
<h2 id="YAML-规则"><a href="#YAML-规则" class="headerlink" title="YAML 规则"></a>YAML 规则</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 3层</span><br><span class="line"></span><br><span class="line">version: &#x27;&#x27; # 版本</span><br><span class="line">services: # 服务</span><br><span class="line">    服务1: web</span><br><span class="line">        # 服务配置</span><br><span class="line">        images</span><br><span class="line">        build</span><br><span class="line">        network</span><br><span class="line">        ...</span><br><span class="line">    服务2: redis</span><br><span class="line">        ...</span><br><span class="line">    服务2: redis</span><br><span class="line">        ...</span><br><span class="line"># 其他配置 网络/卷，全局规则</span><br><span class="line">volumes:</span><br><span class="line">network:</span><br></pre></td></tr></table></figure>

<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>仿照官方的计数器，写一个 Java 版本的并 compose 启动</p>
<ol>
<li>写项目代码</li>
<li>dockerfile 构建镜像</li>
<li>docker-compose.yml 整合项目</li>
<li>上传服务器 docker-compose up . 启动</li>
</ol>
<p>通过 spring initializr 下载模版，将 spring web + spring data reactive redis 加入依赖</p>
<p>新建 controller 层代码, 目录结构如下</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── CounterApplication.java</span><br><span class="line">└── controller</span><br><span class="line">    └── HelloController.java</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Long views = redisTemplate.opsForValue().increment(<span class="string">&quot;views&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello, counter views: &quot;</span> + views;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置端口，由于配置的是 redis，所以本地启动的时候 redis 是会出问题的，docker 里才 OK</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server.port&#x3D;8080</span><br><span class="line">spring.redis.host&#x3D;redis</span><br></pre></td></tr></table></figure>

<p>maven -&gt; counter -&gt; Lifecycle -&gt; package 打包到 target folder 下</p>
<p>在 target 下新建 Dockerfile 和 docker-compose.yml</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> *.jar /app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;--server.port=8080&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">counterapp:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">counterapp</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;library/redis:alpine&quot;</span></span><br></pre></td></tr></table></figure>

<p>这个有一个东西很奇怪，其实在上面的 Dockerfile 里我是没有指定 docker image 叫什么， 但是下面的 compose file 里直接就拿到了。可能是下面的 <code>build .</code> 的意思是用但前文件加下的 Dockerfile 构建，并取名叫 counterapp </p>
<p>由于我本机就有环境，直接运行即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> target</span><br><span class="line">docker-compose up</span><br><span class="line"></span><br><span class="line"><span class="comment"># network 下会显示 folder 前缀的新网络</span></span><br><span class="line">docker network ls</span><br><span class="line"><span class="comment"># c2b31f70eead   target_default            bridge    local</span></span><br></pre></td></tr></table></figure>

<p>log 输出正常，访问页面正常</p>
<p><code>docker-compose --build</code> 重新构建</p>
<h2 id="Docker-Swarm"><a href="#Docker-Swarm" class="headerlink" title="Docker Swarm"></a>Docker Swarm</h2><p>PS：Mobaxtream multi-execution 简直是太酷炫了！！！</p>
<p>创建 4 个实例并安装 docker，准备实验环境</p>
<p><img src="how_node_work.png" alt="how node works"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">docker swarm --<span class="built_in">help</span>         <span class="comment"># 查看可用命令</span></span><br><span class="line"><span class="comment"># Usage:  docker swarm COMMAND</span></span><br><span class="line"><span class="comment"># Manage Swarm</span></span><br><span class="line"><span class="comment"># Options:</span></span><br><span class="line"><span class="comment">#       --help   Print usage</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Commands:</span></span><br><span class="line"><span class="comment">#   init        Initialize a swarm</span></span><br><span class="line"><span class="comment">#   join        Join a swarm as a node and/or manager</span></span><br><span class="line"><span class="comment">#   join-token  Manage join tokens</span></span><br><span class="line"><span class="comment">#   leave       Leave the swarm</span></span><br><span class="line"><span class="comment">#   unlock      Unlock swarm</span></span><br><span class="line"><span class="comment">#   unlock-key  Manage the unlock key</span></span><br><span class="line"><span class="comment">#   update      Update the swarm</span></span><br><span class="line"></span><br><span class="line">docker swarm init --<span class="built_in">help</span></span><br><span class="line"><span class="comment"># Usage:  docker swarm init [OPTIONS]</span></span><br><span class="line"><span class="comment"># Initialize a swarm</span></span><br><span class="line"><span class="comment"># Options:</span></span><br><span class="line"><span class="comment">#       --advertise-addr string           Advertised address (format: &lt;ip|interface&gt;[:port])</span></span><br><span class="line"><span class="comment">#       --autolock                        Enable manager autolocking (requiring an unlock key to start a stopped manager)</span></span><br><span class="line"><span class="comment">#       --cert-expiry duration            Validity period for node certificates (ns|us|ms|s|m|h) (default 2160h0m0s)</span></span><br><span class="line"><span class="comment">#       --dispatcher-heartbeat duration   Dispatcher heartbeat period (ns|us|ms|s|m|h) (default 5s)</span></span><br><span class="line"><span class="comment">#       --external-ca external-ca         Specifications of one or more certificate signing endpoints</span></span><br><span class="line"><span class="comment">#       --force-new-cluster               Force create a new cluster from current state</span></span><br><span class="line"><span class="comment">#       --help                            Print usage</span></span><br><span class="line"><span class="comment">#       --listen-addr node-addr           Listen address (format: &lt;ip|interface&gt;[:port]) (default 0.0.0.0:2377)</span></span><br><span class="line"><span class="comment">#       --max-snapshots uint              Number of additional Raft snapshots to retain</span></span><br><span class="line"><span class="comment">#       --snapshot-interval uint          Number of log entries between Raft snapshots (default 10000)</span></span><br><span class="line"><span class="comment">#       --task-history-limit int          Task history retention limit (default 5)</span></span><br><span class="line"></span><br><span class="line">docker swarm init --advertise-addr 172.28.231.215       <span class="comment"># 创建 swarm 集群，提供两个可用命令，一个用于添加 worker 节点，一个用于添加 manager 节点</span></span><br><span class="line"><span class="comment"># Swarm initialized: current node (abele1bkn04awsnvvfzj0dof2) is now a manager.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To add a worker to this swarm, run the following command:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     docker swarm join \</span></span><br><span class="line"><span class="comment">#     --token SWMTKN-1-2n1wgk8ws8ca2bz2kr5nkqefrngtizuum901cv7hmhgqnsjuc1-3gwzzivpm27xfqk8ddclf6fth \</span></span><br><span class="line"><span class="comment">#     172.28.231.215:2377</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To add a manager to this swarm, run &#x27;docker swarm join-token manager&#x27; and follow the instructions.</span></span><br><span class="line"></span><br><span class="line">docker node ls              <span class="comment"># 显示集群节点状态</span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2 *  iZuf6brcie4578p0e13tg9Z  Ready   Active        Leader</span></span><br><span class="line"></span><br><span class="line">docker swarm join \</span><br><span class="line">    --token SWMTKN-1-2n1wgk8ws8ca2bz2kr5nkqefrngtizuum901cv7hmhgqnsjuc1-3gwzzivpm27xfqk8ddclf6fth \</span><br><span class="line">    172.28.231.215:2377      <span class="comment"># 挑选一个可用节点，作为一个 worker 节点加入</span></span><br><span class="line"><span class="comment"># This node joined a swarm as a worker.</span></span><br><span class="line"></span><br><span class="line">docker node ls              <span class="comment"># 再次查看节点状态，节点加入成功   </span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># 9xujdtp2c7dob2t1o704tgwvl    iZuf6brcie4578p0e13tg8Z  Ready   Active</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2 *  iZuf6brcie4578p0e13tg9Z  Ready   Active        Leader</span></span><br><span class="line"></span><br><span class="line">docker swarm join-token manager     <span class="comment"># 生成 manager 节点 token</span></span><br><span class="line"><span class="comment"># To add a manager to this swarm, run the following command:</span></span><br><span class="line"><span class="comment">#     docker swarm join \</span></span><br><span class="line"><span class="comment">#     --token SWMTKN-1-2n1wgk8ws8ca2bz2kr5nkqefrngtizuum901cv7hmhgqnsjuc1-392uyq8gmjgp9dj484y8id8jq \</span></span><br><span class="line"><span class="comment">#     172.28.231.215:2377</span></span><br><span class="line"></span><br><span class="line">docker swarm join \</span><br><span class="line">&gt;     --token SWMTKN-1-2n1wgk8ws8ca2bz2kr5nkqefrngtizuum901cv7hmhgqnsjuc1-392uyq8gmjgp9dj484y8id8jq \</span><br><span class="line">&gt;     172.28.231.215:2377       <span class="comment"># 挑选一个可用节点，作为 manager 节点加入集群</span></span><br><span class="line"><span class="comment"># This node joined a swarm as a manager.</span></span><br></pre></td></tr></table></figure>

<h2 id="Raft-协议"><a href="#Raft-协议" class="headerlink" title="Raft 协议"></a>Raft 协议</h2><p>保证大多数节点存活才可用，只要 &gt;1， 集群则要求 &gt; 3</p>
<p>实验：双主双从的情况加，一个主机 down, 另一个主机还是不能使用，并不能达到备份的效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker       <span class="comment"># 停止一个 manager 节点</span></span><br><span class="line"></span><br><span class="line">docker node ls              <span class="comment"># 在另一个 manager 节点上显示 node 信息</span></span><br><span class="line"><span class="comment"># Error response from daemon: rpc error: code = 4 desc = context deadline exceeded</span></span><br><span class="line"></span><br><span class="line">systemctl start docker      <span class="comment"># 重启停止的节点</span></span><br><span class="line"></span><br><span class="line">docker node ls              <span class="comment"># manager 节点的主备节点互换了</span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># 9xujdtp2c7dob2t1o704tgwvl    iZuf6brcie4578p0e13tg8Z  Ready   Active</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2 *  iZuf6brcie4578p0e13tg9Z  Ready   Active        Reachable</span></span><br><span class="line"><span class="comment"># qr1s9a3q7h3j8dw48juw1emg4    myvm01                   Ready   Active        Leader</span></span><br><span class="line"><span class="comment"># y1gs7gsyuwoefjvmw8d9eswrm    iZuf6brcie4578p0e13tgaZ  Ready   Active</span></span><br><span class="line"></span><br><span class="line">docker swarm leave         <span class="comment"># 选取一个 worker 节点，起开集群</span></span><br><span class="line"></span><br><span class="line">docker node ls              <span class="comment"># manager 节点显示，上面的节点 down 了</span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># 9xujdtp2c7dob2t1o704tgwvl    iZuf6brcie4578p0e13tg8Z  Down    Active</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2 *  iZuf6brcie4578p0e13tg9Z  Ready   Active        Reachable</span></span><br><span class="line"><span class="comment"># qr1s9a3q7h3j8dw48juw1emg4    myvm01                   Ready   Active        Leader</span></span><br><span class="line"><span class="comment"># y1gs7gsyuwoefjvmw8d9eswrm    iZuf6brcie4578p0e13tgaZ  Ready   Active</span></span><br><span class="line"></span><br><span class="line">docker swarm join \</span><br><span class="line">     --token SWMTKN-1-2n1wgk8ws8ca2bz2kr5nkqefrngtizuum901cv7hmhgqnsjuc1-392uyq8gmjgp9dj484y8id8jq \</span><br><span class="line">     172.28.231.215:2377        <span class="comment"># 将其开的节点设置为 manger 节点</span></span><br><span class="line"><span class="comment"># This node joined a swarm as a manager.</span></span><br><span class="line"></span><br><span class="line">docker node ls                  <span class="comment"># 显示由三个 manager 节点</span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># 9xujdtp2c7dob2t1o704tgwvl    iZuf6brcie4578p0e13tg8Z  Down    Active</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2    iZuf6brcie4578p0e13tg9Z  Ready   Active        Reachable</span></span><br><span class="line"><span class="comment"># o97d3m17864yftbmq6kdaxel4 *  iZuf6brcie4578p0e13tg8Z  Ready   Active        Reachable</span></span><br><span class="line"><span class="comment"># qr1s9a3q7h3j8dw48juw1emg4    myvm01                   Ready   Active        Leader</span></span><br><span class="line"><span class="comment"># y1gs7gsyuwoefjvmw8d9eswrm    iZuf6brcie4578p0e13tgaZ  Ready   Active</span></span><br><span class="line"></span><br><span class="line">system stop  docker             <span class="comment"># 重复之前的实验，停止一个 manager 节点</span></span><br><span class="line"></span><br><span class="line">docker node ls                  <span class="comment"># 到备用 manager 节点，测试节点信息，可用</span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># 9xujdtp2c7dob2t1o704tgwvl    iZuf6brcie4578p0e13tg8Z  Down    Active</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2    iZuf6brcie4578p0e13tg9Z  Down    Active        Unreachable</span></span><br><span class="line"><span class="comment"># o97d3m17864yftbmq6kdaxel4    iZuf6brcie4578p0e13tg8Z  Ready   Active        Reachable</span></span><br><span class="line"><span class="comment"># qr1s9a3q7h3j8dw48juw1emg4 *  myvm01                   Ready   Active        Leader</span></span><br><span class="line"><span class="comment"># y1gs7gsyuwoefjvmw8d9eswrm    iZuf6brcie4578p0e13tgaZ  Ready   Active</span></span><br></pre></td></tr></table></figure>

<h2 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h2><p>docker-compose up 项目，单机</p>
<p>swarm 集群 services 高可用</p>
<p>容器 -&gt; 服务 -&gt; 副本</p>
<ul>
<li>docker run 容器启动，不能扩容</li>
<li>docker service 服务，可扩容</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker service</span><br><span class="line"><span class="comment"># Usage:  docker service COMMAND</span></span><br><span class="line"><span class="comment"># Manage services</span></span><br><span class="line"><span class="comment"># Options:</span></span><br><span class="line"><span class="comment">#       --help   Print usage</span></span><br><span class="line"><span class="comment"># Commands:</span></span><br><span class="line"><span class="comment">#   create      Create a new service</span></span><br><span class="line"><span class="comment">#   inspect     Display detailed information on one or more services</span></span><br><span class="line"><span class="comment">#   ls          List services</span></span><br><span class="line"><span class="comment">#   ps          List the tasks of a service</span></span><br><span class="line"><span class="comment">#   rm          Remove one or more services</span></span><br><span class="line"><span class="comment">#   scale       Scale one or multiple replicated services</span></span><br><span class="line"><span class="comment">#   update      Update a service</span></span><br><span class="line"><span class="comment"># Run &#x27;docker service COMMAND --help&#x27; for more information on a command.</span></span><br></pre></td></tr></table></figure>

<p>创建服务实践</p>
<ul>
<li>docker run: 单个容器, 不能扩缩容</li>
<li>docker service: 服务，可以扩缩容，可以滚动更新</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">docker service create -p 8888:80 --name my-nginx nginx      <span class="comment"># 创建服务</span></span><br><span class="line"></span><br><span class="line">docker service ps my-nginx</span><br><span class="line"><span class="comment"># ID            NAME        IMAGE         NODE    DESIRED STATE  CURRENT STATE               ERROR  PORTS</span></span><br><span class="line"><span class="comment"># yb78d9o2lsyp  my-nginx.1  nginx:latest  myvm01  Running        Running about a minute ago</span></span><br><span class="line"></span><br><span class="line">docker service ls</span><br><span class="line"><span class="comment"># ID            NAME      MODE        REPLICAS  IMAGE</span></span><br><span class="line"><span class="comment"># sgcat9l69srz  my-nginx  replicated  1/1       nginx:latest</span></span><br><span class="line"></span><br><span class="line">docker ps           <span class="comment"># 这个服务是随机创建在 manager 节点上的</span></span><br><span class="line"></span><br><span class="line">docker service update --replicas 3 my-nginx     <span class="comment"># 添加三个副本</span></span><br><span class="line"></span><br><span class="line">docker ps           <span class="comment"># 去各个节点上看可以看到如下信息，names 为 1-3</span></span><br><span class="line"><span class="comment"># CONTAINER ID        IMAGE                                                                           COMMAND                  CREATED             STATUS              PORTS               NAMES</span></span><br><span class="line"><span class="comment"># 902bbdf9eb3a        nginx@sha256:75a55d33ecc73c2a242450a9f1cc858499d468f077ea942867e662c247b5e412   &quot;/docker-entrypoin...&quot;   9 minutes ago       Up 9 minutes        80/tcp              my-nginx.1.yb78d9o2lsyp0wg7558vn0eew</span></span><br><span class="line"></span><br><span class="line">curl 172.28.231.213:8888        <span class="comment"># 挑选一个节点访问其他节点 nginx 服务，可达</span></span><br><span class="line"><span class="comment"># &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="comment"># &lt;html&gt;</span></span><br><span class="line"><span class="comment"># &lt;head&gt;</span></span><br><span class="line"><span class="comment"># &lt;title&gt;Welcome to nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="comment"># ....</span></span><br><span class="line"><span class="comment"># &lt;/body&gt;</span></span><br><span class="line"><span class="comment"># &lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line">docker service ls</span><br><span class="line"><span class="comment"># ID            NAME      MODE        REPLICAS  IMAGE</span></span><br><span class="line"><span class="comment"># sgcat9l69srz  my-nginx  replicated  10/10     nginx:latest</span></span><br><span class="line"></span><br><span class="line">docker service update --replicas 10 my-nginx     <span class="comment"># 弹性扩缩容</span></span><br><span class="line">docker service update --replicas 1 my-nginx</span><br><span class="line"></span><br><span class="line">docker service scale my-nginx=4                  <span class="comment"># 效果一样，更方便一点</span></span><br><span class="line"><span class="comment"># my-nginx scaled to 4</span></span><br><span class="line"></span><br><span class="line">docker service rm my-nginx                       <span class="comment"># 移除服务</span></span><br></pre></td></tr></table></figure>

<h2 id="概念总结"><a href="#概念总结" class="headerlink" title="概念总结"></a>概念总结</h2><ul>
<li>swarm: 集群的管理和编排。 docker 可以创建一个集群，其他节点可以加入(worker, manager)</li>
<li>Node: docker节点(我觉得理解为虚拟机会比较好)，多个节点组成集群网络</li>
<li>service: 任务，可以在管理节点或工作节点运行</li>
<li>Task: 容器内的命令，细节任务</li>
</ul>
<p>命令 -&gt; 管理节点 -&gt; api -&gt; 调度 -&gt; 工作节点</p>
<p>Publish Mode:</p>
<ul>
<li>swarm</li>
<li>Overlay</li>
<li>ingress - 特殊的 overlay 网络，由负载均衡功能</li>
</ul>
<p><code>docker network ls</code> + <code>docker network inspect ingress</code> 可以看到 swarm 集群中的机子都在这个网络中</p>
<h2 id="以后还要学-Go"><a href="#以后还要学-Go" class="headerlink" title="以后还要学 Go"></a>以后还要学 Go</h2><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>Q: 在最后的 spring 项目实战的 dockerfile 中我明明写了 EXPOSE 8080 为什么我在 run 的时候还要加 p 参数？<br>A: 查看了一下文档，发现这个 EXPOSE 只是起说明作用， run 的时候并不会自动暴露，但是他有一个好处，就是你写了之后，如果用 P 随机的模式的话，他会自动暴露</p>
<p>官方定义如下</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXPOSE 指令是声明容器运行时提供服务的端口，这只是一个声明，在容器运行时并不会因为这个声明应用就会开启这个端口的服务。在 Dockerfile 中写入这样的声明有两个好处，一个是帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射；</span><br><span class="line"></span><br><span class="line">另一个用处则是在运行时使用随机端口映射时，也就是 docker run -P 时，会自动随机映射 EXPOSE 的端口。</span><br><span class="line">要将 EXPOSE 和在运行时使用 -p &lt;宿主端口&gt;:&lt;容器端口&gt; 区分开来。-p，是映射宿主端口和容器端口，换句话说，就是将容器的对应端口服务公开给外界访问，而 EXPOSE 仅仅是声明容器打算使用什么端口而已，并不会自动在宿主进行端口映射。</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jack-zheng.github.io/hexo/hexo/2021/04/13/Design-pattern-decorator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/jack.jpg">
      <meta itemprop="name" content="Jack Zheng">
      <meta itemprop="description" content="我是张江搬砖小码农, 知识搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jackpot">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/hexo/2021/04/13/Design-pattern-decorator/" class="post-title-link" itemprop="url">装饰器模式</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-13 19:58:44" itemprop="dateCreated datePublished" datetime="2021-04-13T19:58:44+08:00">2021-04-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-16 13:29:44" itemprop="dateModified" datetime="2022-02-16T13:29:44+08:00">2022-02-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Design Principle:</strong> Classes should be open for extension, but closed for modification.</p>
<blockquote>
<p><strong>The Decorator Pattern</strong> attaches additional responsibilities to an object dynamically. Decorators provide a flexible alternative to subclassing for extending functionality.<br>装饰器模式可以让你的对象动态添加特性</p>
</blockquote>
<h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2><p>Starbuzz 设计了一款软件卖咖啡，但是设计太烂了，导致类膨胀了。如果是你你会怎么整？</p>
<p>原始设计, 有一个基类 Beverage，然后各种子类比如浓缩咖啡，美式等。但是光咖啡还不够，我们还可以加入各种调味料，比如抹茶，奶盖等。每加入新的调料都是一种新的类，比如浓缩+抹茶。类数量成指数上升</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">                     +-----------------+                                                                                                              </span><br><span class="line">                     |    Beverate     |                                                                                                              </span><br><span class="line">                     |---------------- |                                                                                                              </span><br><span class="line">                     | description     |                                                                                                              </span><br><span class="line">                     |---------------- |                                                                                                              </span><br><span class="line">                     | getDescription()|                                                                                                              </span><br><span class="line">                     | cost()          |                                                                                                              </span><br><span class="line">                     |                 |                                                                                                              </span><br><span class="line">                     +-----------------+                                                                                                              </span><br><span class="line">                       ^        ^   ^                                                                                                                 </span><br><span class="line">                       |        |   |---------------                                                                                                  </span><br><span class="line">                       |        |                  |                                                                                                  </span><br><span class="line">          +--------------+   +--------------+      |                                                                                                  </span><br><span class="line">          |  Espreesso   |   |  DarkRoast   |      |                                                                                                  </span><br><span class="line">          |--------------|   |--------------|     ...                                                                                                 </span><br><span class="line">          |  cost()      |   |  cost()      |                                                                                                         </span><br><span class="line">          +--------------+   +--------------+                                                                                                         </span><br><span class="line">            ^          ^                                                                                                                              </span><br><span class="line">            |          |                                                                                                                              </span><br><span class="line">            |          |                                                                                                                              </span><br><span class="line">+-----------------+    |                                                                                                                              </span><br><span class="line">|EspreessoWithMilk|    |                                                                                                                              </span><br><span class="line">|-----------------|   ...                                                                                                                             </span><br><span class="line">|  cost()         |                                                                                                                                   </span><br><span class="line">+-----------------+                                                                                                                              </span><br></pre></td></tr></table></figure>

<p>随之设计师又想到了另一种解决方案，可以将所有的属性和调味品设置成属性放到基类中，然后通过 flag 知道是否含有某种调味品，然后在子类中通过设置这些 flag 的值，定制 cost 结果</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+----------------+                                                                                                                                 </span><br><span class="line">|    Beverage    |                                                                                                                                 </span><br><span class="line">|----------------|                                                                                                                                 </span><br><span class="line">| description    |                                                                                                                                 </span><br><span class="line">| soy            |                                                                                                                                 </span><br><span class="line">| mocha          |                                                                                                                                 </span><br><span class="line">| ...            |                                                                                                                                 </span><br><span class="line">|----------------|                                                                                                                                 </span><br><span class="line">| hasSoy()       |                                                                                                                                 </span><br><span class="line">| hasMocha()     |                                                                                                                                 </span><br><span class="line">| ...            |                                                                                                                                 </span><br><span class="line">|                |                                                                                                                                 </span><br><span class="line">|                |                                                                                                                                 </span><br><span class="line">|                |                                                                                                                                 </span><br><span class="line">|                |                                                                                                                                 </span><br><span class="line">|                |                                                                                                                                 </span><br><span class="line">+----------------+                                                                                                                                 </span><br></pre></td></tr></table></figure>

<p>对应的代码实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    <span class="comment">// declear condiment</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> condimentCost = <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">if</span> (hasMilk()) &#123;</span><br><span class="line">            codimentCost += milkCost;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (hasSoy()) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DarkRoast</span> <span class="keyword">extends</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1.00</span> + <span class="keyword">super</span>.cost();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样做虽然避免的类爆炸式增长，但是导致了新的问题。比如每当调料价格变动，你就必须得改变老得代码。新加调料，你还得修改之前的 if 逻辑。而且如果有新的饮料，比如茶，那么这个继承关系在逻辑层面上就不是很合理了。为了解决类似的问题，我们引入装饰者模式</p>
<h2 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h2><ul>
<li>每个 Component 可以自己调用自己，也可以被 Decorator 包裹</li>
<li>每个 Decorator 都持有一个 Component 的引用</li>
<li>ConcrateComponent 是 Component 的具体实现</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">                    +--------------+                            </span><br><span class="line">                    |  Component   |                            </span><br><span class="line">                    |--------------|------------------|         </span><br><span class="line">                    | +operation() |                  |         </span><br><span class="line">                    |              |                  |         </span><br><span class="line">                    +--------------+                  |         </span><br><span class="line">                    ^             ^                   |         </span><br><span class="line">                    |             |                   |         </span><br><span class="line">                    |             |                   |         </span><br><span class="line">+---------------------+          +--------------+     |         </span><br><span class="line">|  ConcreateComponent |          |  Decorator   |&lt;&gt;---|         </span><br><span class="line">|---------------------|          |--------------|               </span><br><span class="line">| +operation()        |          | +operation() |               </span><br><span class="line">|                     |          |              |               </span><br><span class="line">+---------------------+          +--------------+               </span><br><span class="line">                                  ^         ^                   </span><br><span class="line">                                  |         |                   </span><br><span class="line">                                  |         |                   </span><br><span class="line">              +---------------------+    +---------------------+</span><br><span class="line">              | ConcreateDecoratorA |    | ConcreateDecoratorA |</span><br><span class="line">              |---------------------|    |---------------------|</span><br><span class="line">              | +operation()        |    | +operation()        |</span><br><span class="line">              | +addBehavior()      |    | +addBehavior()      |</span><br><span class="line">              +---------------------+    +---------------------+</span><br></pre></td></tr></table></figure>

<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基类实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    String description = <span class="string">&quot;Unknown Beverage&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例咖啡实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Espresso</span> <span class="keyword">extends</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Espresso</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        description = <span class="string">&quot;Espresso&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1.99</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 装饰类的基类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CondimentDecorator</span> <span class="keyword">extends</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 装饰类实现，装饰类会持有基类引用，并对方法做扩展</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mocha</span> <span class="keyword">extends</span> <span class="title">CondimentDecorator</span> </span>&#123;</span><br><span class="line">    Beverage beverage;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Mocha</span><span class="params">(Beverage beverage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beverage = beverage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beverage.cost() + .<span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beverage.getDescription() + <span class="string">&quot;, Mocha&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Soy</span> <span class="keyword">extends</span> <span class="title">CondimentDecorator</span> </span>&#123;</span><br><span class="line">    Beverage beverage;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Soy</span><span class="params">(Beverage beverage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beverage = beverage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beverage.cost() + .<span class="number">15</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beverage.getDescription() + <span class="string">&quot;, Soy&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Beverage myBeverage = <span class="keyword">new</span> Mocha(<span class="keyword">new</span> Soy(<span class="keyword">new</span> Espresso()));</span><br><span class="line">        System.out.println(myBeverage.cost());</span><br><span class="line">        System.out.println(myBeverage.getDescription());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.3400000000000003</span></span><br><span class="line"><span class="comment">// Espresso, Soy, Mocha</span></span><br></pre></td></tr></table></figure>

<p>问，我现在如果加了双份的抹茶，description 输出时会现实 Mocha, Mocha。那如果我想要他输出 Double Mocha 的话需要怎么做?</p>
<p>按照装饰模式的思路，可以将 description 的实现改为容器，比如 list, 然后在最外层加入一个 CustomizedDescDecorator 截取 description 做整合</p>
<h2 id="该模式在-JDK-中的应用"><a href="#该模式在-JDK-中的应用" class="headerlink" title="该模式在 JDK 中的应用"></a>该模式在 JDK 中的应用</h2><p>Java 的 I/O 包就使用了装饰器模式。IO 分两种，字节流（Input/OutputStream）和字符流（Reader/Writer）。</p>
<p>以输入字节流 InputStream 为例，继承关系如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">                                +-------------+                                                 </span><br><span class="line">                                | InputStream |                                                 </span><br><span class="line">                                +-------------+                                                 </span><br><span class="line">                                       ^                                                        </span><br><span class="line">         ------------------------------|------------------------------------------------------  </span><br><span class="line">        |                              |              |                       |              |  </span><br><span class="line">        |                              |              |                       |              |  </span><br><span class="line">+-----------------+  +-------------------+  +-------------------+  +----------------------+  |  </span><br><span class="line">| FileInputStream |  | FilterInputStream |  | ObjectInputStream |  | ByteArrayInputStream |  ...</span><br><span class="line">+-----------------+  +-------------------+  +-------------------+  +----------------------+     </span><br><span class="line">                                  ^                                                             </span><br><span class="line">        --------------------------|-----------------------------------------------              </span><br><span class="line">       |                          |                           |                  |              </span><br><span class="line">       |                          |                           |                  |              </span><br><span class="line">+---------------------+   +---------------------+    +--------------------+      |              </span><br><span class="line">| BufferedInputStream |   | DataInputStream     |    | PushbakInputStream |     ...             </span><br><span class="line">+---------------------+   +---------------------+    +--------------------+                     </span><br></pre></td></tr></table></figure>

<p>一开始看岔了，把 FilterInputStream 和 FileInputStream 看成同一个了，所以没能把它和装饰模式匹配起来。在 IO 的实现中，FileInputStream, ObjectInputStream 等即对饮了 ConcreateComponent, 是具体实现。</p>
<p>FilterInputStream 对应了 Decorator, 是修饰器的基类，持有了 inputStream 的引用，而 BufferedInputStream 则为装饰器的具体实现，起到包装 Component 的作用。</p>
<p>BufferedInputStream 使用示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IoDecoratorDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ClassLoader classloader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        InputStream is = classloader.getResourceAsStream(<span class="string">&quot;c1_2.xml&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> (BufferedInputStream bis = <span class="keyword">new</span> BufferedInputStream(is)) &#123;</span><br><span class="line">            <span class="keyword">byte</span> data;</span><br><span class="line">            <span class="keyword">while</span> ((data = (<span class="keyword">byte</span>) bis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                System.out.print((<span class="keyword">char</span>) data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;Finish read...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jack-zheng.github.io/hexo/hexo/2021/04/09/Design-pattern-adapter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/jack.jpg">
      <meta itemprop="name" content="Jack Zheng">
      <meta itemprop="description" content="我是张江搬砖小码农, 知识搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jackpot">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/hexo/2021/04/09/Design-pattern-adapter/" class="post-title-link" itemprop="url">适配器模式</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-09 12:40:47" itemprop="dateCreated datePublished" datetime="2021-04-09T12:40:47+08:00">2021-04-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-16 13:29:44" itemprop="dateModified" datetime="2022-02-16T13:29:44+08:00">2022-02-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p><strong>The Adapter Pattern</strong> converts the interface of a class into another interface the clients expect.  Adapter lets classes work together that couldn’t otherwise because of incompatible interfaces.<br>适配器模式将一种接口类型转化为另一种，他用来解决类中的类型适配问题</p>
</blockquote>
<h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2><p>举例一个现实生活中的案例：插头转换器。比如我们的手机是两脚插头，但是家里只有三脚插座，那怎么整？答案是找一个插口转化器，把两脚的转成三脚的即可。adapter 模式的工作方式和这种解决方案完全一致。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+     +-------+     +-------------+                                                                                              </span><br><span class="line">| Your existing      |     |Adaptor|     | Vendor      |                                                                                              </span><br><span class="line">| system             |     |       |     | Class       |                                                                                              </span><br><span class="line">|                    |---&gt; |       |----&gt;|             |                                                                                              </span><br><span class="line">|                    |     |       |     |             |                                                                                              </span><br><span class="line">|                    |     |       |     |             |                                                                                              </span><br><span class="line">+--------------------+     +-------+     +-------------+                                                                                              </span><br></pre></td></tr></table></figure>

<p>好了现在让我们用第一章的鸭子来举例子。话说有一天，PM 突然找到小码农说，我们的客户有一个特殊要求，想要一种有着火鸡内在的鸭子。小码农满脸的黑人问号，这也行？但是 PM 不管，说下周就要产品掩饰了，你自己看着办。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 假设之前的鸭子实现是通过 interface 来做的, 我们现在已有了 Duck，Turkey 的接口定义，以及 Turkey 的实现</span></span><br><span class="line"><span class="comment">* 我们只需要新建一个适配器，实现目标接口的方法，并且适配器持有需要代理的实例。在对应的方法中通过调用实例方法即可</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Turkey</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">gobble</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WildTurkey</span> <span class="keyword">implements</span> <span class="title">Turkey</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">gobble</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Gobble...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Fly a short distance...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DuckAdaptor</span> <span class="keyword">implements</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Turkey turkey;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DuckAdaptor</span><span class="params">(Turkey turkey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.turkey = turkey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        turkey.gobble();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        turkey.fly();</span><br><span class="line">        turkey.fly();</span><br><span class="line">        turkey.fly();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DuckAdaptor adaptor = <span class="keyword">new</span> DuckAdaptor(<span class="keyword">new</span> WildTurkey());</span><br><span class="line">        adaptor.quack();</span><br><span class="line">        adaptor.fly();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Gobble...</span></span><br><span class="line"><span class="comment">// Fly a short distance...</span></span><br><span class="line"><span class="comment">// Fly a short distance...</span></span><br><span class="line"><span class="comment">// Fly a short distance...</span></span><br></pre></td></tr></table></figure>

<h2 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+-----------------+     +---------------+                                                                                                            </span><br><span class="line">|                 |---&gt; |&lt;&lt;Interface&gt;&gt;  |                                                                                                            </span><br><span class="line">|    Client       |     |  Target       |                                                                                                            </span><br><span class="line">|                 |     +---------------+                                                                                                            </span><br><span class="line">+-----------------+             ^                                                                                                                    </span><br><span class="line">                                |                                                                                                                    </span><br><span class="line">                                |                                                                                                                    </span><br><span class="line">                                |                                                                                                                    </span><br><span class="line">                         +-------------+      +-----------------+                                                                                    </span><br><span class="line">                         |   Adapter   |      |   Adaptee       |                                                                                    </span><br><span class="line">                         |-------------| ----&gt;|-----------------|                                                                                    </span><br><span class="line">                         | request()   |      | specialRequest()|                                                                                    </span><br><span class="line">                         |             |      |                 |                                                                                    </span><br><span class="line">                         +-------------+      +-----------------+                                                                                    </span><br></pre></td></tr></table></figure>

<p>这里展示的是类 adaptor, 还有一种 class adaptor，但是由于 Java 是单继承的，语法上就不能实现 class adaptor 的这种定义。不过支持多继承的语言是可以实现的。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+-----------------+      +-------------+     +-----------------+                                                                                     </span><br><span class="line">|                 |---&gt;  |   Target    |     |   Adaptee       |                                                                                     </span><br><span class="line">|    Client       |      |-------------|     |-----------------|                                                                                     </span><br><span class="line">|                 |      | request()   |     | specialRequest()|                                                                                     </span><br><span class="line">+-----------------+      |             |     |                 |                                                                                     </span><br><span class="line">                         +-------------+     +-----------------+                                                                                     </span><br><span class="line">                                     ^         ^                                                                                                     </span><br><span class="line">                                     |         |                                                                                                     </span><br><span class="line">                                     |         |                                                                                                     </span><br><span class="line">                                     |         |                                                                                                     </span><br><span class="line">                                    +-------------+                                                                                                  </span><br><span class="line">                                    |   Adapter   |                                                                                                  </span><br><span class="line">                                    |-------------|                                                                                                  </span><br><span class="line">                                    | request()   |                                                                                                  </span><br><span class="line">                                    |             |                                                                                                  </span><br><span class="line">                                    +-------------+                                                                                                  </span><br></pre></td></tr></table></figure>

<h2 id="项目中可能用到-Adapter-的地方"><a href="#项目中可能用到-Adapter-的地方" class="headerlink" title="项目中可能用到 Adapter 的地方"></a>项目中可能用到 Adapter 的地方</h2><p>比如老代码中，很多地方会用到 Enumeration 类，但是在 JDK 1.2 时就推出了 Iterator 接口代替他。如果新的代码都时采用的 Iterator 做迭代，那么怎么兼容老的 Enumeration 呢。</p>
<p>可以新建一个 adapter 类，实现 iterator 接口，持有 enumeration 实现。在 client 中通过这个 adaptor 访问 enumeration。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdapterToEnum</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Vector&lt;String&gt; strings = <span class="keyword">new</span> Vector&lt;&gt;();</span><br><span class="line">        strings.add(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        strings.add(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">        strings.add(<span class="string">&quot;c&quot;</span>);</span><br><span class="line">        strings.add(<span class="string">&quot;d&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Enumeration&lt;String&gt; enumeration = strings.elements();</span><br><span class="line"></span><br><span class="line">        IteratorAdapter adapter = <span class="keyword">new</span> IteratorAdapter(enumeration);</span><br><span class="line">        <span class="keyword">while</span> (adapter.hasNext()) &#123;</span><br><span class="line">            System.out.println(adapter.next());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PS: 书中视角 EnumerationAdapter, 但是我觉得不是应该叫 迭代器适配器 才合适吗？应该是我和作者对数据流向的理解相反，但是对这里的使用没有造成影响</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IteratorAdapter</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Enumeration&lt;String&gt; enumeration;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IteratorAdapter</span><span class="params">(Enumeration&lt;String&gt; enumeration)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.enumeration = enumeration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> enumeration.hasMoreElements();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> enumeration.nextElement();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jack-zheng.github.io/hexo/hexo/2021/04/09/Design-pattern-strategy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/jack.jpg">
      <meta itemprop="name" content="Jack Zheng">
      <meta itemprop="description" content="我是张江搬砖小码农, 知识搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jackpot">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/hexo/2021/04/09/Design-pattern-strategy/" class="post-title-link" itemprop="url">策略模式</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-09 12:39:57" itemprop="dateCreated datePublished" datetime="2021-04-09T12:39:57+08:00">2021-04-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-16 13:29:44" itemprop="dateModified" datetime="2022-02-16T13:29:44+08:00">2022-02-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Design Principle: </p>
<ul>
<li>Identify the aspects of your application that vary and separate them from what stays the same - 将频繁改变的部分从系统中抽离出来</li>
<li>Program to an interface, not an implementation - 面向接口编程而非实现</li>
<li>Favor composition over inheritance - 组合优于继承</li>
</ul>
<blockquote>
<p>The <strong>Strategy Pattern</strong> defines a family of algorithms, encapsulates each one, and makes them interchangeable.  Strategy lets the algorithm vary independently from clients that use it.  </p>
<p>完成共一个任务往往有多种不同的方法，每一种方法我们称之为策略，我们可以通过不同的条件选择不同的算法完成任务</p>
</blockquote>
<h2 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+-----------------+                                                                                                                               </span><br><span class="line">|  Context        |                                                                                                                               </span><br><span class="line">|---------------- |               +-------------------+                                                                                           </span><br><span class="line">| - strategy      |&lt;&gt;------------ | &lt;&lt;Interface&gt;&gt;     |                                                                                           </span><br><span class="line">|---------------- |               |   Strategy        |                                                                                           </span><br><span class="line">| + setStrategy(s)|               |------------------ |                                                                                           </span><br><span class="line">| + perfStratecy()|               | algorithm()       |                                                                                           </span><br><span class="line">|                 |               +-------------------+                                                                                           </span><br><span class="line">|                 |                 ^                                                                                                             </span><br><span class="line">|                 |                 |----------------------------------                                                                           </span><br><span class="line">+-----------------+                 |                |                |                                                                           </span><br><span class="line">                                    |                |                |                                                                           </span><br><span class="line">                   +-------------------+   +-------------------+      |                                                                           </span><br><span class="line">                   |ConcreateStrategyA |   |ConcreateStrategyB |      |                                                                           </span><br><span class="line">                   |------------------ |   |------------------ |     ...                                                                          </span><br><span class="line">                   | algorithm()       |   | algorithm()       |                                                                                  </span><br><span class="line">                   +-------------------+   +-------------------+                                                                                  </span><br></pre></td></tr></table></figure>

<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>已有一段鸭子模拟器代码，所有鸭子都有一个基类，基类中定义了一些常用方法，并给了实现。只有 display() 是需要每个类定制的，声明成了 abstract 并在子类中各自实现</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">            +--------------------+                                                                                                                  </span><br><span class="line">            |  Duck              |                                                                                                                  </span><br><span class="line">            |--------------------|                                                                                                                  </span><br><span class="line">            | swim()             |                                                                                                                  </span><br><span class="line">            | display()          |                                                                                                                  </span><br><span class="line">            | quack()            |                                                                                                                  </span><br><span class="line">            | //other methods    |                                                                                                                  </span><br><span class="line">            +--------------------+                                                                                                                  </span><br><span class="line">               ^                                                                                                                                    </span><br><span class="line">               |                                                                                                                                    </span><br><span class="line">               |---------------                                                                                                                     </span><br><span class="line">               |              |                                                                                                                     </span><br><span class="line">               |              |                                                                                                                     </span><br><span class="line">+----------------+     +----------------+                                                                                                           </span><br><span class="line">|  MallardDuck   |     |  RedHeadDuck   |                                                                                                           </span><br><span class="line">|--------------- |     |--------------- |                                                                                                           </span><br><span class="line">|display()       |     |display()       |                                                                                                           </span><br><span class="line">|                |     |                |                                                                                                           </span><br><span class="line">|                |     |                |                                                                                                           </span><br><span class="line">+----------------+     +----------------+                                                                                                           </span><br></pre></td></tr></table></figure>

<p>某个 release，客户突然想要看到鸭子能飞。。。小码农一拍脑袋：嗨，这还不简单。就直接在基类里添加了 fly() 的实现。然后转头就去写其他功能了。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">            +--------------------+                                                                                                                  </span><br><span class="line">            |  Duck              |                                                                                                                  </span><br><span class="line">            |--------------------|                                                                                                                  </span><br><span class="line">            | swim()             |                                                                                                                  </span><br><span class="line">            | display()          |                                                                                                                  </span><br><span class="line">            | quack()            |                                                                                                                  </span><br><span class="line">            | fly()              |                                                                                                                  </span><br><span class="line">            | //other methods    |                                                                                                                  </span><br><span class="line">            +--------------------+                                                                                                                  </span><br><span class="line">               ^                                                                                                                                    </span><br><span class="line">               |                                                                                                                                    </span><br><span class="line">               |---------------                                                                                                                     </span><br><span class="line">               |              |                                                                                                                     </span><br><span class="line">               |              |                                                                                                                     </span><br><span class="line">+----------------+     +----------------+                                                                                                           </span><br><span class="line">|  MallardDuck   |     |  RedHeadDuck   |                                                                                                           </span><br><span class="line">|--------------- |     |--------------- |                                                                                                           </span><br><span class="line">|display()       |     |display()       |                                                                                                           </span><br><span class="line">|                |     |                |                                                                                                           </span><br><span class="line">|                |     |                |                                                                                                           </span><br><span class="line">+----------------+     +----------------+                                                                                                           </span><br></pre></td></tr></table></figure>

<p>三天后，Sales 一个夺命连环 call 打到小码农这儿，说自己给客户演示功能的时候，突然发现，程序里的橡皮鸭子起飞了！！！这还了得，小码农打开了 IDE 看了橡皮鸭子的代码</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">            +--------------------+                                                                                                                  </span><br><span class="line">            |  Duck              |                                                                                                                  </span><br><span class="line">            |--------------------|                                                                                                                  </span><br><span class="line">            | swim()             |                                                                                                                  </span><br><span class="line">            | display()          |                                                                                                                  </span><br><span class="line">            | quack()            |                                                                                                                  </span><br><span class="line">            | fly()              |                                                                                                                  </span><br><span class="line">            | //other methods    |                                                                                                                  </span><br><span class="line">            +--------------------+                                                                                                                  </span><br><span class="line">               ^                                                                                                                                    </span><br><span class="line">               |                                                                                                                                    </span><br><span class="line">               |----------------------------------------                                                                                            </span><br><span class="line">               |              |                        |                                                                                            </span><br><span class="line">               |              |                        |                                                                                            </span><br><span class="line">+----------------+     +----------------+     +----------------+                                                                                    </span><br><span class="line">|  MallardDuck   |     |  RedHeadDuck   |     |  RubberDuck    |                                                                                    </span><br><span class="line">|--------------- |     |--------------- |     |--------------- |                                                                                    </span><br><span class="line">|display()       |     |display()       |     |display()       |                                                                                    </span><br><span class="line">|                |     |                |     |quack()&#123;        |                                                                                    </span><br><span class="line">|                |     |                |     |override quack  |                                                                                    </span><br><span class="line">+----------------+     +----------------+     |&#125;               |                                                                                    </span><br><span class="line">                                              |                |                                                                                    </span><br><span class="line">                                              +----------------+                                                                                    </span><br></pre></td></tr></table></figure>

<p>好嘛，原来基类加完 fly() 方法之后忘了重写橡皮鸭子这个子类了，还能咋整，要不重写一下 fly() 呗</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+                                                                                                                           </span><br><span class="line">|    RubberDuck           |                                                                                                                           </span><br><span class="line">| ----------------------  |                                                                                                                           </span><br><span class="line">|                         |                                                                                                                           </span><br><span class="line">| display()               |                                                                                                                           </span><br><span class="line">| quack()&#123;// rubber quck &#125;|                                                                                                                           </span><br><span class="line">| fly()&#123; // do nothing &#125;  |                                                                                                                           </span><br><span class="line">|                         |                                                                                                                           </span><br><span class="line">+-------------------------+ </span><br></pre></td></tr></table></figure>

<p>不过转念一下，这也不是办法啊，不然哪天要新加一个什么木头鸭子，不是还得和橡皮鸭子一样再来一遍？于是小码农就寻思着，把 quack 和 fly 整成接口？</p>
<p>把这个想法和同事小美一说，小美立马就不乐意了，这个产品有几十个类，把这两个玩意儿整成接口，你不得在这几十个类里面都改一遍，你改啊？！</p>
<p>小码农想也是，但是没什么法子，就去问自己的师傅大能耐了。小码农把情况和大能耐说了一遍。</p>
<p>‘耐哥，就上面的情况，听说你精通设计模式，这种情况，有法儿吗’</p>
<p>‘咱先不说设计模式的事儿，写代码最起码得掌握一个原则：先把频繁变动的代码和不变的拆分开了后我们再说事儿’</p>
<p>按照耐哥的思路，小码农把 quack 和 fly 从鸭子类里面单独拿出来写成接口，并为他们做了各种实现</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">                 +-------------------------+                                                                                                       </span><br><span class="line">                 |    &lt;&lt;Interface&gt;&gt;        |                                                                                                       </span><br><span class="line">                 |    FlyBehavior          |                                                                                                       </span><br><span class="line">                 | ----------------------  |                                                                                                       </span><br><span class="line">                 | fly()                   |                                                                                                       </span><br><span class="line">                 |                         |                                                                                                       </span><br><span class="line">                 +-------------------------+                                                                                                       </span><br><span class="line">                       ^                                                                                                                           </span><br><span class="line">                       |---------------------                                                                                                      </span><br><span class="line">                       |                    |                                                                                                      </span><br><span class="line">                       |                    |                                                                                                      </span><br><span class="line">+-------------------------+   +-------------------------+                                                                                          </span><br><span class="line">|    FlyWithWings         |   |    FlyNoWay             |                                                                                          </span><br><span class="line">| ----------------------  |   | ----------------------  |                                                                                          </span><br><span class="line">| fly()&#123; // duck flying &#125; |   | fly()&#123; // can&#x27;t fly &#125;   |                                                                                          </span><br><span class="line">|                         |   |                         |                                                                                          </span><br><span class="line">+-------------------------+   +-------------------------+ </span><br></pre></td></tr></table></figure>

<p>既然将这两个属性从基类中抽出来了，那原来的基类中我们再用这两个新的接口代替，并新建方法调用接口实现 fly 和 quack 的功能</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+                                                                                                                             </span><br><span class="line">|  Duck              |                                                                                                                             </span><br><span class="line">|--------------------|                                                                                                                             </span><br><span class="line">| FlyBehavior fb     |                                                                                                                             </span><br><span class="line">| QuackBehavior qb   |                                                                                                                             </span><br><span class="line">|                    |                                                                                                                             </span><br><span class="line">|--------------------|                                                                                                                             </span><br><span class="line">| swim()             |                                                                                                                             </span><br><span class="line">| display()          |                                                                                                                             </span><br><span class="line">| perormQuack()  &lt;----------- qb.quack();                                                                                                          </span><br><span class="line">| performFly()   &lt;----------- fb.fly();                                                                                                            </span><br><span class="line">| //other methods    |                                                                                                                             </span><br><span class="line">|                    |                                                                                                                             </span><br><span class="line">+--------------------+                     </span><br></pre></td></tr></table></figure>

<p>按照这个逻辑，小码农重构了以后的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Fly 接口及其实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FlyBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlyNoWay</span> <span class="keyword">implements</span> <span class="title">FlyBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">&quot;I can&#x27;t fly...&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlyWithWings</span> <span class="keyword">implements</span> <span class="title">FlyBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">&quot;I can fly...&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Quack 接口及其实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">QuackBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Quack</span> <span class="keyword">implements</span> <span class="title">QuackBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">&quot;Quack...Quack...&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Squack</span> <span class="keyword">implements</span> <span class="title">QuackBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">&quot;Squack...&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MuteQuack</span> <span class="keyword">implements</span> <span class="title">QuackBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">&quot;&lt;&lt; Silence &gt;&gt;&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Duck 抽象方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">    QuackBehavior quackBehavior;</span><br><span class="line">    FlyBehavior flyBehavior;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performQuack</span><span class="params">()</span> </span>&#123; quackBehavior.quack(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performFly</span><span class="params">()</span> </span>&#123; flyBehavior.fly(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">swim</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">&quot;All ducks float, even decoys!&quot;</span>); &#125;</span><br><span class="line">    <span class="comment">// other shared methods</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 具体种类的鸭子类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallardDuck</span> <span class="keyword">extends</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MallardDuck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.flyBehavior = <span class="keyword">new</span> FlyWithWings();</span><br><span class="line">        <span class="keyword">this</span>.quackBehavior = <span class="keyword">new</span> Quack();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I&#x27;m a Mallard duck...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiniDuckSimulator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MallardDuck mallardDuck = <span class="keyword">new</span> MallardDuck();</span><br><span class="line">        mallardDuck.performQuack();</span><br><span class="line">        mallardDuck.performFly();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Quack...Quack...</span></span><br><span class="line"><span class="comment">// I can fly...</span></span><br></pre></td></tr></table></figure>

<p>大功告成，小码农拿着自己的成果找了大能耐 review 代码</p>
<p>‘不错不错，不过你有没有想过你的代码还可以更灵活，只要在 Duck 里面添加一个 set 方法，你就可以动态的改变鸭子的行为了哟’</p>
<p>小码农一想，立马知道了其中的关键，修改了代码</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+                                                                                                                             </span><br><span class="line">|  Duck              |                                                                                                                             </span><br><span class="line">|--------------------|                                                                                                                             </span><br><span class="line">| FlyBehavior fb     |                                                                                                                             </span><br><span class="line">| QuackBehavior qb   |                                                                                                                             </span><br><span class="line">|                    |                                                                                                                             </span><br><span class="line">|--------------------|                                                                                                                             </span><br><span class="line">| swim()             |                                                                                                                             </span><br><span class="line">| display()          |                                                                                                                             </span><br><span class="line">| perormQuack()  &lt;----------- qb.quack();                                                                                                          </span><br><span class="line">| performFly()   &lt;----------- fb.fly();                                                                                                            </span><br><span class="line">| //other methods    |                                                                                                                             </span><br><span class="line">| setFlyBehavior()   |                                                                                                                             </span><br><span class="line">| setQuackBehavior() |                                                                                                                             </span><br><span class="line">|                    |                                                                                                                             </span><br><span class="line">+--------------------+                     </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">    QuackBehavior quackBehavior;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setQuackBehavior</span><span class="params">(QuackBehavior quackBehavior)</span> </span>&#123; <span class="keyword">this</span>.quackBehavior = quackBehavior; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlyBehavior</span><span class="params">(FlyBehavior flyBehavior)</span> </span>&#123; <span class="keyword">this</span>.flyBehavior = flyBehavior; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正巧项目组想要一个新的鸭子模型，能够动态的改变飞行模式，在氪金以前是不能飞的，但是氪金以后能弹射起步。。。正好赶巧了，小码农三下五除二就实现了功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RocketFly</span> <span class="keyword">implements</span> <span class="title">FlyBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;  System.out.println(<span class="string">&quot;Fly in rocket speed...&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiniDuckSimulator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ModelDuck modelDuck = <span class="keyword">new</span> ModelDuck();</span><br><span class="line">        modelDuck.performFly();</span><br><span class="line"></span><br><span class="line">        modelDuck.setFlyBehavior(<span class="keyword">new</span> RocketFly());</span><br><span class="line">        modelDuck.performFly();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// I can&#x27;t fly...</span></span><br><span class="line"><span class="comment">// Fly in rocket speed...</span></span><br></pre></td></tr></table></figure>

<p>小码农哼着小曲儿锁了屏，转头跑到走廊上掏出手机开启了王者农药。。。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jack-zheng.github.io/hexo/hexo/2021/04/08/Algorithm-quick-sort/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/jack.jpg">
      <meta itemprop="name" content="Jack Zheng">
      <meta itemprop="description" content="我是张江搬砖小码农, 知识搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jackpot">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/hexo/2021/04/08/Algorithm-quick-sort/" class="post-title-link" itemprop="url">快速排序</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-08 12:45:01" itemprop="dateCreated datePublished" datetime="2021-04-08T12:45:01+08:00">2021-04-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-16 13:29:44" itemprop="dateModified" datetime="2022-02-16T13:29:44+08:00">2022-02-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>分而治之（divide and conquer，D&amp;C）- 种著名的递归式问题解决方法</p>
<h2 id="4-1-分而治之"><a href="#4-1-分而治之" class="headerlink" title="4.1 分而治之"></a>4.1 分而治之</h2><p>练习1: 有一块 1680 x 640 的土地，将它等分成一个个正方形，那么正方形面积最大时，边长为多少？</p>
<p>解决方案，根据<strong>欧几里得</strong>定律，我们先将长方形分解成 640x640 + 640x640 + 640x400，然后再将 640x400 的长方形按照同样的方式分解，到最后分解为正方形时就是我们要的答案了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSquar</span>(<span class="params">length, width</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> length%width == <span class="number">0</span>: </span><br><span class="line">        <span class="keyword">return</span> width </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> getSquar(width, length%width) </span><br><span class="line"></span><br><span class="line">getSquar(<span class="number">1680</span>, <span class="number">640</span>) </span><br><span class="line"><span class="comment"># 80</span></span><br></pre></td></tr></table></figure>

<p>重申一下 D&amp;C 的工作原理：</p>
<ol>
<li>找出简单的基线条件</li>
<li>确定如何缩小问题的规模，使其符合基线条件</li>
</ol>
<p>练习2: 使用 D&amp;C 的思路计算一个数组的和, sum = first + sum(sec…end)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">list = [sub <span class="keyword">for</span> sub <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">10</span>)]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span>(<span class="params">list</span>):</span></span><br><span class="line">    <span class="keyword">if</span> list:</span><br><span class="line">        <span class="keyword">return</span> list[<span class="number">0</span>] + sum(list[<span class="number">1</span>:])</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">sum(list)</span><br><span class="line"><span class="comment"># 45</span></span><br></pre></td></tr></table></figure>

<h2 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h2><p>练习：准备一个无序数组，使用快排重新排序</p>
<p>快排原理：随机从数组中选择一个数作为基准，然后将数组分为 大于基准的数 + 基准 + 小于基准的数，再按照同样的思路对两堆数进行同样的排序，直到堆的 len &lt; 2 为止，排序结束</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">list = random.sample(range(<span class="number">0</span>, <span class="number">100</span>), <span class="number">10</span>)</span><br><span class="line"><span class="comment"># [71, 70, 99, 91, 12, 5, 80, 61, 17, 24]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">qsort</span>(<span class="params">list</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> len(list) &gt; <span class="number">1</span>: </span><br><span class="line">        pivot = list[<span class="number">0</span>] </span><br><span class="line">        small_partition = [sub <span class="keyword">for</span> sub <span class="keyword">in</span> list[<span class="number">1</span>:] <span class="keyword">if</span> sub &lt; pivot] </span><br><span class="line">        big_partition = [sub <span class="keyword">for</span> sub <span class="keyword">in</span> list[<span class="number">1</span>:] <span class="keyword">if</span> sub &gt;= pivot] </span><br><span class="line">        <span class="keyword">return</span> qsort(small_partition) + [pivot] + qsort(big_partition) </span><br><span class="line">    <span class="keyword">return</span> list</span><br><span class="line"></span><br><span class="line"><span class="comment"># [5, 12, 17, 24, 61, 70, 71, 91, 80, 99]</span></span><br><span class="line"><span class="comment"># 看了下书上的答案基本一致 (●°u°●)​ 」</span></span><br></pre></td></tr></table></figure>

<h2 id="4-3-再谈大O表示法"><a href="#4-3-再谈大O表示法" class="headerlink" title="4.3 再谈大O表示法"></a>4.3 再谈大O表示法</h2><p>常见大O运行时间</p>
<p><img src="c4_01.png" alt="常见大O运行时间"></p>
<h3 id="4-3-2-平均情况和最糟情况"><a href="#4-3-2-平均情况和最糟情况" class="headerlink" title="4.3.2  平均情况和最糟情况"></a>4.3.2  平均情况和最糟情况</h3><p>当最糟情况时，n 个元素的数组，每层分析 n 次，栈深为 n, O(n) x O(n) = O(n<sup>2</sup>)</p>
<p>平均情况时，n 个元素的数组，每层分析 n 次，栈深为 log<sup>n</sup>, 时间复杂度为 O(n) x O(log<sup>n</sup>) = O(nlog<sup>n</sup>)</p>
<h2 id="Java-中的快排实现"><a href="#Java-中的快排实现" class="headerlink" title="Java 中的快排实现"></a>Java 中的快排实现</h2><p>Java 中快排的实现思路和 Python 中的是一样的，但是可能由于语法支持上的不同，感觉上，Java 的实现要比 Python 的复杂很多</p>
<p>PS: Java 实现中的异样感来源于他没有新建数组，所有的操作都是在原来的数组上实现的，节省了资源</p>
<p>示例说明：</p>
<p>以第一个元素为基准，先遍历一遍数组将数组分为 [小于等于 pivot] + [pivot] + [大于 pivot] 三部分, 然后再对大于和小于的两部分做同样的算法</p>
<p>参考 <a target="_blank" rel="noopener" href="https://blog.csdn.net/Holmofy/article/details/71168530">CSDN</a> 讲解的很详细，难点集中在分组的算法上，这里使用<strong>挖坑法</strong>。</p>
<p>选取数组的第一个元素作为 pivot，分别记录起止点下标i，j. 先从右向左找<strong>小于</strong>pivot的元素, 找到了就和 i 做交换。然后从左向右找<strong>大于</strong>pivot的元素，和 j 做交换，直到 i &gt;= j 结束。</p>
<p>完了将 pivot 的值赋给 i 位置。这个时候 i 和 j 是相等的。经过这一次遍历，数组被分为以 pivot 为界的两个自数组，元素分别小于和大于 pivot。</p>
<p>PS: 必须先从右向左扫描，不然我们就丢失了 j 的初始值引用了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuickSortDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] sample = <span class="keyword">new</span> Random().ints(<span class="number">0</span>, <span class="number">100</span>).limit(<span class="number">10</span>).toArray();</span><br><span class="line">        System.out.println(<span class="string">&quot;Origin: &quot;</span> + Arrays.toString(sample));</span><br><span class="line"></span><br><span class="line">        qsort(sample, <span class="number">0</span>, sample.length - <span class="number">1</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;After:  &quot;</span> + Arrays.toString(sample));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">qsort</span><span class="params">(<span class="keyword">int</span>[] arr, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (start &gt;= end) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> pivot_index = partition(arr, start, end);</span><br><span class="line">        <span class="comment">// 子数组排序的时候，pivot 是不需要参与的，不然结果会出错！！</span></span><br><span class="line">        qsort(arr, start, pivot_index - <span class="number">1</span>);</span><br><span class="line">        qsort(arr, pivot_index + <span class="number">1</span>, end);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以第一个元素为基准，对数组排序，排序完之后，格式为 [小于pivot + pivot + 大于pivot]</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> arr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> start</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> pivot index</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(<span class="keyword">int</span>[] arr, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> pivot = arr[start];</span><br><span class="line">        <span class="keyword">int</span> i = start, j = end;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">            <span class="keyword">while</span> (arr[j] &gt; pivot &amp;&amp; i &lt; j) &#123;</span><br><span class="line">                j--;</span><br><span class="line">            &#125;</span><br><span class="line">            arr[i] = arr[j];</span><br><span class="line">            <span class="keyword">while</span> (arr[i] &lt;= pivot &amp;&amp; i &lt; j) &#123; <span class="comment">// 其中一个 while 必须包含 &#x27;=&#x27; 的情况，不然排序会失败</span></span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            arr[j] = arr[i];</span><br><span class="line">        &#125;</span><br><span class="line">        arr[i] = pivot;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [13, 40, 60, 68, 78, 82, 91, 92, 96, 99]</span></span><br></pre></td></tr></table></figure>

<h2 id="Arrays-sort-实现"><a href="#Arrays-sort-实现" class="headerlink" title="Arrays.sort 实现"></a>Arrays.sort 实现</h2><p>Arrays 在进行 sort 排序的时候可能会采用 插入排序，双轴快排 或 归并排序。具体判断流出如下</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">+--------------+                                                                                                                                      </span><br><span class="line">| Arrays.sort()|                                                                                                                                      </span><br><span class="line">+--------------+                                                                                                                                      </span><br><span class="line">        |                                                                                                                                             </span><br><span class="line">        |                                                                                                                                             </span><br><span class="line">        |                                                                                                                                             </span><br><span class="line">        |                                                                                                                                             </span><br><span class="line">        v                                                                                                                                             </span><br><span class="line"> +-------------+      N          +----------------------------+                                                                                       </span><br><span class="line"> |length &lt; 286 |---------------&gt; | check if arr nearly sorted |                                                                                       </span><br><span class="line"> +-------------+                 +----------------------------+                                                                                       </span><br><span class="line">        |             N                         |                                                                                                     </span><br><span class="line">        |&lt;--------------------------------------|                                                                                                     </span><br><span class="line">        |                                       |                                                                                                     </span><br><span class="line">        v                                       |                                                                                                     </span><br><span class="line"> +-------------+      N                         |                                                                                                     </span><br><span class="line"> |length &lt; 47  |--------------                  |Y                                                                                                    </span><br><span class="line"> +-------------+             |                  |                                                                                                     </span><br><span class="line">        |                    |                  |                                                                                                     </span><br><span class="line">        |Y                   |                  |                                                                                                     </span><br><span class="line">        |                    |                  |                                                                                                     </span><br><span class="line">        v                    v                  v                                                                                                     </span><br><span class="line">+----------------+     +------------+     +------------+                                                                                              </span><br><span class="line">| insertion sort |     | quick sort |     | merge sort |                                                                                              </span><br><span class="line">+----------------+     +------------+     +------------+                                                                                              </span><br><span class="line">        |                    |                  |                                                                                                     </span><br><span class="line">        |                    |                  |                                                                                                     </span><br><span class="line">        v                    |                  |                                                                                                     </span><br><span class="line">  +-------------+            |                  |                                                                                                     </span><br><span class="line">  | finish sort | &lt;------------------------------                                                                                                     </span><br><span class="line">  +-------------+                                                                                                                                     </span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jack-zheng.github.io/hexo/hexo/2021/04/01/JVM-c12-java-memory-model-and-thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/jack.jpg">
      <meta itemprop="name" content="Jack Zheng">
      <meta itemprop="description" content="我是张江搬砖小码农, 知识搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jackpot">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/hexo/2021/04/01/JVM-c12-java-memory-model-and-thread/" class="post-title-link" itemprop="url">Java内存模型与线程</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-01 18:45:44" itemprop="dateCreated datePublished" datetime="2021-04-01T18:45:44+08:00">2021-04-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-16 13:29:44" itemprop="dateModified" datetime="2022-02-16T13:29:44+08:00">2022-02-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo/categories/JVM/" itemprop="url" rel="index">
                    <span itemprop="name">JVM</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>深入理解 Java 虚拟机第 12 章Java内存模型与线程笔记</p>
<h2 id="12-3-Java-内存模型"><a href="#12-3-Java-内存模型" class="headerlink" title="12.3 Java 内存模型"></a>12.3 Java 内存模型</h2><p>Java 内存模型(JMM) 用来屏蔽各种硬件和操作系统的内存访问差异，已实现 Java 程序在各种平台下都能达到一致的内存访问效果。 PS：看起来这就是传说中的一次编译，到处运行的功能吧。</p>
<h3 id="12-3-1-主内存和工作内存"><a href="#12-3-1-主内存和工作内存" class="headerlink" title="12.3.1 主内存和工作内存"></a>12.3.1 主内存和工作内存</h3><p>JMM 规定，</p>
<ul>
<li>所有变量都存储在主内存(Main Memory)中</li>
<li>每条线程有自己的工作内存(Working Memory)</li>
<li>线程对变量的所有操作都必须在工作内存中进行，而不能直接读写主内存中的数据</li>
<li>不同线程不能访问对方的工作内存中的变量</li>
<li>线程间值传递需要通过主内存完成</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+-----------+          +-----------+           +-------+                                                                                             </span><br><span class="line">| Java      |  &lt;-----&gt; | Working   |  &lt;-----&gt;  |       |                                                                                             </span><br><span class="line">| Thread    |          | Memory    |           |       |         +---------------+                                                                   </span><br><span class="line">+-----------+          +-----------+           | Save  |         |               |                                                                   </span><br><span class="line">                                               | &amp;     |         |  Main Memory  |                                                                   </span><br><span class="line">+-----------+          +-----------+           | Load  | &lt;-----&gt; |               |                                                                   </span><br><span class="line">| Java      |          | Working   |           |       |         |               |                                                                   </span><br><span class="line">| Thread    |  &lt;-----&gt; | Memory    |  &lt;-----&gt;  |       |         |               |                                                                   </span><br><span class="line">+-----------+          +-----------+           |       |         |               |                                                                   </span><br><span class="line">                                               |       |         |               |                                                                   </span><br><span class="line">+-----------+          +-----------+           |       |         +---------------+                                                                   </span><br><span class="line">| Java      |          | Working   |           |       |                                                                                             </span><br><span class="line">| Thread    |  &lt;-----&gt; | Memory    |  &lt;-----&gt;  |       |                                                                                             </span><br><span class="line">+-----------+          +-----------+           +-------+                                </span><br></pre></td></tr></table></figure>

<h3 id="12-3-2-内存间交互操作"><a href="#12-3-2-内存间交互操作" class="headerlink" title="12.3.2 内存间交互操作"></a>12.3.2 内存间交互操作</h3><p>JMM 规定了主内存和工作内存之间的具体交互协议，定义了 8 中操作，这些操作都要求是原子的，不可再分的(对 double/long 类型的变量来说， laod, store,read,write 操作在某些平台上允许例外)</p>
<ul>
<li>lock - 作用主内存，把变量标识为线程独占</li>
<li>unlock - 作用主内存，把变量从锁定状态释放</li>
<li>read - 作用主内存，将变量从主内存传输到工作内存</li>
<li>load - 作用工作内存，把 read 操作得到的变量放入工作内存的变量副本中</li>
<li>use - 作用工作内存，把变量传给执行引擎</li>
<li>assign - 作用工作内存，将工作引擎计算结果赋值给变量</li>
<li>store - 作用工作内存，将工作内存变量值传给主内存</li>
<li>write - 作用主内存，把 store 操作传过来的变量放入主内存</li>
</ul>
<p>JMM 还对这八种操作做了一些限制，比如 store 和 write 必须顺序执行，不允许一个线程丢弃它最近的 assign 操作等，这些细节这里就不深究了，感觉是很理论的东西，以后真的用到了，再回头看啊。</p>
<h3 id="12-3-3-对于-volatile-型变量的特殊规则"><a href="#12-3-3-对于-volatile-型变量的特殊规则" class="headerlink" title="12.3.3 对于 volatile 型变量的特殊规则"></a>12.3.3 对于 volatile 型变量的特殊规则</h3><p>volatile 是 JVM 提供的最轻量级的同步机制，JMM 专门为他定义了一些特殊规则。当一个变量定义为 volatile 后，它具备两个特性：</p>
<ol>
<li>保证变量对所有线程的可见性，当一条线程修改了这个变量的值，新值对于其他线程立即可知</li>
<li>禁止指令重排序优化 - PS: java 1.5 之前这个关键字有问题，并不能保证可见性</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 实验 #1 volatile 虽然是线程可见的，但是多线程同时写操作时依然线程不安全</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 声明一个 volatile 的 int 变量，给初始值 0，起 20 个线程，每个线程都对变量做 10000 次加 1 操作，统计最终计算结果。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 结论：虽然 volatile 保证了变量的线程可见性，但是由于 race++ 是非原子性的。具体情况可能如下：</span></span><br><span class="line"><span class="comment">* 线程A：进行累加操作，取得计算前的值 100，并进行累加操作</span></span><br><span class="line"><span class="comment">* 线程B：取得累加前的值 100 进行操作</span></span><br><span class="line"><span class="comment">* 线程A：完成操作 101 并赋值给主内存</span></span><br><span class="line"><span class="comment">* 线程B：完成操作 101 并赋值给主内存</span></span><br><span class="line"><span class="comment">* 所以计算结果总是小于理论值 20 0000</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> race = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">                    race++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 这个实验用 Idea 会失败，Idea 在起线程的时候会通过守护进程的方式，所以 activeCount 一直为 2, 死循环。使用 Eclipse 则能正常工作。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (Thread.activeCount() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(race);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 34490</span></span><br></pre></td></tr></table></figure>

<p>volatile 只保证可见性，在不符合以下两条规则的运算场景中，还是需要通过加锁保证原子性：</p>
<ul>
<li>运算结果并不依赖变量的当前值，或者能够保证只有单一的线程修改变量值</li>
<li>变量不需要与其他的状态变量共同参与不变约束</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 实验 #2-1</span></span><br><span class="line"><span class="comment">* 禁止指令重排序优化为代码。在没有添加 volatile 修饰的时候，由于指令重排序优化，initialized = true 可能被提前执行，导致线程 B 执行异常</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">Map configOptions;</span><br><span class="line"><span class="keyword">char</span>[] configText;</span><br><span class="line"><span class="comment">// 此变量必须定义为 volatile</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设以下代码在线程 A 中进行</span></span><br><span class="line"><span class="comment">// 模拟读取配置星系，当读取完成后</span></span><br><span class="line"><span class="comment">// 将 initialized 设置为 true，同志其他线程配置可用</span></span><br><span class="line">configOptions = <span class="keyword">new</span> HashMap();</span><br><span class="line">configText = readConfigFile(fileName);</span><br><span class="line">processConfigOptions(configText, configOptions);</span><br><span class="line">initialized = <span class="keyword">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设以下代码在线程 B 中进行</span></span><br><span class="line"><span class="comment">// 等待 initialized 为 true，代表 A 已完成初始化</span></span><br><span class="line"><span class="keyword">while</span>(!initialized) &#123;</span><br><span class="line">    sleep();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用线程 A 中初始化好的配置信息</span></span><br><span class="line">doSomethingWithConfig();</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 实验 #2-2</span></span><br><span class="line"><span class="comment">* DCL 双锁检测</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            syncronized(Singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Singleton.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本章最后还介绍了 volatile 底层实现和 JMM 中定义的规则，暂时就不深入了。</p>
<h3 id="12-3-4-针对-long-和-double-型变量的特殊规则"><a href="#12-3-4-针对-long-和-double-型变量的特殊规则" class="headerlink" title="12.3.4 针对 long 和 double 型变量的特殊规则"></a>12.3.4 针对 long 和 double 型变量的特殊规则</h3><p>虚拟机允许将没有被 volatile 修饰的 64 位数据的读写操作分为两次 32 位的操作进行，即不保证 64 位数据类型的 load, store, read, write 的原子性。这就是所谓的 ‘long 和 double 的非原子性协定’， 目前主流商用 64 位虚拟机并不会出现非原子访问。</p>
<h3 id="12-3-5-原子性，可见性与有序性"><a href="#12-3-5-原子性，可见性与有序性" class="headerlink" title="12.3.5 原子性，可见性与有序性"></a>12.3.5 原子性，可见性与有序性</h3><p><strong>原子性</strong>：JMM 直接保证 read, load, assign, use, store 和 write 操作的原子性，对于一个更大范围的原子性保证，JMM 提供了 lock 和 unlock 这两个操作，反应到字节码就是 monitorenter/monitorexit，Java 代码层面就是 synchronized 关键字了</p>
<p><strong>可见性</strong>：当一个线程修改了共享变量值时，其他线程能够立即得知这个修改。对于 volatile 类型的数据，JMM 通过修改后立即同步回主内存，在变量读取前刷新变量值以保证可见性，普通变量不是立即执行的。</p>
<p>除了 volatile 外，synchronized 和 final 也能实现可见性。synchronized 通过规则：在 unlock 之前必须把此变量同步回主内存中(执行 store，write)来达到目的。final 的可见性指：被 final 修饰的字段在构造器中一旦被初始化完成，并且构造器没有吧 this 引用传递出去，那么其他线程就能看到 final 字段的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* i， j 都具备可见性，不许同步就可以被其他线程访问</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 后续省略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 可也以在构造函数中初始化</span></span><br><span class="line">    j = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 后续省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>有序性</strong>：如果在本线程内观察，所有的操作都是有序的；如果在一个线程中观察另一个线程，所有操作都是无序的。volatile 和 synchronized 关键字可用于保证线程操作之间的有序性，volatile 本省包含禁止指令重排的语义，而 synchronized 则是由 ‘一个变量在同一时刻只允许一条线程对其进行 lock 操作’ 的这条规则决定。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jack-zheng.github.io/hexo/hexo/2021/03/26/Interview-concurrency/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/jack.jpg">
      <meta itemprop="name" content="Jack Zheng">
      <meta itemprop="description" content="我是张江搬砖小码农, 知识搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jackpot">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/hexo/2021/03/26/Interview-concurrency/" class="post-title-link" itemprop="url">Java 面试之多线程</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-26 16:23:12" itemprop="dateCreated datePublished" datetime="2021-03-26T16:23:12+08:00">2021-03-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-16 13:29:44" itemprop="dateModified" datetime="2022-02-16T13:29:44+08:00">2022-02-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/" itemprop="url" rel="index">
                    <span itemprop="name">面试题</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>备忘一下多线程相关的面试题</p>
<h2 id="Java-如何开启线程，怎么保证线程安全"><a href="#Java-如何开启线程，怎么保证线程安全" class="headerlink" title="Java 如何开启线程，怎么保证线程安全"></a>Java 如何开启线程，怎么保证线程安全</h2><p>进程是操作系统分配<strong>资源</strong>的最小系统，线程是系统进行分配<strong>任务</strong>的最小单元，线程隶属于进程。</p>
<p>如何开启：</p>
<ol>
<li>继承 Thread, 重写 run 方法</li>
<li>实现 Runable 接口，实现 run 方法</li>
<li>实现 Callable 接口，实现 call 方法。通过 FeatureTask 创建一个线程，获取线程执行返回结果</li>
<li>通过线程池开启线程</li>
</ol>
<p>3，4 有对应的只是储备可以延伸一下，不然就别提了, 这两个都是在 concurrent 包下的，等学习那个包的时候再看</p>
<p>为什么要有以上两种方式：Java 采用单继承，多实现的设计模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// extends class 实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadDemo</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ThreadDemo print count: &quot;</span> + i)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ThreadDemo threadDemo1 = <span class="keyword">new</span> ThreadDemo();</span><br><span class="line">        ThreadDemo threadDemo2 = <span class="keyword">new</span> ThreadDemo();</span><br><span class="line">        ThreadDemo threadDemo3 = <span class="keyword">new</span> ThreadDemo();</span><br><span class="line">        threadDemo1.start();</span><br><span class="line">        threadDemo2.start();</span><br><span class="line">        threadDemo3.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以用 lambda 简写, 但是 lambda 的形式是不能复用的，一次性产品</span></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">&quot;ThreadDemo print count: &quot;</span> + i)).start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// implement class 实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunnableDemo</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; - RunnableDemo count: &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RunnableDemo runnableDemo = <span class="keyword">new</span> RunnableDemo();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(runnableDemo, <span class="string">&quot;1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(runnableDemo, <span class="string">&quot;2&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(runnableDemo, <span class="string">&quot;3&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>怎么保证线程安全：加锁</p>
<ol>
<li>JVM 锁， Synchronized</li>
<li>JDK 锁， Lock</li>
</ol>
<h2 id="Volatile-和-Synchronized-有什么区别？-Volatile-能不能保证线程安全？-DCL-Double-Check-Lock-单例为什么要加-Volatile"><a href="#Volatile-和-Synchronized-有什么区别？-Volatile-能不能保证线程安全？-DCL-Double-Check-Lock-单例为什么要加-Volatile" class="headerlink" title="Volatile 和 Synchronized 有什么区别？ Volatile 能不能保证线程安全？ DCL(Double Check Lock) 单例为什么要加 Volatile?"></a>Volatile 和 Synchronized 有什么区别？ Volatile 能不能保证线程安全？ DCL(Double Check Lock) 单例为什么要加 Volatile?</h2><p>Syncronized 用于加锁。Volatile 只保持变量的线程可见性，通常用于一个线程写，多个线程读取的情况</p>
<p>Volatile 不能保证线程安全，只保证可见行，不保证原子性</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="comment">/**volatile**/</span> <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (flag) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;-------- End Thread --------&quot;</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;-------- Set flag to false --------&quot;</span>);</span><br><span class="line">        flag = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当注释掉 volatile 时，终端只输出 set flag 提示并挂起</span></span><br><span class="line"><span class="comment">// -------- Set flag to false --------</span></span><br><span class="line"><span class="comment">// 当使用 volatile 时，程序正常结束</span></span><br><span class="line"><span class="comment">// -------- Set flag to false --------</span></span><br><span class="line"><span class="comment">// -------- End Thread --------</span></span><br></pre></td></tr></table></figure>

<p>TODO: 补一张主/从内存 copy 图</p>
<p>DCL(Double Check Lock) 单例为什么要加 Volatile：防止指令重排，防止高并发下指令重拍导致的线程安全问题。</p>
<p>DCL 示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 懒汉式 DCL, 懒加载, 只在要用到的时候实例化</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 一定要加 volatile 不然并不安全, 第一次写的时候还错了。 https://www.jianshu.com/p/246e8f72dc9a 解释的挺清楚,</span></span><br><span class="line"><span class="comment">    * 简而言之，不加的话会有指令重排的可能。</span></span><br><span class="line"><span class="comment">    * singleDemo = new SingleDemo(); 在代码层面可以分为三步:</span></span><br><span class="line"><span class="comment">    *   分配空间</span></span><br><span class="line"><span class="comment">    *   构建实例</span></span><br><span class="line"><span class="comment">    *   实例赋值</span></span><br><span class="line"><span class="comment">    * 重排之后 实例赋值 可能要比构建实例先执行，</span></span><br><span class="line"><span class="comment">    * 那么其他线程在判断 null == singleDemo 时就会判断为 true, 但是后续对该实例地址上对象操作时可能由于实例还没有构建完成而出现异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> SingleDemo singleDemo; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleDemo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleDemo <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == singleDemo) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SingleDemo.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == singleDemo) &#123;</span><br><span class="line">                    singleDemo = <span class="keyword">new</span> SingleDemo();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singleDemo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 饿汉式 DCL, 类加载即实例化</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Single single = <span class="keyword">new</span> Single();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 私有化构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Single <span class="title">getSingle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> single;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TODO: 补图</p>
<h2 id="Java-线程锁机制是什么怎么样的？偏向锁，轻量级锁，重量级锁有什么区别，锁机制如何升级"><a href="#Java-线程锁机制是什么怎么样的？偏向锁，轻量级锁，重量级锁有什么区别，锁机制如何升级" class="headerlink" title="Java 线程锁机制是什么怎么样的？偏向锁，轻量级锁，重量级锁有什么区别，锁机制如何升级"></a>Java 线程锁机制是什么怎么样的？偏向锁，轻量级锁，重量级锁有什么区别，锁机制如何升级</h2><p>和视频给的结果不一样，视频中，只有 markword 不一样，体现出这个标志位表示了锁状态，表示很清楚问什么，难道是平台问题，回去后用 Windows 试一下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.openjdk.jol/jol-core --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jol<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jol-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.14<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 可以打印出 Java 对象在内存中的分布情况 --&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JolDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Object o = <span class="keyword">new</span> Object();</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(o).toPrintable());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (o) &#123;</span><br><span class="line">            System.out.println(ClassLayout.parseInstance(o).toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// java.lang.Object object internals:</span></span><br><span class="line"><span class="comment">//  OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span></span><br><span class="line"><span class="comment">//       0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span></span><br><span class="line"><span class="comment">//       4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span></span><br><span class="line"><span class="comment">//       8     4        (object header)                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)</span></span><br><span class="line"><span class="comment">//      12     4        (loss due to the next object alignment)</span></span><br><span class="line"><span class="comment">// Instance size: 16 bytes</span></span><br><span class="line"><span class="comment">// Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// java.lang.Object object internals:</span></span><br><span class="line"><span class="comment">//  OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span></span><br><span class="line"><span class="comment">//       0     4        (object header)                           d0 a9 41 0d (11010000 10101001 01000001 00001101) (222407120)</span></span><br><span class="line"><span class="comment">//       4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span></span><br><span class="line"><span class="comment">//       8     4        (object header)                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)</span></span><br><span class="line"><span class="comment">//      12     4        (loss due to the next object alignment)</span></span><br><span class="line"><span class="comment">// Instance size: 16 bytes</span></span><br><span class="line"><span class="comment">// Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span></span><br></pre></td></tr></table></figure>

<p>Java 的锁就是在对象的 Markword 中记录的一种状态，无锁，偏向锁，轻量级锁，重量级锁 对应标志位的不同状态</p>
<p>Java 的锁机制就是根据资源竞争的激烈程度不断进行锁升级的过程</p>
<p>TODO：补图</p>
<p>JVM 锁优化：休眠 5s 之后对象自带偏向锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JolDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Object o = <span class="keyword">new</span> Object();</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(o).toPrintable());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// -XX:UseBiasedLocking 是否打开偏向所，默认关闭</span></span><br><span class="line">        <span class="comment">// -XX:BiasedLockingStartupDelay 默认开启</span></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        Object o2 = <span class="keyword">new</span> Object();</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(o2).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// java.lang.Object object internals:</span></span><br><span class="line"><span class="comment">//  OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span></span><br><span class="line"><span class="comment">//       0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span></span><br><span class="line"><span class="comment">//       4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span></span><br><span class="line"><span class="comment">//       8     4        (object header)                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)</span></span><br><span class="line"><span class="comment">//      12     4        (loss due to the next object alignment)</span></span><br><span class="line"><span class="comment">// Instance size: 16 bytes</span></span><br><span class="line"><span class="comment">// Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// java.lang.Object object internals:</span></span><br><span class="line"><span class="comment">//  OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span></span><br><span class="line"><span class="comment">//       0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)</span></span><br><span class="line"><span class="comment">//       4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span></span><br><span class="line"><span class="comment">//       8     4        (object header)                           e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243)</span></span><br><span class="line"><span class="comment">//      12     4        (loss due to the next object alignment)</span></span><br><span class="line"><span class="comment">// Instance size: 16 bytes</span></span><br><span class="line"><span class="comment">// Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span></span><br></pre></td></tr></table></figure>

<h2 id="谈谈对-AQS-的理解"><a href="#谈谈对-AQS-的理解" class="headerlink" title="谈谈对 AQS 的理解"></a>谈谈对 AQS 的理解</h2><h2 id="有-ABC-三个线程，如何保证三个线程同时执行，如何在并发情况下保证三个线程一次执行，如何保证三个线程有序交错进行"><a href="#有-ABC-三个线程，如何保证三个线程同时执行，如何在并发情况下保证三个线程一次执行，如何保证三个线程有序交错进行" class="headerlink" title="有 ABC 三个线程，如何保证三个线程同时执行，如何在并发情况下保证三个线程一次执行，如何保证三个线程有序交错进行"></a>有 ABC 三个线程，如何保证三个线程同时执行，如何在并发情况下保证三个线程一次执行，如何保证三个线程有序交错进行</h2><h2 id="如何对一个字符串快速进行排序（多线程快排）"><a href="#如何对一个字符串快速进行排序（多线程快排）" class="headerlink" title="如何对一个字符串快速进行排序（多线程快排）"></a>如何对一个字符串快速进行排序（多线程快排）</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jack-zheng.github.io/hexo/hexo/2021/03/19/Java-variable-assignment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/jack.jpg">
      <meta itemprop="name" content="Jack Zheng">
      <meta itemprop="description" content="我是张江搬砖小码农, 知识搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jackpot">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/hexo/2021/03/19/Java-variable-assignment/" class="post-title-link" itemprop="url">变量赋值，跌进了坑中</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-19 21:24:05" itemprop="dateCreated datePublished" datetime="2021-03-19T21:24:05+08:00">2021-03-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-16 13:29:44" itemprop="dateModified" datetime="2022-02-16T13:29:44+08:00">2022-02-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天在修一个 feature 的时候，掉进了一个很初级的坑中而不自觉，debug 了好久才发现的，汗颜</p>
<h2 id="问题简化"><a href="#问题简化" class="headerlink" title="问题简化"></a>问题简化</h2><p>求解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String , Integer&gt; map;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Integer&gt; <span class="title">getMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestScope</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Integer&gt; tmp = person.getMap();</span><br><span class="line">        System.out.println(tmp); <span class="comment">// null</span></span><br><span class="line">        System.out.println(person.getMap()); <span class="comment">// null</span></span><br><span class="line"></span><br><span class="line">        tmp = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        tmp.put(<span class="string">&quot;jack&quot;</span>, <span class="number">31</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(tmp); <span class="comment">// &#123;jack=31&#125;</span></span><br><span class="line">        System.out.println(person.getMap()); <span class="comment">// null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>debug 的时候还一直纳闷，怎么 person 引用没有被赋值。。。作为对比看下面的例子应该就很清楚了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String , Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// 带初始化引用类型的</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Integer&gt; <span class="title">getMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestScope</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Integer&gt; tmp = person.getMap();</span><br><span class="line">        System.out.println(tmp); <span class="comment">// &#123;&#125;</span></span><br><span class="line">        System.out.println(person.getMap()); <span class="comment">// &#123;&#125;</span></span><br><span class="line"></span><br><span class="line">        tmp.put(<span class="string">&quot;jack&quot;</span>, <span class="number">31</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(tmp); <span class="comment">// &#123;jack=31&#125;</span></span><br><span class="line">        System.out.println(person.getMap()); <span class="comment">// &#123;jack=31&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在特殊化一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestScope</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Integer&gt; tmp = person.getMap();</span><br><span class="line">        System.out.println(tmp); <span class="comment">// &#123;&#125;</span></span><br><span class="line">        System.out.println(person.getMap()); <span class="comment">// &#123;&#125;</span></span><br><span class="line"></span><br><span class="line">        tmp.put(<span class="string">&quot;jack&quot;</span>, <span class="number">31</span>);</span><br><span class="line">        tmp = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        tmp.put(<span class="string">&quot;jerry&quot;</span>, <span class="number">21</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(tmp); <span class="comment">// &#123;jack=21&#125;</span></span><br><span class="line">        System.out.println(person.getMap()); <span class="comment">// &#123;jack=31&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结一下就是，改变引用类型的值没什么问题，但是如果一开始是 null 的话它就不会随着一起改了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jack-zheng.github.io/hexo/hexo/2021/03/18/Algorithm-reverse-list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/jack.jpg">
      <meta itemprop="name" content="Jack Zheng">
      <meta itemprop="description" content="我是张江搬砖小码农, 知识搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jackpot">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/hexo/2021/03/18/Algorithm-reverse-list/" class="post-title-link" itemprop="url">链表反转</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-18 19:21:42" itemprop="dateCreated datePublished" datetime="2021-03-18T19:21:42+08:00">2021-03-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-16 13:29:44" itemprop="dateModified" datetime="2022-02-16T13:29:44+08:00">2022-02-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>反转一个单链表。</p>
<p>示例:</p>
<p>输入: 1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;NULL<br>输出: 5-&gt;4-&gt;3-&gt;2-&gt;1-&gt;NULL<br>进阶: 你可以迭代或递归地反转链表。你能否用两种方法解决这道题？</p>
<h2 id="思路整理"><a href="#思路整理" class="headerlink" title="思路整理"></a>思路整理</h2><p>先想象一下最简单的模型，怎么将第一个元素反转？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    ListNode next;</span><br><span class="line"></span><br><span class="line">    ListNode(<span class="keyword">int</span> val) &#123;</span><br><span class="line">        <span class="keyword">this</span>.val = val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ListNode(<span class="keyword">int</span> val, ListNode next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.val = val;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> iterVal(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">iterVal</span><span class="params">(ListNode node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(node)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;null&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> node.val + <span class="string">&quot; -&gt; &quot;</span> + iterVal(node.next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以声明一个空节点，然后把原始节点的第一个节点的 next 引用指向这个空节点就是我们想要的效果了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReverseList</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ListNode head = <span class="keyword">new</span> ListNode(<span class="number">1</span>, <span class="keyword">new</span> ListNode(<span class="number">2</span>, <span class="keyword">new</span> ListNode(<span class="number">3</span>, <span class="keyword">new</span> ListNode(<span class="number">4</span>, <span class="keyword">new</span> ListNode(<span class="number">5</span>, <span class="keyword">null</span>)))));</span><br><span class="line"></span><br><span class="line">        ListNode empty = <span class="keyword">null</span>;</span><br><span class="line">        head.next = empty;</span><br><span class="line">        System.out.println(head);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1 -&gt; null</span></span><br></pre></td></tr></table></figure>

<p>为了遍历后续的节点，我们需要在 head.next = empty 之前用另一变量来持有这个 next 引用 <code>ListNode holder1 = head.next;</code>。处理第二个节点的时候，我们其实重复了之前的操作，将它单独拆下来，然后拼接到 head 前面即可。按照这个思路，我可以直接联想使用 while 循环处理这个问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReverseList</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ListNode head = <span class="keyword">new</span> ListNode(<span class="number">1</span>, <span class="keyword">new</span> ListNode(<span class="number">2</span>, <span class="keyword">new</span> ListNode(<span class="number">3</span>, <span class="keyword">new</span> ListNode(<span class="number">4</span>, <span class="keyword">new</span> ListNode(<span class="number">5</span>, <span class="keyword">null</span>)))));</span><br><span class="line">        System.out.println(head);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ListNode result = <span class="keyword">null</span>;</span><br><span class="line">        ListNode holder;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(head != <span class="keyword">null</span>) &#123;</span><br><span class="line">            holder = head.next;</span><br><span class="line">            head.next = result;</span><br><span class="line">            result = head;</span><br><span class="line">            head = holder;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1 -&gt; 2 -&gt; 3 -&gt; 4 -&gt; 5 -&gt; null</span></span><br><span class="line"><span class="comment">// 5 -&gt; 4 -&gt; 3 -&gt; 2 -&gt; 1 -&gt; null</span></span><br></pre></td></tr></table></figure>

<p>把上面的实现精简一下就是迭代法了 (●°u°●)​ 」</p>
<h2 id="迭代法"><a href="#迭代法" class="headerlink" title="迭代法"></a>迭代法</h2><p>想象的模型比较重要，我们准备两个空节点，一个用来拼接解析出来的节点，作为返回值，另一个用来持有后续节点，用来循环。</p>
<p>他这边有一个很奇特的点，就是平时我们在做链表操作的时候很多情况是<strong>持有一个最后的节点</strong>通过调用 node1.next = node2 的方式，在尾部拼接。但是这里的解体思路恰恰是相反的的，拿到一个新节点，通过 givenNode.next = node1 这种方式在头部拼接。第一次做的时候这个弯弯很难绕</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * input:  1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;NULL</span></span><br><span class="line"><span class="comment"> * output: 5-&gt;4-&gt;3-&gt;2-&gt;1-&gt;NULL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReverseListSample</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ListNode fir = <span class="keyword">new</span> ListNode(<span class="number">1</span>, <span class="keyword">new</span> ListNode(<span class="number">2</span>, <span class="keyword">new</span> ListNode(<span class="number">3</span>, <span class="keyword">new</span> ListNode(<span class="number">4</span>, <span class="keyword">new</span> ListNode(<span class="number">5</span>)))));</span><br><span class="line">        System.out.println(fir.toString());</span><br><span class="line"></span><br><span class="line">        ListNode ret = reverseList(fir);</span><br><span class="line">        System.out.println(ret.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ListNode <span class="title">reverseList</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">        ListNode next;</span><br><span class="line">        ListNode pre = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> (Objects.nonNull(head)) &#123;</span><br><span class="line">            next = head.next;</span><br><span class="line">            head.next = pre;</span><br><span class="line">            pre = head;</span><br><span class="line">            head = next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pre;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1 -&gt; 2 -&gt; 3 -&gt; 4 -&gt; 5 -&gt; null</span></span><br><span class="line"><span class="comment">// 5 -&gt; 4 -&gt; 3 -&gt; 2 -&gt; 1 -&gt; null</span></span><br></pre></td></tr></table></figure>

<h2 id="递归法"><a href="#递归法" class="headerlink" title="递归法"></a>递归法</h2><p>核心思想和前面的一致，具体到做表现形式上，我自己想出来的解法需要额外传入一个参数作为结果，有点累赘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ListNode <span class="title">reverseList</span><span class="params">(ListNode head, ListNode result)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Objects.isNull(head))</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    ListNode holder = head.next;</span><br><span class="line">    head.next = result;</span><br><span class="line">    <span class="comment">// 思路还是很清晰的， 先把传入的节点分离出来， 然后在作为 result 的节点前面一次添加分离出来的节点。当所有的节点都处理过后，返回</span></span><br><span class="line">    <span class="keyword">return</span> reverseList(holder, head);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>搜索了一下单参数的解法</p>
<p>我们可以用 分治 的观点来看这个问题会更简单。终止条件为判空。否则，我们再次调用递归方法，拿到逆序结果。它骚就骚在一般我们的递归都是直接返回的，而它则是还要做一些操作。</p>
<p>但是值得注意的是，返回的结果是不能参与操作的，不然引用就会发生变化。必须通过现成的变量操作，不然循环就会被打破了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ListNode <span class="title">reverseList</span><span class="params">(ListNode current)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="keyword">null</span> || current.next == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> current;</span><br><span class="line"></span><br><span class="line">    ListNode next = current.next; <span class="comment">// 拿到后续节点</span></span><br><span class="line">    </span><br><span class="line">    ListNode ret = reverseList(next); <span class="comment">// 拿到计算结果</span></span><br><span class="line">    current.next = <span class="keyword">null</span>; <span class="comment">// 打断当前节点, 防止闭环</span></span><br><span class="line">    next.next = current; <span class="comment">// 习惯性的写成 ret.next = current, 这样会打破迭代规律</span></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/hexo/page/9/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/hexo/">1</a><span class="space">&hellip;</span><a class="page-number" href="/hexo/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/hexo/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/hexo/page/22/">22</a><a class="extend next" rel="next" href="/hexo/page/11/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jack Zheng"
      src="/hexo/images/jack.jpg">
  <p class="site-author-name" itemprop="name">Jack Zheng</p>
  <div class="site-description" itemprop="description">我是张江搬砖小码农, 知识搬运工</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/hexo/archives/">
        
          <span class="site-state-item-count">212</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/hexo/categories/">
          
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/hexo/tags/">
          
        <span class="site-state-item-count">191</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack Zheng</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">1.1m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">16:28</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v5.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.5.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/hexo/lib/anime.min.js"></script>
  <script src="/hexo/lib/velocity/velocity.min.js"></script>
  <script src="/hexo/lib/velocity/velocity.ui.min.js"></script>

<script src="/hexo/js/utils.js"></script>

<script src="/hexo/js/motion.js"></script>


<script src="/hexo/js/schemes/muse.js"></script>


<script src="/hexo/js/next-boot.js"></script>




  




  
<script src="/hexo/js/local-search.js"></script>














  

  


</body>
</html>
