<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/hexo/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/hexo/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/hexo/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/hexo/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="UgODgWVmvTsdD--vjodDR3tPUZRWM3i7JpHzbYejxUM">

<link rel="stylesheet" href="/hexo/css/main.css">


<link rel="stylesheet" href="/hexo/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/hexo/',
    scheme: 'Muse',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="学后总结 虚拟机 Vs 容器 常用命令 Nginx 镜像操作实践 Tomcat 镜像操作实践 部署 ES + kibana 操作实践 可视化 Docker 镜像加载原理 制作镜像 数据卷 安装 MySQL 操作实践 具名挂载 Vs 匿名挂载 数据共享 初识 Dockerfile Dockerfile CMD Vs ENTRYPOINT 实战： 制作 Tomcat 镜像 docker0 网络详解">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker 弹射起步">
<meta property="og:url" content="https://jack-zheng.github.io/hexo/2021/04/15/Docker-quick-start/index.html">
<meta property="og:site_name" content="Jackpot">
<meta property="og:description" content="学后总结 虚拟机 Vs 容器 常用命令 Nginx 镜像操作实践 Tomcat 镜像操作实践 部署 ES + kibana 操作实践 可视化 Docker 镜像加载原理 制作镜像 数据卷 安装 MySQL 操作实践 具名挂载 Vs 匿名挂载 数据共享 初识 Dockerfile Dockerfile CMD Vs ENTRYPOINT 实战： 制作 Tomcat 镜像 docker0 网络详解">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jack-zheng.github.io/hexo/2021/04/15/Docker-quick-start/docker_network.png">
<meta property="og:image" content="https://jack-zheng.github.io/hexo/2021/04/15/Docker-quick-start/docker_network01.png">
<meta property="og:image" content="https://jack-zheng.github.io/hexo/2021/04/15/Docker-quick-start/redis.png">
<meta property="og:image" content="https://jack-zheng.github.io/hexo/2021/04/15/Docker-quick-start/how_node_work.png">
<meta property="article:published_time" content="2021-04-15T11:59:17.000Z">
<meta property="article:modified_time" content="2021-07-13T12:08:04.728Z">
<meta property="article:author" content="Jack Zheng">
<meta property="article:tag" content="docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jack-zheng.github.io/hexo/2021/04/15/Docker-quick-start/docker_network.png">

<link rel="canonical" href="https://jack-zheng.github.io/hexo/2021/04/15/Docker-quick-start/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Docker 弹射起步 | Jackpot</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/hexo/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jackpot</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-tags">

    <a href="/hexo/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/hexo/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/hexo/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/jack-zheng" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jack-zheng.github.io/hexo/hexo/2021/04/15/Docker-quick-start/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/jack.jpg">
      <meta itemprop="name" content="Jack Zheng">
      <meta itemprop="description" content="我是张江搬砖小码农, 知识搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jackpot">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Docker 弹射起步
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-15 19:59:17" itemprop="dateCreated datePublished" datetime="2021-04-15T19:59:17+08:00">2021-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-13 20:08:04" itemprop="dateModified" datetime="2021-07-13T20:08:04+08:00">2021-07-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo/categories/%E5%BC%B9%E5%B0%84%E8%B5%B7%E6%AD%A5/" itemprop="url" rel="index">
                    <span itemprop="name">弹射起步</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>63k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>57 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li><a href="#学后总结">学后总结</a></li>
<li><a href="#虚拟机-vs-容器">虚拟机 Vs 容器</a></li>
<li><a href="#常用命令">常用命令</a></li>
<li><a href="#nginx-镜像操作实践">Nginx 镜像操作实践</a></li>
<li><a href="#tomcat-镜像操作实践">Tomcat 镜像操作实践</a></li>
<li><a href="#部署-es--kibana-操作实践">部署 ES + kibana 操作实践</a></li>
<li><a href="#可视化">可视化</a></li>
<li><a href="#docker-镜像加载原理">Docker 镜像加载原理</a></li>
<li><a href="#制作镜像">制作镜像</a></li>
<li><a href="#数据卷">数据卷</a></li>
<li><a href="#安装-mysql-操作实践">安装 MySQL 操作实践</a></li>
<li><a href="#具名挂载-vs-匿名挂载">具名挂载 Vs 匿名挂载</a></li>
<li><a href="#数据共享">数据共享</a></li>
<li><a href="#初识-dockerfile">初识 Dockerfile</a></li>
<li><a href="#dockerfile">Dockerfile</a></li>
<li><a href="#cmd-vs-entrypoint">CMD Vs ENTRYPOINT</a></li>
<li><a href="#实战-制作-tomcat-镜像">实战： 制作 Tomcat 镜像</a></li>
<li><a href="#docker0-网络详解">docker0 网络详解</a></li>
<li><a href="#--link">–link</a></li>
<li><a href="#自定义网络">自定义网络</a></li>
<li><a href="#网络联通">网络联通</a></li>
<li><a href="#实战部署-redis-集群">实战：部署 Redis 集群</a></li>
<li><a href="#springboot-微服务打包-docker-镜像">SpringBoot 微服务打包 Docker 镜像</a></li>
<li><a href="#docker-compose">Docker Compose</a></li>
<li><a href="#安装">安装</a></li>
<li><a href="#官方起步教程">官方起步教程</a></li>
<li><a href="#yaml-规则">YAML 规则</a></li>
<li><a href="#实战">实战</a></li>
<li><a href="#docker-swarm">Docker Swarm</a></li>
<li><a href="#raft-协议">Raft 协议</a></li>
<li><a href="#搭建集群">搭建集群</a></li>
<li><a href="#概念总结">概念总结</a></li>
<li><a href="#以后还要学-go">以后还要学 Go</a></li>
<li><a href="#问题">问题</a></li>
</ul>
<h2 id="学后总结"><a href="#学后总结" class="headerlink" title="学后总结"></a>学后总结</h2><ul>
<li>基本了解了 docker 相关的整个生态的基本情况</li>
<li>熟悉了 docker 的基本用法</li>
<li>有机会要学一下 Go 语言</li>
</ul>
<h2 id="虚拟机-Vs-容器"><a href="#虚拟机-Vs-容器" class="headerlink" title="虚拟机 Vs 容器"></a>虚拟机 Vs 容器</h2><ul>
<li>虚拟机运行整个系统，在系统上安装运行软件</li>
<li>容器内的应用直接运行在宿主机内，容器没有自己的内核，也没有虚拟硬件</li>
</ul>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker client 信息显示</span></span><br><span class="line">docker version  <span class="comment"># docker engin, api 等的版本信息</span></span><br><span class="line">docker info     <span class="comment"># docker 环境信息，包括 image, container 数量，内核版本等</span></span><br><span class="line">docker --<span class="built_in">help</span>   <span class="comment"># 帮助</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像相关命令</span></span><br><span class="line">docker pull [OPTIONS] NAME[:TAG|@DIGEST]    <span class="comment"># 拉镜像</span></span><br><span class="line"><span class="comment"># Host&gt; docker pull mysql                   # 没有指定 tag 就默认下载 latest 版本</span></span><br><span class="line"><span class="comment"># Using default tag: latest</span></span><br><span class="line"><span class="comment"># latest: Pulling from library/mysql</span></span><br><span class="line"><span class="comment"># f7ec5a41d630: Already exists </span></span><br><span class="line"><span class="comment"># 9444bb562699: Pull complete               # 分层下载， docker image 的核心，联合文件系统</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># e47da95a5aab: Pull complete </span></span><br><span class="line"><span class="comment"># Digest: sha256:04ee7141256e83797ea4a84a4d31b1f1bc10111c8d1bc1879d52729ccd19e20a # 签名</span></span><br><span class="line"><span class="comment"># Status: Downloaded newer image for mysql:latest</span></span><br><span class="line"><span class="comment"># docker.io/library/mysql:latest            # 真实地址，等价于 docker pull docker.io/library/mysql:latest</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用参数</span></span><br><span class="line"><span class="comment"># -f: 强制删除</span></span><br><span class="line">docker rmi [OPTIONS] IMAGE [IMAGE...]               <span class="comment"># 删除镜像</span></span><br><span class="line">docker rmi -f $(docker images -aq)                  <span class="comment"># 组合命令，删除全部镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器相关</span></span><br><span class="line"><span class="comment"># 常用参数</span></span><br><span class="line"><span class="comment"># --name=&quot;my_name&quot;          # 指定容器名字</span></span><br><span class="line"><span class="comment"># -d                        # 后台运行</span></span><br><span class="line"><span class="comment"># -it                       # 交互方式运行，进去容器查看, 示例: docker run -it centos /bin/bash</span></span><br><span class="line"><span class="comment"># -p                        # 指定端口</span></span><br><span class="line"><span class="comment">#   -p ip:主机端口:容器端口</span></span><br><span class="line"><span class="comment">#   -p 主机端口:容器端口</span></span><br><span class="line"><span class="comment">#   -p 容器端口</span></span><br><span class="line"><span class="comment"># -P                        # 随机指定端口</span></span><br><span class="line"><span class="comment"># 常见坑：docker 容器使用后台运行，必须要给一个前台进程，如果 docker 发现没有应用就会自动停止</span></span><br><span class="line"><span class="comment"># 比如启动 nginx 容器，如果没有 -it 参数，容器就会立刻停止，ps 之后不会显示这个容器，加 -a 可以</span></span><br><span class="line">docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成临时 log</span></span><br><span class="line">docker run -d centos /bin/sh -c <span class="string">&quot;while true;do echo testlog;sleep 1;done&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -t                # 时间戳</span></span><br><span class="line"><span class="comment"># -f                # 持续打印</span></span><br><span class="line"><span class="comment"># --tail num        # 输出n条</span></span><br><span class="line"><span class="comment"># sample: docker logs -tf --tail 10 627b379be47a</span></span><br><span class="line">docker logs [OPTIONS] CONTAINER         <span class="comment"># 输出 console log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -a                # 所有容器, 包括已经停止的</span></span><br><span class="line"><span class="comment"># -aq               # 只显示容器 id</span></span><br><span class="line"><span class="comment"># -n=2 or -n 2      # 最近创建的2个容器</span></span><br><span class="line">docker ps [OPTIONS] <span class="comment"># 显示容器信息</span></span><br><span class="line"></span><br><span class="line">ctrl + p + q        <span class="comment"># 交互模式下推出容器并后台运行。mac 也是这个命令，不过 vscode 里不好使，应该是快捷键冲突</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -f                                                    # 强制移除</span></span><br><span class="line"><span class="comment"># sample: docker rm -f $(docker ps -qa)                 # 删除所有</span></span><br><span class="line"><span class="comment"># sample: docker ps -aq | xargs docker rm               # 通过 Linux pip 方式删除所有</span></span><br><span class="line">docker rm [OPTIONS] CONTAINER [CONTAINER...]            <span class="comment"># 删除容器，不能删除正在运行的容器，除非加 -f</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除由某个 image 生成的所有 containers</span></span><br><span class="line"><span class="comment"># 这里有个小技巧，先通过 docker ps 打印一下，避免误删：docker ps -a --filter ancestor=nginx</span></span><br><span class="line">docker rm -f $(docker ps -aq --filter ancestor=nginx)</span><br><span class="line"></span><br><span class="line">docker start [OPTIONS] CONTAINER [CONTAINER...]         <span class="comment"># 启动停止的容器</span></span><br><span class="line">docker restart [OPTIONS] CONTAINER [CONTAINER...]       <span class="comment"># 重启容器</span></span><br><span class="line">docker stop [OPTIONS] CONTAINER [CONTAINER...]          <span class="comment"># 停止容器</span></span><br><span class="line">docker docker <span class="built_in">kill</span> [OPTIONS] CONTAINER [CONTAINER...]   <span class="comment"># stop 报错了可以用这个强制杀进程</span></span><br><span class="line"></span><br><span class="line">docker top CONTAINER [ps OPTIONS]                       <span class="comment"># 显示容器中的进程, 如下显示志之前 log 例子的 top 信息</span></span><br><span class="line"><span class="comment"># docker top 627b379be47a</span></span><br><span class="line"><span class="comment"># UID          PID          PPID         C            STIME               TTY          TIME         CMD</span></span><br><span class="line"><span class="comment"># root         12866         12840       0            10:29               ?            00:00:00     /bin/bash -c while true; do echo testlog; sleep 1; done</span></span><br><span class="line"></span><br><span class="line">docker inspect [OPTIONS] NAME|ID [NAME|ID...]           <span class="comment"># 显示容器底层信息, 包括 id, image, 共享卷，网络等信息</span></span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Id&quot;: &quot;247d2a88573fdb2893a90a3d35275bfaa2889f7fa450d875456646ed684643d4&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Created&quot;: &quot;2021-04-20T13:06:45.2632089Z&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Path&quot;: &quot;/bin/sh&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Args&quot;: [</span></span><br><span class="line"><span class="comment">#             &quot;-c&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;while true;do echo testlog;sleep 1;done&quot;</span></span><br><span class="line"><span class="comment">#         ],</span></span><br><span class="line"><span class="comment">#         &quot;State&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;Status&quot;: &quot;running&quot;,</span></span><br><span class="line"><span class="comment">#             ...</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Image&quot;: &quot;sha256:300e315adb2f96afe5f0b2780b87f28ae95231fe3bdd1e16b9ba606307728f55&quot;,</span></span><br><span class="line"><span class="comment">#         ...</span></span><br><span class="line"><span class="comment">#         &quot;GraphDriver&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;Data&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/80783254f01fcdde559ac63ff7503d2dc317929d0328fb1c66846f9e519d98df/work&quot;</span></span><br><span class="line"><span class="comment">#                 ...</span></span><br><span class="line"><span class="comment">#             &#125;,</span></span><br><span class="line"><span class="comment">#             &quot;Name&quot;: &quot;overlay2&quot;</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Mounts&quot;: [],</span></span><br><span class="line"><span class="comment">#         &quot;Config&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             ...</span></span><br><span class="line"><span class="comment">#             &quot;Cmd&quot;: [</span></span><br><span class="line"><span class="comment">#                 &quot;/bin/sh&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;-c&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;while true;do echo testlog;sleep 1;done&quot;</span></span><br><span class="line"><span class="comment">#             ],</span></span><br><span class="line"><span class="comment">#             &quot;Image&quot;: &quot;centos&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;Volumes&quot;: null,</span></span><br><span class="line"><span class="comment">#             &quot;WorkingDir&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;Entrypoint&quot;: null,</span></span><br><span class="line"><span class="comment">#             &quot;OnBuild&quot;: null,</span></span><br><span class="line"><span class="comment">#             &quot;Labels&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;org.label-schema.build-date&quot;: &quot;20201204&quot;,</span></span><br><span class="line"><span class="comment">#                 ...</span></span><br><span class="line"><span class="comment">#             &#125;</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;NetworkSettings&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;Bridge&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#             ...</span></span><br><span class="line"><span class="comment">#             &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;Networks&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;bridge&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                     &quot;IPAMConfig&quot;: null,</span></span><br><span class="line"><span class="comment">#                     &quot;Links&quot;: null,</span></span><br><span class="line"><span class="comment">#                     &quot;Aliases&quot;: null,</span></span><br><span class="line"><span class="comment">#                     &quot;NetworkID&quot;: &quot;2fbb6bb1ed5e760a8350664377ea726ffbf35fab4794d45926ab9f9f9bd28d8a&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;EndpointID&quot;: &quot;aa43be83ff078d4c2dbdff62a2e69217ef2e17c0585edfecdcda030dca3aef0f&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;IPPrefixLen&quot;: 16,</span></span><br><span class="line"><span class="comment">#                     &quot;IPv6Gateway&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;GlobalIPv6PrefixLen&quot;: 0,</span></span><br><span class="line"><span class="comment">#                     &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;DriverOpts&quot;: null</span></span><br><span class="line"><span class="comment">#                 &#125;</span></span><br><span class="line"><span class="comment">#             &#125;</span></span><br><span class="line"><span class="comment">#         &#125;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sample: docker exec -it 627b379be47a /bin/bash </span></span><br><span class="line">docker <span class="built_in">exec</span> [OPTIONS] CONTAINER COMMAND [ARG...]        <span class="comment"># 进入容器，开启一个新的终端</span></span><br><span class="line">       </span><br><span class="line">docker attach [OPTIONS] CONTAINER                       <span class="comment"># 进去容器，为当前正在执行的终端</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker cp ./myyyyyy.tar  9b41928f2fb3:/</span></span><br><span class="line">docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|-      <span class="comment"># 容器和宿主机之间文件**互相**拷贝, - 这个符号可以操作 tar，查了一下没使用案例，测试失败</span></span><br><span class="line">docker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-镜像操作实践"><a href="#Nginx-镜像操作实践" class="headerlink" title="Nginx 镜像操作实践"></a>Nginx 镜像操作实践</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">docker search nginx         <span class="comment"># 从官方 repo 搜索镜像</span></span><br><span class="line"><span class="comment"># NAME                               DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span></span><br><span class="line"><span class="comment"># nginx                              Official build of Nginx.                        14752     [OK]</span></span><br><span class="line"><span class="comment"># jwilder/nginx-proxy                Automated Nginx reverse proxy for docker con…   2018                 [OK]</span></span><br><span class="line"></span><br><span class="line">docker pull nginx                               <span class="comment"># 下载镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -d                        # 后台运行</span></span><br><span class="line"><span class="comment"># --name:my-nginx           # 自定义容器名称</span></span><br><span class="line"><span class="comment"># -p                        # 指定端口号</span></span><br><span class="line">docker run -d --name nginx01 -p 3344:80 nginx   <span class="comment"># 启动容器</span></span><br><span class="line"></span><br><span class="line">curl localhost:3344                             <span class="comment"># 访问暴露的地址测试是否成功启动, 返回页面如下</span></span><br><span class="line"><span class="comment"># &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="comment"># &lt;html&gt;</span></span><br><span class="line"><span class="comment"># &lt;head&gt;</span></span><br><span class="line"><span class="comment"># &lt;title&gt;Welcome to nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># &lt;body&gt;</span></span><br><span class="line"><span class="comment"># &lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"># &lt;p&gt;If you see this page, the nginx web server is successfully installed and</span></span><br><span class="line"><span class="comment"># working. Further configuration is required.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># &lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="comment"># &lt;/body&gt;</span></span><br><span class="line"><span class="comment"># &lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it nginx01 /bin/bash               <span class="comment"># 进入容器</span></span><br><span class="line">whereis nginx                                   <span class="comment"># linux 基础命令，查看配置</span></span><br></pre></td></tr></table></figure>

<h2 id="Tomcat-镜像操作实践"><a href="#Tomcat-镜像操作实践" class="headerlink" title="Tomcat 镜像操作实践"></a>Tomcat 镜像操作实践</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --rm      # 一般用于测试，用完即删除</span></span><br><span class="line">docker run -it --rm tomcat:9.0                      <span class="comment"># tomcat docker 镜像官方命令，可以达到测试完毕，推出即删除的效果</span></span><br><span class="line"></span><br><span class="line">docker run -d -p 3355:8080 --name tomcat01 tomcat   <span class="comment"># 容器命名为 tomcat01 跑在 3355 端口</span></span><br><span class="line">curl localhost:3355                                 <span class="comment"># 访问测试, 访问失败</span></span><br><span class="line"><span class="comment"># &lt;!doctype html&gt;...&lt;/b&gt; The origin server did not find a current representation for the target resource or is not willing to disclose that one exists...&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat01 /bin/bash                  <span class="comment"># 进入容器查看原因</span></span><br><span class="line"></span><br><span class="line">cp -r webapps.dist/* webapps                        <span class="comment"># 官方镜像 webapps 文件夹为空，样板页面放到了 webapps.dist 下了。拷贝一下，问题解决</span></span><br></pre></td></tr></table></figure>

<h2 id="部署-ES-kibana-操作实践"><a href="#部署-ES-kibana-操作实践" class="headerlink" title="部署 ES + kibana 操作实践"></a>部署 ES + kibana 操作实践</h2><p>ES 的问题：</p>
<ul>
<li>ES 暴露的接口多</li>
<li>ES 十分耗内存</li>
<li>ES 数据需要备份</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sample of official:</span></span><br><span class="line"><span class="comment">#   docker network create somenetwork</span></span><br><span class="line"><span class="comment">#   docker run -d --name elasticsearch --net somenetwork -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:tag</span></span><br><span class="line">docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e <span class="string">&quot;discovery.type=single-node&quot;</span> elasticsearch:7.6.2</span><br><span class="line"></span><br><span class="line">docker stats            <span class="comment"># 实时显示容器的资源使用情况</span></span><br><span class="line"><span class="comment"># CONTAINER ID   NAME            CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O       PIDS</span></span><br><span class="line"><span class="comment"># 5e20f16bed99   elasticsearch   1.01%     1.332GiB / 15.64GiB   8.52%     836B / 0B   106MB / 729kB   46</span></span><br><span class="line"></span><br><span class="line">curl localhost:9200     <span class="comment"># 发送请求测试</span></span><br><span class="line"><span class="comment"># &#123;</span></span><br><span class="line"><span class="comment">#   &quot;name&quot; : &quot;4d87cd0d4ff6&quot;,</span></span><br><span class="line"><span class="comment">#   &quot;cluster_name&quot; : &quot;docker-cluster&quot;,</span></span><br><span class="line"><span class="comment">#   &quot;cluster_uuid&quot; : &quot;ojWX85pITJyL7WkVnoKZcA&quot;,</span></span><br><span class="line"><span class="comment">#   &quot;version&quot; : &#123;</span></span><br><span class="line"><span class="comment">#     &quot;number&quot; : &quot;7.6.2&quot;,</span></span><br><span class="line"><span class="comment">#    ...</span></span><br><span class="line"><span class="comment">#   &#125;,</span></span><br><span class="line"><span class="comment">#   &quot;tagline&quot; : &quot;You Know, for Search&quot;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -e        # 启动时添加环境配置，sample: ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; 修改内存配置, 再次查看 stats 可以看到内存使用量变化</span></span><br><span class="line">docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e <span class="string">&quot;discovery.type=single-node&quot;</span> -e ES_JAVA_OPTS=<span class="string">&quot;-Xms64m -Xmx512m&quot;</span> elasticsearch:7.6.2</span><br><span class="line"><span class="comment"># CONTAINER ID   NAME            CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O    PIDS</span></span><br><span class="line"><span class="comment"># 7a804bd391d6   elasticsearch   229.04%   318.1MiB / 15.64GiB   1.99%     766B / 0B   0B / 246kB   27</span></span><br></pre></td></tr></table></figure>

<h2 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h2><ul>
<li>Portainer - 图形化管理工具</li>
<li>Rancher - CI/CD</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 访问 localhost:9000 可见页面</span></span><br><span class="line">docker run -d -p 8000:8000 -p 9000:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce</span><br></pre></td></tr></table></figure>

<h2 id="Docker-镜像加载原理"><a href="#Docker-镜像加载原理" class="headerlink" title="Docker 镜像加载原理"></a>Docker 镜像加载原理</h2><p>UnionFS 联合文件系统，分层，轻量级且高性能。有机会再做扩展。</p>
<h2 id="制作镜像"><a href="#制作镜像" class="headerlink" title="制作镜像"></a>制作镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -a                # 作者</span></span><br><span class="line"><span class="comment"># -m                # commit 信息</span></span><br><span class="line"><span class="comment"># 630bab3ed5c2      # 修改过的 container id</span></span><br><span class="line"><span class="comment"># tomcat02:1.0      # 新镜像名称:版本号</span></span><br><span class="line">docker commit -a=<span class="string">&#x27;jzheng&#x27;</span> -m=<span class="string">&#x27;add webapps&#x27;</span> 630bab3ed5c2 tomcat02:1.0</span><br><span class="line">docker images</span><br><span class="line"><span class="comment"># REPOSITORY            TAG            IMAGE ID       CREATED         SIZE</span></span><br><span class="line"><span class="comment"># tomcat02              1.0            67be5e0517c6   7 seconds ago   672MB</span></span><br></pre></td></tr></table></figure>

<h2 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h2><p>docker 容器删除之后，运行时产生的数据也会一起删除，为了保留这些数据，我们有了数据卷技术。通过数据卷技术，我们将容器中数据同步到宿主机，容器之间也可以通过这个技术做数据共享。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -v, --volume list         # 挂载数据卷(Bind mount a volume)</span></span><br><span class="line"><span class="comment"># sample: docker run -it -v /Users/id/tmp/mount:/home centos /bin/bash</span></span><br><span class="line">docker run -it -v host_addr:container_addr [REPOSITORY[:TAG]]</span><br><span class="line"><span class="comment"># 测试 tomcat 时发现，-v 会以本地的文件夹为基准</span></span><br><span class="line"><span class="comment"># sample: docker run -d --name my-tomcat -P -v /Users/jack/tmp/mount:/usr/local/tomcat/webapps.dist tomcat</span></span><br><span class="line"><span class="comment"># 问题：</span></span><br><span class="line"><span class="comment">#   1. 本地路径必须是全路径 &#x27;./mount&#x27; 会查找失败</span></span><br><span class="line"><span class="comment">#   2. 挂载之后会以本地文件为基准，比如上例，webapps.dist 挂载到本地后，进入容器，这个文件夹下原有的文件都没了</span></span><br><span class="line"></span><br><span class="line">docker inspect [OPTIONS] NAME|ID [NAME|ID...]       <span class="comment"># 通过 inspect 可以看到具体的挂载信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># &quot;Mounts&quot;: [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Type&quot;: &quot;bind&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Source&quot;: &quot;/Users/jack/tmp/mount&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Destination&quot;: &quot;/usr/local/tomcat/webapps.dist&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Mode&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;RW&quot;: true,</span></span><br><span class="line"><span class="comment">#         &quot;Propagation&quot;: &quot;rprivate&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ],</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">停止容器，修改宿主机下的同步文件夹内容，容器启动后改动会同步到容器中</span><br></pre></td></tr></table></figure>

<h2 id="安装-MySQL-操作实践"><a href="#安装-MySQL-操作实践" class="headerlink" title="安装 MySQL 操作实践"></a>安装 MySQL 操作实践</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># -e MYSQL_ROOT_PASSWORD=my-secret-pw           # 按官方镜像文档提示，启动容器时设置密码</span></span><br><span class="line">docker run -d -p 3000:3306 -v /Users/id/tmp/mysql/conf:/etc/mysql/conf.d -v /Users/id/tmp/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 --name=mysql01 mysql:5.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 DBeaver，链接数据库，报错：`Unable to load authentication plugin &#x27;caching_sha2_password&#x27;.`</span></span><br><span class="line"><span class="comment"># 搜索之后，发现是 mysql 驱动有跟新，需要修稿客户端的 pom, 升级到 8.x 就行。DBeaver 直接就在创建选项里给了方案，选 8.x 那个就行 [GitIssue](https://github.com/dbeaver/dbeaver/issues/4691)</span></span><br><span class="line"><span class="comment"># 使用高版本的 Mysql connection 还是有问题，不过 msg 变了：`Public Key Retrieval is not allowed`</span></span><br><span class="line"><span class="comment"># 搜索之后，发现还要改配置, connection setting -&gt; Driver properties -&gt; &#x27;allowPlblicKeyRetrieval&#x27; 改为 true</span></span><br><span class="line"><span class="comment"># 还有问题。。。继续抛错：`Access denied for user &#x27;root&#x27;@&#x27;localhost&#x27; (using password: YES)`</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql01 /bin/bash               <span class="comment"># 进去容器，输入 `mysql -u root -p` 尝试登陆，成功。推测是链接客户端的问题</span></span><br><span class="line">ps -ef | grep mysql                             <span class="comment"># 查看了一下，突然想起来，本地我也有安装 mysql 可能有冲突。果断将之前安装的 docker mysql 删除，重新指定一个新的端口，用 DBeaver 链接，成功！</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过客户端创建一个新的数据库 new_test, 在本地映射的 data 目录下 ls 一下，可以看到新数据库文件可以同步创建</span></span><br><span class="line"><span class="comment"># &gt; ~/tmp/mydb/data ls</span></span><br><span class="line"><span class="comment"># auto.cnf           ca.pem             client-key.pem     ib_logfile0        ibdata1            mysql              performance_schema public_key.pem     server-key.pem</span></span><br><span class="line"><span class="comment"># ca-key.pem         client-cert.pem    ib_buffer_pool     ib_logfile1        ibtmp1             new_test           private_key.pem    server-cert.pem    sys</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除容器，本地文件依然存在！</span></span><br></pre></td></tr></table></figure>

<h2 id="具名挂载-Vs-匿名挂载"><a href="#具名挂载-Vs-匿名挂载" class="headerlink" title="具名挂载 Vs 匿名挂载"></a>具名挂载 Vs 匿名挂载</h2><p>具名挂载和匿名挂载是 <code>docker run</code> 命令中 <code>-v</code> 参数不同的使用情况。在明确指定挂载路径时(比如之前 mysql 和 tomcat 测试时的挂载指定), 通过 <code>docker volume ls</code> 可以看到是不会生产临时文件夹的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">docker volume rm $(docker volume ls -q)             <span class="comment"># 参考 rm 示例，删除所有的 volume, 准备测试环境</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -v path_in_container                              # 匿名挂载, 不指定宿主机挂载目录</span></span><br><span class="line">docker run -d --name my-tomcat01 -P -v /usr/<span class="built_in">local</span>/tomcat/webapps.dist tomcat</span><br><span class="line"></span><br><span class="line">docker volume ls                                    <span class="comment"># 查看卷情况</span></span><br><span class="line"><span class="comment"># DRIVER    VOLUME NAME</span></span><br><span class="line"><span class="comment"># local     0cd33950f5d8a050e61e58eaddae66b397db7b0e6968d40a1908a469c8386b03</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -v name:path_in_container                         # 具名挂载, 名字:容器中挂载点地址</span></span><br><span class="line">docker run -d --name my-tomcat02 -P -v tomcat02-volume:/usr/<span class="built_in">local</span>/tomcat/webapps.dist tomcat</span><br><span class="line"><span class="comment"># DRIVER    VOLUME NAME</span></span><br><span class="line"><span class="comment"># local     0cd33950f5d8a050e61e58eaddae66b397db7b0e6968d40a1908a469c8386b03</span></span><br><span class="line"><span class="comment"># local     tomcat02-volum</span></span><br><span class="line"></span><br><span class="line">docker volume inspect juming-nginx                  <span class="comment"># 使用 inspect 查看挂载点具体信息</span></span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;CreatedAt&quot;: &quot;2021-04-26T12:20:25Z&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Labels&quot;: null,</span></span><br><span class="line"><span class="comment">#         &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/tomcat02-volume/_data&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat02-volume&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Options&quot;: null,</span></span><br><span class="line"><span class="comment">#         &quot;Scope&quot;: &quot;local&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 总结：</span></span><br><span class="line"><span class="comment">#   -v path-in-container                  # 匿名挂载</span></span><br><span class="line"><span class="comment">#   -v volume-name:path-in-container      # 具名挂载</span></span><br><span class="line"><span class="comment">#   -v host-path:path-in-container        # 指定路径挂载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他使用方式，加 ro/rw 参数：</span></span><br><span class="line"><span class="comment">#   -v host-path:path-in-container:ro/rw</span></span><br><span class="line"><span class="comment">#       ro: read only, 只能通过宿主机改变，容器内部不能改变</span></span><br><span class="line"><span class="comment">#       rw: read and write, 默认的权限设置</span></span><br></pre></td></tr></table></figure>

<h2 id="数据共享"><a href="#数据共享" class="headerlink" title="数据共享"></a>数据共享</h2><p>多个容器之间是可以实现同步数据的效果的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">docker volume rm $(docker volume ls -q)                             <span class="comment"># 删除卷，准备实验环境</span></span><br><span class="line"></span><br><span class="line">docker run -it -d --name myos01 mycentos                            <span class="comment"># 启动自制容器作为父容器</span></span><br><span class="line"></span><br><span class="line">docker volume ls                                                    <span class="comment"># 两个挂载卷创建完毕</span></span><br><span class="line"><span class="comment"># DRIVER              VOLUME NAME</span></span><br><span class="line"><span class="comment"># local               8532efd6dabd0254bf5cec28de4df8225e4b633b91d83e13d80ba3ea97a9b314 &lt;- volume01</span></span><br><span class="line"><span class="comment"># local               b398a216526cfe3a52f71a92c383694f73b91900dbe57159c02ab63040078c21 &lt;- volume02</span></span><br><span class="line"></span><br><span class="line">docker run -it -d --name myos02 --volumes-from myos01 mycentos      <span class="comment"># 启动子容器, 查看卷信息，没有新建卷</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it myos01 /bin/bash                                    <span class="comment"># 进入容器 myos01</span></span><br><span class="line"><span class="built_in">cd</span> volume01 &amp;&amp; touch new.txt                                        <span class="comment"># 进入测试文件夹，新建测试文件</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it myos02 /bin/bash                                    <span class="comment"># 进入容器 myos02</span></span><br><span class="line">d volume01 &amp;&amp; ls                                                    <span class="comment"># 查看文件列表</span></span><br><span class="line"><span class="comment"># new.txt                                                           # 文件创建成功</span></span><br><span class="line"></span><br><span class="line">docker rm -f myos01                                                 <span class="comment"># 删除父容器</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it myos02 /bin/bash                                    <span class="comment"># 进入容器 myos02</span></span><br><span class="line">d volume01 &amp;&amp; ls                                                    <span class="comment"># 查看文件列表</span></span><br><span class="line"><span class="comment"># new.txt                                                           # 文件创建成功</span></span><br></pre></td></tr></table></figure>

<p>结论：</p>
<ul>
<li>数据卷容器的生命周期一直持续到没有容器使用为止</li>
<li>一旦持久化到本地，本地数据是不会删除的</li>
</ul>
<p>PS: 就我看还不如说，数据卷挂载的时候会在宿主机上创建一个对应的挂载点，文件都存在那里的，所以就算容器删了数据还是存在的</p>
<h2 id="初识-Dockerfile"><a href="#初识-Dockerfile" class="headerlink" title="初识 Dockerfile"></a>初识 Dockerfile</h2><p>用来构建 docker 镜像的文件</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile 示例，</span></span><br><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载两个卷</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">&quot;volume01&quot;</span>, <span class="string">&quot;volume02&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dockerfile 中只能有一条 CMD 指令，如果要执行多个 cmd 可以用 &amp;&amp; 链接</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;-----end-----&quot;</span> &amp;&amp; /bin/bash</span></span><br></pre></td></tr></table></figure>

<p>创建镜像文件并启动容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -f file-path          # 指定 Dockerfile 路径</span></span><br><span class="line"><span class="comment"># -t name:tag           # 为镜像取名，打 tag</span></span><br><span class="line">docker build [OPTIONS] PATH | URL | -</span><br><span class="line"><span class="comment"># sample: docker build -t mycentos .</span></span><br><span class="line"></span><br><span class="line">docker images           <span class="comment"># 查看新建 image 是否成功</span></span><br><span class="line"><span class="comment"># REPOSITORY       TAG                IMAGE ID       CREATED         SIZE</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># mycentos         0.1                1fa2eebe33e7   3 days ago      282MB</span></span><br><span class="line"><span class="comment"># docker images 查看自建的镜像</span></span><br><span class="line"></span><br><span class="line">docker run -it --name myos mycentos     <span class="comment"># 启动测试</span></span><br><span class="line"><span class="comment"># ----- end file -------                # 自定义 log 输出成功</span></span><br><span class="line"><span class="comment"># [root@ab726584ad36 /]# ls -al         # 两个新文件夹 volume1, volume2 创建成功</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># drwxr-xr-x   2 root root 4096 Apr 27 06:34 volume01</span></span><br><span class="line"><span class="comment"># drwxr-xr-x   2 root root 4096 Apr 27 06:34 volume02</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> volume1 &amp;&amp; ehco <span class="string">&quot;test&quot;</span> &gt;&gt; new_file.txt       <span class="comment"># 在 volume1 文件夹下创建一个测试文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 volume1 中新建文件 echo &quot;new&quot; &gt;&gt; new_file.txt</span></span><br><span class="line">docker inspect myos</span><br><span class="line"><span class="comment"># &quot;Mounts&quot;: [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Type&quot;: &quot;volume&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;f8d5471d593bd05dc18d5ce04a09353f805113408b15b3557dafb71b84bdd73b&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Source&quot;: &quot;/var/lib/docker/volumes/f8d5471d593bd05dc18d5ce04a09353f805113408b15b3557dafb71b84bdd73b/_data&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Destination&quot;: &quot;volume02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Mode&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;RW&quot;: true,</span></span><br><span class="line"><span class="comment">#         &quot;Propagation&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Type&quot;: &quot;volume&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;a4940f45b4573330e4db3964ad7534543404fc37eaacce797eff664744240337&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Source&quot;: &quot;/var/lib/docker/volumes/a4940f45b4573330e4db3964ad7534543404fc37eaacce797eff664744240337/_data&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Destination&quot;: &quot;volume01&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Mode&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;RW&quot;: true,</span></span><br><span class="line"><span class="comment">#         &quot;Propagation&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /var/lib/docker/volumes/a4940f45b4573330e4db3964ad7534543404fc37eaacce797eff664744240337/_data &amp;&amp; ls     <span class="comment"># 查看挂载目录下的文件列表</span></span><br><span class="line"><span class="comment"># new_file.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面这个查看挂载文件的操作只能在 Linux 系统上做， Windows 和 MacOS 系统上的 docker 都是通过虚拟机启动的，虽然能看到类似的信息，但是本机上是不能访问挂载文件夹的</span></span><br></pre></td></tr></table></figure>

<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>A Dockerfile is a text document that contains all the commands a user could call on the command line to assemble an image.</p>
<p>构建镜像的步骤：</p>
<ol>
<li>创建 Dockerfile 文件</li>
<li>docker build 构建镜像</li>
<li>docker run 运行镜像</li>
<li>docker push 发布镜像</li>
</ol>
<p>文件格式注：</p>
<ul>
<li>每个保留关键字都必须是大写的字母</li>
<li>执行顺序从上倒下</li>
<li><code>#</code> 表示注释</li>
<li>每个指令都会创建提交一个新的镜像层，并提交</li>
</ul>
<p>常用指令：</p>
<p>参考<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">官方文档</a></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span>            <span class="comment"># 基础镜像，起点</span></span><br><span class="line"><span class="keyword">MAINTAINER</span>      <span class="comment"># 作者</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">             <span class="comment"># 镜像构建的时候需要运行的命令</span></span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash">             <span class="comment"># 步骤，比如添加tomcat 压缩包</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash">         <span class="comment"># 镜像工作目录</span></span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash">          <span class="comment"># 挂载目录</span></span></span><br><span class="line"><span class="keyword">EXPOSE</span>          <span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash">             <span class="comment"># 指定容器启动的时候运行的命令，只有最后一个会生效，可被替代</span></span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash">      <span class="comment"># 指定容器启动时运行的命令，可以追加命令</span></span></span><br><span class="line"><span class="keyword">ONBUILD</span>         <span class="comment"># 当构建一个被继承的 Dockerfile 就会运行 ONBUILD指令，触发指令</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash">            <span class="comment"># 类似 ADD， 将文件拷贝到镜像中</span></span></span><br><span class="line"><span class="keyword">ENV</span>             <span class="comment"># 设置环境变量</span></span><br></pre></td></tr></table></figure>

<p>实践案例：构建自己的 centos</p>
<p>编写 dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> jzheng&lt;jzheng@my.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MYPATH /usr/local</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$MYPATH</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install vim</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install net-tools</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CMD echo $MYPATH &amp;&amp; echo &quot;---- end ----&quot; &amp;&amp; /bin/bash 会出问题</span></span><br><span class="line"><span class="comment"># docker run -it --name my01 myos</span></span><br><span class="line"><span class="comment"># /usr/local</span></span><br><span class="line"><span class="comment"># ----end----</span></span><br><span class="line"><span class="comment"># /bin/sh: CMD: command not found</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /bin/bash</span></span><br></pre></td></tr></table></figure>

<p>运行构建命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">docker build -f Dockerfile -t mycentos .            <span class="comment"># 开始构建，mac 和 linux 上给的 log 有差别</span></span><br><span class="line"><span class="comment"># Sending build context to Docker daemon 2.048 kB</span></span><br><span class="line"><span class="comment"># Step 1/8 : FROM centos                            # 每一个 step 都会生产一个新的镜像文件</span></span><br><span class="line"><span class="comment">#  ---&gt; 300e315adb2f</span></span><br><span class="line"><span class="comment"># Step 2/8 : MAINTAINER jzheng&lt;jzheng@my.com&gt;</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in e71638786ebe</span></span><br><span class="line"><span class="comment">#  ---&gt; 6dda844c25cb</span></span><br><span class="line"><span class="comment"># Removing intermediate container e71638786ebe</span></span><br><span class="line"><span class="comment"># Step 3/8 : ENV MYPATH /usr/local</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in ad27737ada75</span></span><br><span class="line"><span class="comment">#  ---&gt; 9a617502fc06</span></span><br><span class="line"><span class="comment"># Removing intermediate container ad27737ada75</span></span><br><span class="line"><span class="comment"># Step 4/8 : WORKDIR $MYPATH</span></span><br><span class="line"><span class="comment">#  ---&gt; 79d1c3e4be51</span></span><br><span class="line"><span class="comment"># Removing intermediate container ea4189b4b4eb</span></span><br><span class="line"><span class="comment"># Step 5/8 : RUN yum -y install vim</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in 27be499e2b36</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS Linux 8 - AppStream                      9.7 MB/s | 6.3 MB     00:00</span></span><br><span class="line"><span class="comment"># CentOS Linux 8 - BaseOS                         2.8 MB/s | 2.3 MB     00:00</span></span><br><span class="line"><span class="comment"># CentOS Linux 8 - Extras                          13 kB/s | 9.6 kB     00:00</span></span><br><span class="line"><span class="comment"># Dependencies resolved.</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment">#  Package             Arch        Version                   Repository      Size</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment"># Installing:</span></span><br><span class="line"><span class="comment">#  vim-enhanced        x86_64      2:8.0.1763-15.el8         appstream      1.4 M</span></span><br><span class="line"><span class="comment"># Installing dependencies:</span></span><br><span class="line"><span class="comment">#  gpm-libs            x86_64      1.20.7-15.el8             appstream       39 k</span></span><br><span class="line"><span class="comment">#  vim-common          x86_64      2:8.0.1763-15.el8         appstream      6.3 M</span></span><br><span class="line"><span class="comment">#  vim-filesystem      noarch      2:8.0.1763-15.el8         appstream       48 k</span></span><br><span class="line"><span class="comment">#  which               x86_64      2.21-12.el8               baseos          49 k</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Transaction Summary</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment"># Install  5 Packages</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Total download size: 7.8 M</span></span><br><span class="line"><span class="comment"># Installed size: 30 M</span></span><br><span class="line"><span class="comment"># Downloading Packages:</span></span><br><span class="line"><span class="comment"># (1/5): gpm-libs-1.20.7-15.el8.x86_64.rpm        860 kB/s |  39 kB     00:00</span></span><br><span class="line"><span class="comment"># (2/5): vim-filesystem-8.0.1763-15.el8.noarch.rp 4.1 MB/s |  48 kB     00:00</span></span><br><span class="line"><span class="comment"># (3/5): vim-enhanced-8.0.1763-15.el8.x86_64.rpm   13 MB/s | 1.4 MB     00:00</span></span><br><span class="line"><span class="comment"># (4/5): vim-common-8.0.1763-15.el8.x86_64.rpm     38 MB/s | 6.3 MB     00:00</span></span><br><span class="line"><span class="comment"># (5/5): which-2.21-12.el8.x86_64.rpm             435 kB/s |  49 kB     00:00</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Total                                           7.7 MB/s | 7.8 MB     00:01</span></span><br><span class="line"><span class="comment"># CentOS Linux 8 - AppStream                      1.6 MB/s | 1.6 kB     00:00</span></span><br><span class="line"><span class="comment"># warning: /var/cache/dnf/appstream-02e86d1c976ab532/packages/gpm-libs-1.20.7-15.el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID 8483c65d: NOKEY</span></span><br><span class="line"><span class="comment"># Importing GPG key 0x8483C65D:</span></span><br><span class="line"><span class="comment">#  Userid     : &quot;CentOS (CentOS Official Signing Key) &lt;security@centos.org&gt;&quot;</span></span><br><span class="line"><span class="comment">#  Fingerprint: 99DB 70FA E1D7 CE22 7FB6 4882 05B5 55B3 8483 C65D</span></span><br><span class="line"><span class="comment">#  From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial</span></span><br><span class="line"><span class="comment"># Key imported successfully</span></span><br><span class="line"><span class="comment"># Running transaction check</span></span><br><span class="line"><span class="comment"># Transaction check succeeded.</span></span><br><span class="line"><span class="comment"># Running transaction test</span></span><br><span class="line"><span class="comment"># Transaction test succeeded.</span></span><br><span class="line"><span class="comment"># Running transaction</span></span><br><span class="line"><span class="comment">#   Preparing        :                                                        1/1</span></span><br><span class="line"><span class="comment">#   Installing       : which-2.21-12.el8.x86_64                               1/5</span></span><br><span class="line"><span class="comment">#   Installing       : vim-filesystem-2:8.0.1763-15.el8.noarch                2/5</span></span><br><span class="line"><span class="comment">#   Installing       : vim-common-2:8.0.1763-15.el8.x86_64                    3/5</span></span><br><span class="line"><span class="comment">#   Installing       : gpm-libs-1.20.7-15.el8.x86_64                          4/5</span></span><br><span class="line"><span class="comment">#   Running scriptlet: gpm-libs-1.20.7-15.el8.x86_64                          4/5</span></span><br><span class="line"><span class="comment">#   Installing       : vim-enhanced-2:8.0.1763-15.el8.x86_64                  5/5</span></span><br><span class="line"><span class="comment">#   Running scriptlet: vim-enhanced-2:8.0.1763-15.el8.x86_64                  5/5</span></span><br><span class="line"><span class="comment">#   Running scriptlet: vim-common-2:8.0.1763-15.el8.x86_64                    5/5</span></span><br><span class="line"><span class="comment">#   Verifying        : gpm-libs-1.20.7-15.el8.x86_64                          1/5</span></span><br><span class="line"><span class="comment">#   Verifying        : vim-common-2:8.0.1763-15.el8.x86_64                    2/5</span></span><br><span class="line"><span class="comment">#   Verifying        : vim-enhanced-2:8.0.1763-15.el8.x86_64                  3/5</span></span><br><span class="line"><span class="comment">#   Verifying        : vim-filesystem-2:8.0.1763-15.el8.noarch                4/5</span></span><br><span class="line"><span class="comment">#   Verifying        : which-2.21-12.el8.x86_64                               5/5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installed:</span></span><br><span class="line"><span class="comment">#   gpm-libs-1.20.7-15.el8.x86_64         vim-common-2:8.0.1763-15.el8.x86_64</span></span><br><span class="line"><span class="comment">#   vim-enhanced-2:8.0.1763-15.el8.x86_64 vim-filesystem-2:8.0.1763-15.el8.noarch</span></span><br><span class="line"><span class="comment">#   which-2.21-12.el8.x86_64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Complete!</span></span><br><span class="line"><span class="comment">#  ---&gt; 07a9459e3208</span></span><br><span class="line"><span class="comment"># Removing intermediate container 27be499e2b36</span></span><br><span class="line"><span class="comment"># Step 6/8 : RUN yum -y install net-tools</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in 9dd0c1e98a2f</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Last metadata expiration check: 0:00:07 ago on Tue Apr 27 08:30:37 2021.</span></span><br><span class="line"><span class="comment"># Dependencies resolved.</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment">#  Package         Architecture Version                        Repository    Size</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment"># Installing:</span></span><br><span class="line"><span class="comment">#  net-tools       x86_64       2.0-0.52.20160912git.el8       baseos       322 k</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Transaction Summary</span></span><br><span class="line"><span class="comment"># ================================================================================</span></span><br><span class="line"><span class="comment"># Install  1 Package</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Total download size: 322 k</span></span><br><span class="line"><span class="comment"># Installed size: 942 k</span></span><br><span class="line"><span class="comment"># Downloading Packages:</span></span><br><span class="line"><span class="comment"># net-tools-2.0-0.52.20160912git.el8.x86_64.rpm   1.6 MB/s | 322 kB     00:00</span></span><br><span class="line"><span class="comment"># --------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Total                                           519 kB/s | 322 kB     00:00</span></span><br><span class="line"><span class="comment"># Running transaction check</span></span><br><span class="line"><span class="comment"># Transaction check succeeded.</span></span><br><span class="line"><span class="comment"># Running transaction test</span></span><br><span class="line"><span class="comment"># Transaction test succeeded.</span></span><br><span class="line"><span class="comment"># Running transaction</span></span><br><span class="line"><span class="comment">#   Preparing        :                                                        1/1</span></span><br><span class="line"><span class="comment">#   Installing       : net-tools-2.0-0.52.20160912git.el8.x86_64              1/1</span></span><br><span class="line"><span class="comment">#   Running scriptlet: net-tools-2.0-0.52.20160912git.el8.x86_64              1/1</span></span><br><span class="line"><span class="comment">#   Verifying        : net-tools-2.0-0.52.20160912git.el8.x86_64              1/1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installed:</span></span><br><span class="line"><span class="comment">#   net-tools-2.0-0.52.20160912git.el8.x86_64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Complete!</span></span><br><span class="line"><span class="comment">#  ---&gt; d4af6e7280be</span></span><br><span class="line"><span class="comment"># Removing intermediate container 9dd0c1e98a2f</span></span><br><span class="line"><span class="comment"># Step 7/8 : EXPOSE 80</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in 8258f5335635</span></span><br><span class="line"><span class="comment">#  ---&gt; 612fbdec4589</span></span><br><span class="line"><span class="comment"># Removing intermediate container 8258f5335635</span></span><br><span class="line"><span class="comment"># Step 8/8 : CMD /bin/bash</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in 1e7dc8bd18cb</span></span><br><span class="line"><span class="comment">#  ---&gt; 8ce94727fa9f</span></span><br><span class="line"><span class="comment"># Removing intermediate container 1e7dc8bd18cb</span></span><br><span class="line"><span class="comment"># Successfully built 8ce94727fa9f</span></span><br><span class="line"></span><br><span class="line">docker run -it --rm myos</span><br><span class="line"><span class="comment"># [root@af8b74546536 local]# pwd</span></span><br><span class="line"><span class="comment"># /usr/local                                # 起始目录已经和设定的一样发生了变化, 输入 ifconfig 和 vim 也能正常运行</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">history</span> myos                         <span class="comment"># 查看 image 构建历史, 可以查看热门 image 学习构建过程</span></span><br><span class="line"><span class="comment"># IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT</span></span><br><span class="line"><span class="comment"># 8ce94727fa9f        4 minutes ago       /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;/b...   0 B</span></span><br><span class="line"><span class="comment"># 612fbdec4589        4 minutes ago       /bin/sh -c #(nop)  EXPOSE 80/tcp                0 B</span></span><br><span class="line"><span class="comment"># d4af6e7280be        4 minutes ago       /bin/sh -c yum -y install net-tools             23.3 MB</span></span><br><span class="line"><span class="comment"># 07a9459e3208        4 minutes ago       /bin/sh -c yum -y install vim                   58 MB</span></span><br><span class="line"><span class="comment"># 79d1c3e4be51        4 minutes ago       /bin/sh -c #(nop) WORKDIR /usr/local            0 B</span></span><br><span class="line"><span class="comment"># 9a617502fc06        4 minutes ago       /bin/sh -c #(nop)  ENV MYPATH=/usr/local        0 B</span></span><br><span class="line"><span class="comment"># 6dda844c25cb        4 minutes ago       /bin/sh -c #(nop)  MAINTAINER jzheng&lt;jzhen...   0 B</span></span><br><span class="line"><span class="comment"># 300e315adb2f        4 months ago        /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0 B</span></span><br><span class="line"><span class="comment"># &lt;missing&gt;           4 months ago        /bin/sh -c #(nop)  LABEL org.label-schema....   0 B</span></span><br><span class="line"><span class="comment"># &lt;missing&gt;           4 months ago        /bin/sh -c #(nop) ADD file:bd7a2aed6ede423...   209 MB</span></span><br></pre></td></tr></table></figure>

<h2 id="CMD-Vs-ENTRYPOINT"><a href="#CMD-Vs-ENTRYPOINT" class="headerlink" title="CMD Vs ENTRYPOINT"></a>CMD Vs ENTRYPOINT</h2><p>CMD 只有最后一个命令会生效 由下面的 file 构建的 image, run 时只会输出 2</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;2&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>创建 Dockerfile 测试 CMD 命令</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-a&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>测试：构建镜像, 运行容器查看输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">docker build -t cmdtest .</span><br><span class="line"><span class="comment"># Sending build context to Docker daemon 2.048 kB</span></span><br><span class="line"><span class="comment"># Step 1/2 : FROM centos</span></span><br><span class="line"><span class="comment">#  ---&gt; 300e315adb2f</span></span><br><span class="line"><span class="comment"># Step 2/2 : CMD ls -al</span></span><br><span class="line"><span class="comment">#  ---&gt; Running in e8e0790ae8f3</span></span><br><span class="line"><span class="comment">#  ---&gt; 513ebac8ebef</span></span><br><span class="line"><span class="comment"># Removing intermediate container e8e0790ae8f3</span></span><br><span class="line"><span class="comment"># Successfully built 513ebac8ebef</span></span><br><span class="line"></span><br><span class="line">docker run cmdtest</span><br><span class="line"><span class="comment"># .</span></span><br><span class="line"><span class="comment"># ..</span></span><br><span class="line"><span class="comment"># .dockerenv</span></span><br><span class="line"><span class="comment"># bin</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># sys</span></span><br><span class="line"><span class="comment"># tmp</span></span><br><span class="line"><span class="comment"># usr</span></span><br><span class="line"><span class="comment"># var</span></span><br><span class="line"></span><br><span class="line">docker run cmdtest -l               <span class="comment"># 如果想要追加 `l` 给出 `ls -al` 的效果怎么办？直接在 run 后接参数会报错</span></span><br><span class="line"><span class="comment"># container_linux.go:235: starting container process caused &quot;exec: \&quot;-l\&quot;: executable file not found in $PATH&quot;</span></span><br><span class="line"><span class="comment"># /usr/bin/docker-current: Error response from daemon: oci runtime error: container_linux.go:235: starting container process caused &quot;exec: \&quot;-l\&quot;: executable file not found in $PATH&quot;.</span></span><br><span class="line"></span><br><span class="line">docker run cmdtest ls -al         <span class="comment"># 输入完整命令可以达到想要的效果，就是有点冗余</span></span><br><span class="line"><span class="comment"># total 56</span></span><br><span class="line"><span class="comment"># drwxr-xr-x  1 root root 4096 Apr 27 08:49 .</span></span><br><span class="line"><span class="comment"># drwxr-xr-x  1 root root 4096 Apr 27 08:49 ..</span></span><br><span class="line"><span class="comment"># -rwxr-xr-x  1 root root    0 Apr 27 08:49 .dockerenv</span></span><br><span class="line"><span class="comment"># lrwxrwxrwx  1 root root    7 Nov  3 15:22 bin -&gt; usr/bin</span></span><br><span class="line"><span class="comment"># drwxr-xr-x  5 root root  340 Apr 27 08:49 dev</span></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>如果想要直接接命令参数，可以用 ENTRYPOINT</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-a&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker build -f mydockerfile -t entrypointtest .        <span class="comment"># 构建镜像</span></span><br><span class="line"></span><br><span class="line">docker run entrypointtest -l                            <span class="comment"># 启动容器时直接加参数即可</span></span><br><span class="line"><span class="comment"># total 56</span></span><br><span class="line"><span class="comment"># drwxr-xr-x  1 root root 4096 Apr 27 08:53 .</span></span><br><span class="line"><span class="comment"># drwxr-xr-x  1 root root 4096 Apr 27 08:53 ..</span></span><br><span class="line"><span class="comment"># -rwxr-xr-x  1 root root    0 Apr 27 08:53 .dockerenv</span></span><br><span class="line"><span class="comment"># lrwxrwxrwx  1 root root    7 Nov  3 15:22 bin -&gt; usr/bin</span></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<h2 id="实战：-制作-Tomcat-镜像"><a href="#实战：-制作-Tomcat-镜像" class="headerlink" title="实战： 制作 Tomcat 镜像"></a>实战： 制作 Tomcat 镜像</h2><p>PS: 做这个练习前可以先本地安装 tomcat + JDK 找找感觉</p>
<ol>
<li>准备镜像文件 + tomcat压缩包 + JDK压缩包</li>
<li>编写 Dockerfile 文件</li>
</ol>
<p>Google 搜索名字可直接下载压缩包 <code>jdk-8u202-linux-x64.tar.gz</code> + <code>apache-tomcat-9.0.22.tar.gz</code></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer=<span class="string">&quot;jzheng@aa.com&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> readme.txt /usr/<span class="built_in">local</span>/readme.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> jdk-8u202-linux-x64.tar.gz /usr/<span class="built_in">local</span>/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> apache-tomcat-9.0.22.tar.gz /usr/<span class="built_in">local</span>/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install vim</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MYPATH /usr/local</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$MYPATH</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/local/jdk1.<span class="number">8.0</span>_11</span><br><span class="line"><span class="keyword">ENV</span> CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"><span class="keyword">ENV</span> CATALINA_HOME /usr/local/apache-tomcat-<span class="number">9.0</span>.<span class="number">22</span></span><br><span class="line"><span class="keyword">ENV</span> CATALINA_BASH /usr/local/apache-tomcat-<span class="number">9.0</span>.<span class="number">22</span></span><br><span class="line"><span class="keyword">ENV</span> PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /usr/<span class="built_in">local</span>/apache-tomcat-9.0.22/bin/startup.sh &amp;&amp; tail -F /usr/<span class="built_in">local</span>/apache-tomcat-9.0.22/bin/logs/catalina.out</span></span><br></pre></td></tr></table></figure>

<p>构建镜像 <code>docker build -t diytomcat .</code>, 由于使用官方标准的名字 Dockerfile 就不需要用 -f 参数了, 构建 log 如下</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[+] Building 119.9s (11/11) FINISHED                                                                                                             </span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                                                                        0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 677B                                                                                                        0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                                           0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                                             0.0s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/centos:latest                                                                            0.0s</span><br><span class="line"> =&gt; [internal] load build context                                                                                                           3.6s</span><br><span class="line"> =&gt; =&gt; transferring context: 205.02MB                                                                                                       3.6s</span><br><span class="line"> =&gt; CACHED [1/6] FROM docker.io/library/centos                                                                                              0.0s</span><br><span class="line"> =&gt; [2/6] COPY readme.txt /usr/local/readme.txt                                                                                             0.3s</span><br><span class="line"> =&gt; [3/6] ADD jdk-8u202-linux-x64.tar.gz /usr/local/                                                                                        4.8s</span><br><span class="line"> =&gt; [4/6] ADD apache-tomcat-9.0.22.tar.gz /usr/local/                                                                                       0.4s</span><br><span class="line"> =&gt; [5/6] RUN yum -y install vim                                                                                                          109.1s</span><br><span class="line"> =&gt; [6/6] WORKDIR /usr/local                                                                                                                0.0s</span><br><span class="line"> =&gt; exporting to image                                                                                                                      1.7s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                                                     1.7s</span><br><span class="line"> =&gt; =&gt; writing image sha256:4be1d03815380be7ca336c90e33b928890b5c604d646646b6087303385b0c8c0                                                0.0s </span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/diytomcat                                                                                                0.0s </span><br></pre></td></tr></table></figure>

<p>启动镜像，并为之挂载节点 <code>docker run -d -p 9090:8080 --name mytomcat -v /Users/jack/tmp/tmount/test:/usr/local/apache-tomcat-9.0.22/webapps/test -v /Users/jack/tmp/tmount/tomcatlogs:/usr/local/apache-tomcat-9.0.22/logs diytomcat</code></p>
<p>查看本地 logs 文件，报错</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; cat catalina.out </span><br><span class="line">/usr/local/apache-tomcat-9.0.22/bin/catalina.sh: line 464: /usr/local/jdk1.8.0_11/bin/java: No such file or directory</span><br></pre></td></tr></table></figure>

<p>检查后发现我下载的是 <code>jdk-8u202-linux-x64</code> 和视频上的不一样，很多地方变量都错了，改了重新 build 一下</p>
<p>突发奇想：虽然配置错了，但是我其实是可以直接进到终端重新配置使 Java 生效的，但是回头整个 follow 过了一下，发现还是不行，无法暴露端口。。。</p>
<p>再次查看 logs 日志，并访问 localhost:9090 tomcat 启动成功 (●°u°●)​ 」</p>
<p>在本地 test 目录下创建测试用页面</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── WEB-INF</span><br><span class="line">│   └── web.xml</span><br><span class="line">└── index.jsp</span><br><span class="line"></span><br><span class="line">// index.jsp 内容如下</span><br><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;title&gt;hello, docker&lt;/title&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Hello World!&lt;/h2&gt;</span><br><span class="line"> &lt;%System.out.println(&quot;-------my test web logs--------&quot;);%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">// web.xml 内容如下</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;web-app version=&quot;2.4&quot; </span><br><span class="line">    xmlns=&quot;http://java.sun.com/xml/ns/j2ee&quot; </span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/j2ee </span><br><span class="line">        http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot;&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure>

<p>直接访问 localhost:9090/test 可以看到新写的页面显示成功, logs 下的 catalina.out 会输出 jsp 里的打印信息</p>
<h2 id="docker0-网络详解"><a href="#docker0-网络详解" class="headerlink" title="docker0 网络详解"></a>docker0 网络详解</h2><p>这部分实验需要在 Linux 环境下测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">ip addr         <span class="comment"># 终端测试命令</span></span><br><span class="line"><span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000               # 本机回环地址</span></span><br><span class="line"><span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"><span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 ::1/128 scope host</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000     # 阿里云内网地址</span></span><br><span class="line"><span class="comment">#     link/ether 00:16:3e:23:6b:3f brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="comment">#     inet 172.28.231.212/20 brd 172.28.239.255 scope global dynamic eth0</span></span><br><span class="line"><span class="comment">#        valid_lft 315353600sec preferred_lft 315353600sec</span></span><br><span class="line"><span class="comment">#     inet6 fe80::216:3eff:fe23:6b3f/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default           # docker0地址</span></span><br><span class="line"><span class="comment">#     link/ether 02:42:79:29:30:37 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="comment">#     inet 172.17.0.1/16 scope global docker0</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 fe80::42:79ff:fe29:3037/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line">docker run -d -P --name tomcat01 tomcat                     <span class="comment"># 启动测试容器</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat01 ip addr                            <span class="comment"># 进入容器查看本机地址，可以看到网卡名 eth0@if55，地址 172.17.0.2/16</span></span><br><span class="line"><span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span></span><br><span class="line"><span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"><span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 ::1/128 scope host</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 54: eth0@if55: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></span><br><span class="line"><span class="comment">#     link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span></span><br><span class="line"><span class="comment">#     inet 172.17.0.2/16 scope global eth0</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 fe80::42:acff:fe11:2/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line">ping 172.17.0.2     <span class="comment"># 回到宿主机，ping 容器，可以 ping 通, mac 不能 ping 通，应该是 OS 差异导致的</span></span><br><span class="line"><span class="comment"># PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.038 ms</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [原理] 我们每启动一个 docker 容器，docker 就会给 docker 容器分配一个 ip，只要安装了 docker 就会有一个 docker0，采用桥接模式，使用 veth-pair 技术。</span></span><br><span class="line"></span><br><span class="line">ip addr             <span class="comment"># 再次查看 ip 地址，可以看到有一个新的网卡 veth9a205ef@if54 生成了</span></span><br><span class="line"><span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span></span><br><span class="line"><span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"><span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 ::1/128 scope host</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span></span><br><span class="line"><span class="comment">#     link/ether 00:16:3e:23:6b:3f brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="comment">#     inet 172.28.231.212/20 brd 172.28.239.255 scope global dynamic eth0</span></span><br><span class="line"><span class="comment">#        valid_lft 315353315sec preferred_lft 315353315sec</span></span><br><span class="line"><span class="comment">#     inet6 fe80::216:3eff:fe23:6b3f/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></span><br><span class="line"><span class="comment">#     link/ether 02:42:79:29:30:37 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="comment">#     inet 172.17.0.1/16 scope global docker0</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 fe80::42:79ff:fe29:3037/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 55: veth9a205ef@if54: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span></span><br><span class="line"><span class="comment">#     link/ether e2:a0:b1:2d:41:18 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span></span><br><span class="line"><span class="comment">#     inet6 fe80::e0a0:b1ff:fe2d:4118/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line">docker run -P -d --name tomcat02 tomcat         <span class="comment"># 启动新的容器，观察网卡信息</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat ip addr</span><br><span class="line"><span class="comment"># 56: eth0@if57: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></span><br><span class="line"><span class="comment">#     link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span></span><br><span class="line"><span class="comment">#     inet 172.17.0.3/16 scope global eth0</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment">#     inet6 fe80::42:acff:fe11:3/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line">ip addr                                         <span class="comment"># 宿主机和容器新增网卡对应关系 veth5b8ed66@if56 - eth0@if57</span></span><br><span class="line"><span class="comment"># 57: veth5b8ed66@if56: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span></span><br><span class="line"><span class="comment">#     link/ether ae:21:12:09:51:01 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span></span><br><span class="line"><span class="comment">#     inet6 fe80::ac21:12ff:fe09:5101/64 scope link</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat02 ping 172.17.02        <span class="comment"># 在 tomcat02 中尝试 ping tomcat01, 可以 ping 通</span></span><br><span class="line"><span class="comment"># PING 172.17.02 (172.17.0.2) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.066 ms</span></span><br><span class="line"></span><br><span class="line">docker rm -f tomcat01                           <span class="comment"># 删除测试容器</span></span><br><span class="line"></span><br><span class="line">ip addr                                         <span class="comment"># 对应的虚拟网卡也被删除</span></span><br></pre></td></tr></table></figure>

<p>新建容器生产的网卡都是成对出现的，这里采用 veth-pair 技术，一端连着协议，一端彼此相连</p>
<p>veth-pair 充当一个桥梁，链接各种虚拟网络设备</p>
<p>docker0 相当于一个虚拟路由器, 通信模型如下</p>
<p><img src="docker_network.png" alt="docker network"></p>
<p>tomcat01 和 tomcat02 都是公用一个路由(docker0), 所有容器不指定网络的情况下，都使用 docker0 作为路由，docker 会给容器分配默认的可用 ip</p>
<p>255.255.0.1/16: 16 表示前 16 位为同一个网络</p>
<p><img src="docker_network01.png" alt="docker network02"></p>
<p>Docker 中所有的网络接口都是虚拟的，虚拟的转发效率高</p>
<h2 id="–link"><a href="#–link" class="headerlink" title="–link"></a>–link</h2><blockquote>
<p>思考：我们编写一个微服务， database url=ip…，项目不重启，数据库 ip 换掉了，配置就失效了。我们是否可以通过指定名字进行访问</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it tomcat01 ping tomcat02                          <span class="comment"># 默认通过 name 是不能 ping 通的</span></span><br><span class="line"><span class="comment"># ping: tomcat02: Name or service not known</span></span><br><span class="line"></span><br><span class="line">docker run -d -P --name tomcat03 --link tomcat02 tomcat         <span class="comment"># 启动容器时加入 --link 参数即可实现上述效果</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat03 ping tomcat02                </span><br><span class="line"><span class="comment"># PING tomcat02 (172.17.0.3) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat02 (172.17.0.3): icmp_seq=1 ttl=64 time=0.077 ms</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat02 (172.17.0.3): icmp_seq=2 ttl=64 time=0.050 ms</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat02 ping tomcat03                          <span class="comment"># 但是反向是 ping 不通的！！?</span></span><br><span class="line"><span class="comment"># ping: tomcat03: Name or service not known</span></span><br><span class="line"></span><br><span class="line">docker network ls                                               <span class="comment"># 使用 docker network ls 查看当前网络配置</span></span><br><span class="line"><span class="comment"># NETWORK ID          NAME                DRIVER              SCOPE</span></span><br><span class="line"><span class="comment"># ceb0592c9055        bridge              bridge              local</span></span><br><span class="line"><span class="comment"># 5ac97b2cf390        host                host                local</span></span><br><span class="line"><span class="comment"># 03f71a7f47f1        none                null                local</span></span><br><span class="line"></span><br><span class="line">docker inspect bridge                                           <span class="comment"># bridge 即 docker0 的网卡，包含 tomcat01-03 的网络信息</span></span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;bridge&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Id&quot;: &quot;ceb0592c9055bd94767114d43e3677b18fd8a41a2afe6966d64551b71a09041c&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Created&quot;: &quot;2021-04-27T15:19:48.803023317+08:00&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Scope&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;bridge&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EnableIPv6&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;IPAM&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;Driver&quot;: &quot;default&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;Options&quot;: null,</span></span><br><span class="line"><span class="comment">#             &quot;Config&quot;: [</span></span><br><span class="line"><span class="comment">#                 &#123;</span></span><br><span class="line"><span class="comment">#                     &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;,  # 子网掩码，最多可配 256*256 个子节点</span></span><br><span class="line"><span class="comment">#                     &quot;Gateway&quot;: &quot;172.17.0.1&quot;     # 默认网关，docker0</span></span><br><span class="line"><span class="comment">#                 &#125;</span></span><br><span class="line"><span class="comment">#             ]</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Internal&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;Attachable&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;Containers&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;2d12d505984e201296ecf26c6705405dc0fd67fd2f837f2a9c0deadbe690eb06&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;Name&quot;: &quot;tomcat02&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;EndpointID&quot;: &quot;4a71a36b8e3c04febdc0bdc0c86a3d5fdbf2b39daec75dcef3873acf5d017c37&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv4Address&quot;: &quot;172.17.0.3/16&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#             &#125;,</span></span><br><span class="line"><span class="comment">#             &quot;4adfd9b9e4a50876d65a1786ea188e7d0b4b0c0099747b3f3bb1e460be5f0849&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;Name&quot;: &quot;tomcat03&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;EndpointID&quot;: &quot;debaf9ed00b14992dc700a1d30ada54be9f12206139483d490d87e7ac055da0f&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;MacAddress&quot;: &quot;02:42:ac:11:00:04&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv4Address&quot;: &quot;172.17.0.4/16&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#             &#125;,</span></span><br><span class="line"><span class="comment">#             &quot;c1d873b0967c6c41929099f2898a0478eb91538b5d889c4d38ea74f29a3f4433&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;Name&quot;: &quot;tomcat01&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;EndpointID&quot;: &quot;28e9076a4c9b56044588ca3993a6d481e08989a78ebe82c7b6632b17d437f79c&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#             &#125;</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Options&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.bridge.default_bridge&quot;: &quot;true&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.bridge.enable_icc&quot;: &quot;true&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.bridge.enable_ip_masquerade&quot;: &quot;true&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.bridge.host_binding_ipv4&quot;: &quot;0.0.0.0&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.bridge.name&quot;: &quot;docker0&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;com.docker.network.driver.mtu&quot;: &quot;1500&quot;</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Labels&quot;: &#123;&#125;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line">docker inspect tomcat03                     <span class="comment"># 查看 link 配置</span></span><br><span class="line"><span class="comment"># &quot;Links&quot;: [</span></span><br><span class="line"><span class="comment">#     &quot;/tomcat02:/tomcat03/tomcat02&quot;</span></span><br><span class="line"><span class="comment"># ],</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat03 cat /etc/hosts     <span class="comment"># 查看 tomcat03 的 host 配置, --link 会修改容器 hosts 配置达到绑定 ip 的效果</span></span><br><span class="line"><span class="comment"># 127.0.0.1    localhost</span></span><br><span class="line"><span class="comment"># ::1    localhost ip6-localhost ip6-loopback</span></span><br><span class="line"><span class="comment"># fe00::0    ip6-localnet</span></span><br><span class="line"><span class="comment"># ff00::0    ip6-mcastprefix</span></span><br><span class="line"><span class="comment"># ff02::1    ip6-allnodes</span></span><br><span class="line"><span class="comment"># ff02::2    ip6-allrouters</span></span><br><span class="line"><span class="comment"># 172.17.0.3    tomcat02 2d12d505984e</span></span><br><span class="line"><span class="comment"># 172.17.0.4    4adfd9b9e4a5</span></span><br><span class="line"></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># CONTAINER ID   IMAGE     COMMAND             CREATED             STATUS             PORTS                     NAMES</span></span><br><span class="line"><span class="comment"># 4ccaa4545718   tomcat    &quot;catalina.sh run&quot;   15 minutes ago      Up 15 minutes      0.0.0.0:55004-&gt;8080/tcp   tomcat03</span></span><br><span class="line"><span class="comment"># c5012b364397   tomcat    &quot;catalina.sh run&quot;   17 minutes ago      Up 17 minutes      0.0.0.0:55003-&gt;8080/tcp   tomcat02</span></span><br><span class="line"><span class="comment"># 3bf7596cfde9   tomcat    &quot;catalina.sh run&quot;   About an hour ago   Up About an hour   0.0.0.0:55002-&gt;8080/tcp   tomcat01</span></span><br></pre></td></tr></table></figure>

<p>本质：–link 就是在 hosts 中增加了一个域名劫持效果，但是现在这种做法已经<strong>不推荐了！！！</strong></p>
<h2 id="自定义网络"><a href="#自定义网络" class="headerlink" title="自定义网络"></a>自定义网络</h2><p>通过自定义网络可以达到容器互联的效果</p>
<p>网络模式：</p>
<ul>
<li>brige: 桥接模式 - 默认</li>
<li>none: 不配置</li>
<li>host: 和宿主机共享网络</li>
<li>container: 容器网络连通 - 用的少，局限大</li>
</ul>
<p>我们使用命令 <code>docker run -d -P --name tomcat01 tomcat</code> 创建容器时，会默认带有 <code>--net bridge</code> 的参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --driver bridge 桥接模式</span></span><br><span class="line"><span class="comment"># --subnet 192.168.0.0/16 子网掩码</span></span><br><span class="line"><span class="comment"># --gateway 192.168.0.1 网关</span></span><br><span class="line">docker network create --driver bridge --subnet 192.168.0.0/16 --gateway 192.168.0.1 mynet       <span class="comment"># 创建自定义网络</span></span><br><span class="line"></span><br><span class="line">docker network ls                                                                        </span><br><span class="line"><span class="comment"># NETWORK ID          NAME                DRIVER              SCOPE</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># 5a8dc0f2df06        mynet               bridge              local</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">docker network inspect mynet       </span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;mynet&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Id&quot;: &quot;5a8dc0f2df0667684167d7e219c53f4657ae4d89690afef54659080ddbc52e1e&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Created&quot;: &quot;2021-04-27T17:55:26.42981439+08:00&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Scope&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;bridge&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EnableIPv6&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;IPAM&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;Driver&quot;: &quot;default&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;Options&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">#             &quot;Config&quot;: [</span></span><br><span class="line"><span class="comment">#                 &#123;</span></span><br><span class="line"><span class="comment">#                     &quot;Subnet&quot;: &quot;192.168.0.0/16&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;Gateway&quot;: &quot;192.168.0.1&quot;</span></span><br><span class="line"><span class="comment">#                 &#125;</span></span><br><span class="line"><span class="comment">#             ]</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Internal&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;Attachable&quot;: false,</span></span><br><span class="line"><span class="comment">#         &quot;Containers&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Options&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Labels&quot;: &#123;&#125;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加容器到自定义网络</span></span><br><span class="line">docker run -d -P --name tomcat01 --net mynet tomcat         </span><br><span class="line">docker run -d -P --name tomcat02 --net mynet tomcat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次查看 mynet 信息可以看到新建容器已经加入到网络中</span></span><br><span class="line">docker network inspect mynet                       </span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#  ...   </span></span><br><span class="line"><span class="comment"># &quot;Containers&quot;: &#123;</span></span><br><span class="line"><span class="comment">#     &quot;4075fa56e6edc165fead5290085747455d5fbe2ad7bafc06e62a118c481b3f5b&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;793ff48b6a30c18e2f4372e99bb0bb06ea830a609bfd1b4fb9292e8b3dd77326&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:03&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;192.168.0.3/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &quot;b8e4896497b05f77ae5e3c5c3cc998500d68dc4eb2cdad2702fa90e33fd56b28&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat01&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;23f5a636ccf43e96b1734bd5572dcc2c53997dbf8087bf04474433fe645bf40e&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;192.168.0.2/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># &#125;,</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat02 ping tomcat01              <span class="comment"># 重复之前 --link 的实验，容器间通过 name 互相 ping. 自定义网络虽然没有特殊设置，但是可以直接通过 name 连接</span></span><br><span class="line"><span class="comment"># PING tomcat01 (192.168.0.2) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat01.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.206 ms</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat01.mynet (192.168.0.2): icmp_seq=2 ttl=64 time=0.294 ms</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat01 ping tomcat02</span><br><span class="line"><span class="comment"># PING tomcat02 (192.168.0.3) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat02.mynet (192.168.0.3): icmp_seq=1 ttl=64 time=0.170 ms</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat02.mynet (192.168.0.3): icmp_seq=2 ttl=64 time=0.290 ms</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义网络 docker 已经帮我们维护好了对应关系，推荐使用</span></span><br><span class="line"><span class="comment"># 比如 redis, mysql 集群网络互相隔离，保证集群的安全和健康</span></span><br></pre></td></tr></table></figure>

<h2 id="网络联通"><a href="#网络联通" class="headerlink" title="网络联通"></a>网络联通</h2><p>如何让一个容器连接到另一个网络，比如 docker0 中的 容器连接到 mynet</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认 docker0 网络下新建测试容器 tomcat03</span></span><br><span class="line">docker run -d -P --name tomcat03 tomcat </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker network connect --<span class="built_in">help</span>           <span class="comment"># 查看使用方式</span></span><br><span class="line"><span class="comment"># Usage:  docker network connect [OPTIONS] NETWORK CONTAINER</span></span><br><span class="line"><span class="comment"># Connect a container to a network</span></span><br><span class="line"><span class="comment"># Options:</span></span><br><span class="line"><span class="comment">#       --alias strings           Add network-scoped alias for the container</span></span><br><span class="line"><span class="comment">#       --driver-opt strings      driver options for the network</span></span><br><span class="line"><span class="comment">#       --ip string               IPv4 address (e.g., 172.30.100.104)</span></span><br><span class="line"><span class="comment">#       --ip6 string              IPv6 address (e.g., 2001:db8::33)</span></span><br><span class="line"><span class="comment">#       --link list               Add link to another container</span></span><br><span class="line"><span class="comment">#       --link-local-ip strings   Add a link-local address for the container</span></span><br><span class="line"></span><br><span class="line">docker network connect mynet tomcat03</span><br><span class="line"></span><br><span class="line">docker network inspect mynet            <span class="comment"># 再次查看 mynet 信息，可以看到 tomcat3 已经加入网络，即一个容器两个地址</span></span><br><span class="line"><span class="comment"># &quot;Containers&quot;: &#123;</span></span><br><span class="line"><span class="comment">#     &quot;4075fa56e6edc165fead5290085747455d5fbe2ad7bafc06e62a118c481b3f5b&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;793ff48b6a30c18e2f4372e99bb0bb06ea830a609bfd1b4fb9292e8b3dd77326&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:03&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;192.168.0.3/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &quot;76c7258757f99e4d4efc565f5e305452277fdd700a783a5387c71b54275df506&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat03&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;fbad841162867dfc73872cfa997ef99c099fde95e8b58de76ca9ccdb3ff4359e&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:04&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;192.168.0.4/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &quot;b8e4896497b05f77ae5e3c5c3cc998500d68dc4eb2cdad2702fa90e33fd56b28&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;tomcat01&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;23f5a636ccf43e96b1734bd5572dcc2c53997dbf8087bf04474433fe645bf40e&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;192.168.0.2/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># &#125;,</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat01 ping tomcat03              <span class="comment"># tomcat01, 03 互 ping 测试</span></span><br><span class="line"><span class="comment"># PING tomcat03 (192.168.0.4) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat03.mynet (192.168.0.4): icmp_seq=1 ttl=64 time=0.131 ms</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat03.mynet (192.168.0.4): icmp_seq=2 ttl=64 time=0.123 ms</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it tomcat03 ping tomcat01</span><br><span class="line"><span class="comment"># PING tomcat01 (192.168.0.2) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from tomcat01.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.085 ms</span></span><br></pre></td></tr></table></figure>

<h2 id="实战：部署-Redis-集群"><a href="#实战：部署-Redis-集群" class="headerlink" title="实战：部署 Redis 集群"></a>实战：部署 Redis 集群</h2><p>部署三主三从节点</p>
<p><img src="redis.png" alt="redis"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet 172.38.0.0/16 redis          <span class="comment"># 创建 redis 网络</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将下面的内容放入 redis.sh 使用 sh redis.sh 创建配置文件</span></span><br><span class="line"><span class="comment">################# SH START #################</span></span><br><span class="line"><span class="keyword">for</span> port <span class="keyword">in</span> $(seq 1 6); \</span><br><span class="line"><span class="keyword">do</span> \</span><br><span class="line">mkdir -p /root/mydata/redis/node-<span class="variable">$&#123;port&#125;</span>/conf</span><br><span class="line">touch /root/mydata/redis/node-<span class="variable">$&#123;port&#125;</span>/conf/redis.conf</span><br><span class="line">cat  EOF &gt; /root/mydata/redis/node-<span class="variable">$&#123;port&#125;</span>/conf/redis.conf</span><br><span class="line">port 6379 </span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">cluster-enabled yes </span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.38.0.1<span class="variable">$&#123;port&#125;</span></span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly yes</span><br><span class="line">EOF</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">################# SH END #################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 redis 节点示例</span></span><br><span class="line">docker run -p 6371:6379 -p 16371:16379 --name redis-1 \</span><br><span class="line">-v /root/mydata/redis/node-1/data:/data \</span><br><span class="line">-v /root/mydata/redis/node-1/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d --net redis --ip 172.38.0.11 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 shell 脚本创建所有 redis 容器</span></span><br><span class="line"><span class="comment">################# SH START #################</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> $(seq 1 6); \</span><br><span class="line"><span class="keyword">do</span> \</span><br><span class="line">docker run -p 637<span class="variable">$&#123;n&#125;</span>:6379 -p 1637<span class="variable">$&#123;n&#125;</span>:16379 --name redis-<span class="variable">$&#123;n&#125;</span> \</span><br><span class="line">-v /root/mydata/redis/node-<span class="variable">$&#123;n&#125;</span>/data:/data \</span><br><span class="line">-v /root/mydata/redis/node-<span class="variable">$&#123;n&#125;</span>/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d --net redis --ip 172.38.0.1<span class="variable">$&#123;n&#125;</span> redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">################# SH END #################</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-1 /bin/sh         <span class="comment"># 进入 redis 容器, redis 容器中并没有 bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建集群</span></span><br><span class="line">redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379 172.38.0.16:6379 --cluster-replicas 1</span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span></span><br><span class="line"><span class="comment"># Master[0] -&gt; Slots 0 - 5460</span></span><br><span class="line"><span class="comment"># Master[1] -&gt; Slots 5461 - 10922</span></span><br><span class="line"><span class="comment"># Master[2] -&gt; Slots 10923 - 16383</span></span><br><span class="line"><span class="comment"># Adding replica 172.38.0.15:6379 to 172.38.0.11:6379</span></span><br><span class="line"><span class="comment"># Adding replica 172.38.0.16:6379 to 172.38.0.12:6379</span></span><br><span class="line"><span class="comment"># Adding replica 172.38.0.14:6379 to 172.38.0.13:6379</span></span><br><span class="line"><span class="comment"># M: 4abbca8e1511fc4a04e8b410e35a93af1392bc62 172.38.0.11:6379</span></span><br><span class="line"><span class="comment">#    slots:[0-5460] (5461 slots) master</span></span><br><span class="line"><span class="comment"># M: 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 172.38.0.12:6379</span></span><br><span class="line"><span class="comment">#    slots:[5461-10922] (5462 slots) master</span></span><br><span class="line"><span class="comment"># M: 0d6d16438bcb68bf89109b2e91dc6b71208ea113 172.38.0.13:6379</span></span><br><span class="line"><span class="comment">#    slots:[10923-16383] (5461 slots) master</span></span><br><span class="line"><span class="comment"># S: c47e77a26e9c1186b489003c00f1a9c647e913c2 172.38.0.14:6379</span></span><br><span class="line"><span class="comment">#    replicates 0d6d16438bcb68bf89109b2e91dc6b71208ea113</span></span><br><span class="line"><span class="comment"># S: 69fa6ac41672b325cfce023353ea3a35181ca873 172.38.0.15:6379</span></span><br><span class="line"><span class="comment">#    replicates 4abbca8e1511fc4a04e8b410e35a93af1392bc62</span></span><br><span class="line"><span class="comment"># S: c7b681f08fbbe568c5fcb2bddf88660ec3d217bf 172.38.0.16:6379</span></span><br><span class="line"><span class="comment">#    replicates 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c</span></span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">&#x27;yes&#x27;</span> to accept): yes</span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span><br><span class="line"><span class="comment"># Waiting for the cluster to join</span></span><br><span class="line"><span class="comment"># ....</span></span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Performing Cluster Check (using node 172.38.0.11:6379)</span></span><br><span class="line"><span class="comment"># M: 4abbca8e1511fc4a04e8b410e35a93af1392bc62 172.38.0.11:6379</span></span><br><span class="line"><span class="comment">#    slots:[0-5460] (5461 slots) master</span></span><br><span class="line"><span class="comment">#    1 additional replica(s)</span></span><br><span class="line"><span class="comment"># S: c47e77a26e9c1186b489003c00f1a9c647e913c2 172.38.0.14:6379</span></span><br><span class="line"><span class="comment">#    slots: (0 slots) slave</span></span><br><span class="line"><span class="comment">#    replicates 0d6d16438bcb68bf89109b2e91dc6b71208ea113</span></span><br><span class="line"><span class="comment"># M: 0d6d16438bcb68bf89109b2e91dc6b71208ea113 172.38.0.13:6379</span></span><br><span class="line"><span class="comment">#    slots:[10923-16383] (5461 slots) master</span></span><br><span class="line"><span class="comment">#    1 additional replica(s)</span></span><br><span class="line"><span class="comment"># M: 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 172.38.0.12:6379</span></span><br><span class="line"><span class="comment">#    slots:[5461-10922] (5462 slots) master</span></span><br><span class="line"><span class="comment">#    1 additional replica(s)</span></span><br><span class="line"><span class="comment"># S: 69fa6ac41672b325cfce023353ea3a35181ca873 172.38.0.15:6379</span></span><br><span class="line"><span class="comment">#    slots: (0 slots) slave</span></span><br><span class="line"><span class="comment">#    replicates 4abbca8e1511fc4a04e8b410e35a93af1392bc62</span></span><br><span class="line"><span class="comment"># S: c7b681f08fbbe568c5fcb2bddf88660ec3d217bf 172.38.0.16:6379</span></span><br><span class="line"><span class="comment">#    slots: (0 slots) slave</span></span><br><span class="line"><span class="comment">#    replicates 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c</span></span><br><span class="line"><span class="comment"># [OK] All nodes agree about slots configuration.</span></span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Check for open slots...</span></span><br><span class="line"><span class="comment"># &gt;&gt;&gt; Check slots coverage...</span></span><br><span class="line"><span class="comment"># [OK] All 16384 slots covered.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line">redis-cli -c </span><br><span class="line"><span class="comment"># 127.0.0.1:6379&gt; cluster info</span></span><br><span class="line"><span class="comment"># cluster_state:ok</span></span><br><span class="line"><span class="comment"># cluster_slots_assigned:16384</span></span><br><span class="line"><span class="comment"># cluster_slots_ok:16384</span></span><br><span class="line"><span class="comment"># cluster_slots_pfail:0</span></span><br><span class="line"><span class="comment"># cluster_slots_fail:0</span></span><br><span class="line"><span class="comment"># cluster_known_nodes:6</span></span><br><span class="line"><span class="comment"># cluster_size:3</span></span><br><span class="line"><span class="comment"># cluster_current_epoch:6</span></span><br><span class="line"><span class="comment"># cluster_my_epoch:1</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_ping_sent:203</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_pong_sent:201</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_sent:404</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_ping_received:196</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_pong_received:203</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_meet_received:5</span></span><br><span class="line"><span class="comment"># cluster_stats_messages_received:404</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; cluster nodes </span><br><span class="line"><span class="comment"># (error) ERR Unknown subcommand or wrong number of arguments for &#x27;noes&#x27;. Try CLUSTER HELP.</span></span><br><span class="line"><span class="comment"># 127.0.0.1:6379&gt; cluster nodes </span></span><br><span class="line"><span class="comment"># c47e77a26e9c1186b489003c00f1a9c647e913c2 172.38.0.14:6379@16379 slave 0d6d16438bcb68bf89109b2e91dc6b71208ea113 0 1619257734941 4 connected</span></span><br><span class="line"><span class="comment"># 0d6d16438bcb68bf89109b2e91dc6b71208ea113 172.38.0.13:6379@16379 master - 0 1619257736000 3 connected 10923-16383</span></span><br><span class="line"><span class="comment"># 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 172.38.0.12:6379@16379 master - 0 1619257736471 2 connected 5461-10922</span></span><br><span class="line"><span class="comment"># 4abbca8e1511fc4a04e8b410e35a93af1392bc62 172.38.0.11:6379@16379 myself,master - 0 1619257734000 1 connected 0-5460</span></span><br><span class="line"><span class="comment"># 69fa6ac41672b325cfce023353ea3a35181ca873 172.38.0.15:6379@16379 slave 4abbca8e1511fc4a04e8b410e35a93af1392bc62 0 1619257735453 5 connected</span></span><br><span class="line"><span class="comment"># c7b681f08fbbe568c5fcb2bddf88660ec3d217bf 172.38.0.16:6379@16379 slave 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 0 1619257735554 6 connected</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> a b             <span class="comment"># 从 log 看出，值存到了 13 节点中，下面将 13 节点容器 stop, 通过 get 测试备份是否生效</span></span><br><span class="line"><span class="comment"># -&gt; Redirected to slot [15495] located at 172.38.0.13:6379</span></span><br><span class="line"><span class="comment"># OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启一个新的终端，查看 13 节点信息</span></span><br><span class="line">docker inspect redis</span><br><span class="line"><span class="comment"># &quot;319cc5bc69cf7d6875a7244b089f832e800d21f1de9d1b24a09367a2e368ea60&quot;: &#123;</span></span><br><span class="line"><span class="comment">#     &quot;Name&quot;: &quot;redis-3&quot;,</span></span><br><span class="line"><span class="comment">#     &quot;EndpointID&quot;: &quot;4419d36052f0849869b8227db835b9cffb0e053ba593730c0f76904a9465fa92&quot;,</span></span><br><span class="line"><span class="comment">#     &quot;MacAddress&quot;: &quot;02:42:ac:26:00:0d&quot;,</span></span><br><span class="line"><span class="comment">#     &quot;IPv4Address&quot;: &quot;172.38.0.13/16&quot;,</span></span><br><span class="line"><span class="comment">#     &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">docker stop redis-3</span><br><span class="line"></span><br><span class="line">172.38.0.13:6379&gt; get a             <span class="comment"># 回到原来的终端进行 get 操作</span></span><br><span class="line"><span class="comment"># Error: Operation timed out</span></span><br><span class="line"><span class="comment"># /data #                           # 默认直接从原来的 13 节点拿了，服务停了，回到了 11 节点的 data 目录，再通过 redis-cli -c 进去集群终端 get a 信息从 14 节点，备份节点返回</span></span><br><span class="line"></span><br><span class="line">redis-cli -c</span><br><span class="line">127.0.0.1:6379&gt; get a               <span class="comment"># 从 log 可以看到值是从备份节点 14 拿到的</span></span><br><span class="line"><span class="comment"># -&gt; Redirected to slot [15495] located at 172.38.0.14:6379</span></span><br><span class="line"><span class="comment"># &quot;b&quot;</span></span><br><span class="line"></span><br><span class="line">172.38.0.14:6379&gt; cluster nodes     <span class="comment"># 通过 nodes 命令查看节点信息可以看到 13 挂了 172.38.0.13:6379@16379 master,fail, slave 直接翻身农奴把歌唱</span></span><br><span class="line"><span class="comment"># 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 172.38.0.12:6379@16379 master - 0 1619258378445 2 connected 5461-10922</span></span><br><span class="line"><span class="comment"># 0d6d16438bcb68bf89109b2e91dc6b71208ea113 172.38.0.13:6379@16379 master,fail - 1619258032356 1619258031341 3 connected</span></span><br><span class="line"><span class="comment"># c47e77a26e9c1186b489003c00f1a9c647e913c2 172.38.0.14:6379@16379 myself,master - 0 1619258377000 7 connected 10923-16383</span></span><br><span class="line"><span class="comment"># 4abbca8e1511fc4a04e8b410e35a93af1392bc62 172.38.0.11:6379@16379 master - 0 1619258377432 1 connected 0-5460</span></span><br><span class="line"><span class="comment"># c7b681f08fbbe568c5fcb2bddf88660ec3d217bf 172.38.0.16:6379@16379 slave 6ff00ea4f03e997b831c2e7d3150c7399c5fb44c 0 1619258377533 6 connected</span></span><br><span class="line"><span class="comment"># 69fa6ac41672b325cfce023353ea3a35181ca873 172.38.0.15:6379@16379 slave 4abbca8e1511fc4a04e8b410e35a93af1392bc62 0 1619258376415 5 connected</span></span><br></pre></td></tr></table></figure>

<h2 id="SpringBoot-微服务打包-Docker-镜像"><a href="#SpringBoot-微服务打包-Docker-镜像" class="headerlink" title="SpringBoot 微服务打包 Docker 镜像"></a>SpringBoot 微服务打包 Docker 镜像</h2><ol>
<li>构建 springboot 的 helloword 项目</li>
<li>打包应用</li>
<li>编写 dockerfile</li>
<li>构建镜像</li>
<li>发布运行</li>
</ol>
<p>到 Spring Initializr 去打包一个 Hello Word demo 进行测试</p>
<p>Application 同级建一个 controller 文件夹，其下创建 HelloController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello from springboot.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>右键运行 application，访问 localhost:8080/hello 得到字符串</p>
<p>maven task -&gt; Lifecycle -&gt; package 打包工程, jar 包会生成在 target 目录下</p>
<p>右键 open in terminal, 运行 <code>java -jar demo-0.0.1-SNAPSHOT.jar</code> 测试 jar 包是否能正常工作</p>
<p>在 target 目录下新建 Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> *.jar /app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;--server.port=8080&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>在 target 目录下 build image <code>docker build -t myspringapp .</code></p>
<p>等待结束后查看新建是否成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker images </span><br><span class="line"><span class="comment"># REPOSITORY                                          TAG                IMAGE ID       CREATED              SIZE</span></span><br><span class="line"><span class="comment"># myspringapp                                         latest             8b39ad3c5928   About a minute ago   660MB</span></span><br></pre></td></tr></table></figure>

<p>测试运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一次忘了加 -P 导致容器端口没有暴露出来，直接就不能访问了</span></span><br><span class="line">docker run -d -P --name spapp myspringapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看映射地址</span></span><br><span class="line">docker ps</span><br><span class="line"><span class="comment"># CONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS         PORTS                     NAMES</span></span><br><span class="line"><span class="comment"># 0b4da52a4593   myspringapp   &quot;java -jar /app.jar …&quot;   3 seconds ago   Up 2 seconds   0.0.0.0:55010-&gt;8080/tcp   spapp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问测试</span></span><br><span class="line">curl localhost:55010/hello</span><br><span class="line"><span class="comment"># Hello from springboot.</span></span><br></pre></td></tr></table></figure>

<h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p>Dockerfile 单个容器，Docker Compose 定义运行多个容器</p>
<p>Using Compose is basically a three-step process:</p>
<ol>
<li>Define your app’s environment with a Dockerfile so it can be reproduced anywhere.</li>
<li>Define the services that make up your app in <code>docker-compose.yml</code> so they can be run together in an isolated environment.</li>
<li>Run <code>docker compose up</code> and the Docker compose command starts and runs your entire app. You can alternatively run docker-compose up using the docker-compose binary.</li>
</ol>
<p>重要概念：</p>
<ul>
<li>服务 services, 容器，应用（web, redis…）</li>
<li>项目 project，一组关联的容器</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>Mac 的 docker-compose 工具集是和客户端整合在一起的，所以不需要单独安装，直接可以使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker-compose version</span><br><span class="line"><span class="comment"># docker-compose version 1.28.5, build c4eb3a1f</span></span><br><span class="line"><span class="comment"># docker-py version: 4.4.4</span></span><br><span class="line"><span class="comment"># CPython version: 3.9.0</span></span><br><span class="line"><span class="comment"># OpenSSL version: OpenSSL 1.1.1h  22 Sep 202</span></span><br></pre></td></tr></table></figure>

<p>Linux 安装</p>
<ol>
<li>从 github 下载(源文件)[sudo curl -L “<a target="_blank" rel="noopener" href="https://github.com/docker/compose/releases/download/1.29.1/docker-compose-$">https://github.com/docker/compose/releases/download/1.29.1/docker-compose-$</a>(uname -s)-$(uname -m)” -o /usr/local/bin/docker-compose]</li>
<li>修改权限 <code>sudo chmod +x /usr/local/bin/docker-compose</code></li>
<li>测试运行 <code>docker compose --version</code></li>
</ol>
<h2 id="官方起步教程"><a href="#官方起步教程" class="headerlink" title="官方起步教程"></a>官方起步教程</h2><ol>
<li>写应用</li>
<li>Dockerfile 应用打包为镜像</li>
<li>Docker-compose yaml 文件整合所有 services</li>
<li>启动 compose 项目(docker-compose up .)</li>
</ol>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br><span class="line"></span><br><span class="line"># 创建网络</span><br><span class="line">Creating network &quot;composetest_default&quot; with the default driver</span><br><span class="line"></span><br><span class="line"># 根据 compose 文件构建</span><br><span class="line">Building web</span><br><span class="line">[+] Building 19.7s (13/13) FINISHED                                                                                  </span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                                            0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 324B                                                                            0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                               0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                 0.0s</span><br><span class="line"> =&gt; resolve image config for docker.io/docker/dockerfile:1                                                      3.6s</span><br><span class="line"> =&gt; docker-image://docker.io/docker/dockerfile:1@sha256:e2a8561e419ab1ba6b2fe6cbdf49fd92b95912df1cf7d313c3e2230a333fdbcc                                          1.5s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/docker/dockerfile:1@sha256:e2a8561e419ab1ba6b2fe6cbdf49fd92b95912df1cf7d313c3e2230a333fdbcc                                              0.0s</span><br><span class="line"> =&gt; =&gt; sha256:e2a8561e419ab1ba6b2fe6cbdf49fd92b95912df1cf7d313c3e2230a333fdbcc 1.69kB / 1.69kB                  0.0s</span><br><span class="line"> =&gt; =&gt; sha256:e3ee2e6b536452d876b1c5aa12db9bca51b8f52b2505178cae6d13e33daeed2b 528B / 528B                      0.0s</span><br><span class="line"> =&gt; =&gt; sha256:86e43bba076d67c1a890cbc07813806b11eca53843dc643202d939b986c8c332 1.21kB / 1.21kB                  0.0s</span><br><span class="line"> =&gt; =&gt; sha256:3cc8e449ce9f6e0752ede8f50a7334bf0c7b2d24d76da2ffae7aa6a729dd1da4 9.64MB / 9.64MB                  0.8s</span><br><span class="line"> =&gt; =&gt; extracting sha256:3cc8e449ce9f6e0752ede8f50a7334bf0c7b2d24d76da2ffae7aa6a729dd1da4                       0.3s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/python:3.7-alpine                                            2.7s</span><br><span class="line"> =&gt; [1/6] FROM docker.io/library/python:3.7-alpine@sha256:3b0e1a61106a4c73d1253a86b7765b41d87d1122eb70f99c6de06f0b64edc434                                        2.2s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/library/python:3.7-alpine@sha256:3b0e1a61106a4c73d1253a86b7765b41d87d1122eb70f99c6de06f0b64edc434                                        0.0s</span><br><span class="line"> =&gt; =&gt; sha256:a7ad1a75a9998a18ceb4b3e77ebc933525c48a5e9b1dd6abf258e86f537a7fbf 281.27kB / 281.27kB              0.6s</span><br><span class="line"> =&gt; =&gt; sha256:37ce6546d5dd0143d2fd48adccb48cd0f46c5c2587ce49a53fbd9bd1c5816665 10.57MB / 10.57MB                1.1s</span><br><span class="line"> =&gt; =&gt; sha256:3b0e1a61106a4c73d1253a86b7765b41d87d1122eb70f99c6de06f0b64edc434 1.65kB / 1.65kB                  0.0s</span><br><span class="line"> =&gt; =&gt; sha256:d7c477920ed69ca5744ae133810c519a5ea72ab2da3edf542375d48e10742720 1.37kB / 1.37kB                  0.0s</span><br><span class="line"> =&gt; =&gt; sha256:c46f62f378d72f9a78c4fb150000c479f2bf9095f5616b9f85a8387437e7592c 7.85kB / 7.85kB                  0.0s</span><br><span class="line"> =&gt; =&gt; sha256:540db60ca9383eac9e418f78490994d0af424aab7bf6d0e47ac8ed4e2e9bcbba 2.81MB / 2.81MB                  0.5s</span><br><span class="line"> =&gt; =&gt; extracting sha256:540db60ca9383eac9e418f78490994d0af424aab7bf6d0e47ac8ed4e2e9bcbba                       0.2s</span><br><span class="line"> =&gt; =&gt; sha256:ec9e91bed5a295437fbb8a07b8af46fd69d7dd5beb7ac009c839292454bb3d31 234B / 234B                      1.0s</span><br><span class="line"> =&gt; =&gt; sha256:c629b5f73da8f1113e9c8257d16fc65a95b812483506f56e418183e0d618f07e 2.16MB / 2.16MB                  1.3s</span><br><span class="line"> =&gt; =&gt; extracting sha256:a7ad1a75a9998a18ceb4b3e77ebc933525c48a5e9b1dd6abf258e86f537a7fbf                       0.1s</span><br><span class="line"> =&gt; =&gt; extracting sha256:37ce6546d5dd0143d2fd48adccb48cd0f46c5c2587ce49a53fbd9bd1c5816665                       0.5s</span><br><span class="line"> =&gt; =&gt; extracting sha256:ec9e91bed5a295437fbb8a07b8af46fd69d7dd5beb7ac009c839292454bb3d31                       0.0s</span><br><span class="line"> =&gt; =&gt; extracting sha256:c629b5f73da8f1113e9c8257d16fc65a95b812483506f56e418183e0d618f07e                       0.2s</span><br><span class="line"> =&gt; [internal] load build context                                                                               0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 1.08kB                                                                             0.0s</span><br><span class="line"> =&gt; [2/6] WORKDIR /code                                                                                         0.1s</span><br><span class="line"> =&gt; [3/6] RUN apk add --no-cache gcc musl-dev linux-headers                                                     3.8s</span><br><span class="line"> =&gt; [4/6] COPY requirements.txt requirements.txt                                                                0.0s</span><br><span class="line"> =&gt; [5/6] RUN pip install -r requirements.txt                                                                   4.7s</span><br><span class="line"> =&gt; [6/6] COPY . .                                                                                              0.0s</span><br><span class="line"> =&gt; exporting to image                                                                                          0.7s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                         0.7s</span><br><span class="line"> =&gt; =&gt; writing image sha256:fa0cb4f4c056d1b79ddddb5ec6e21659cb3d84cad4a28d361775161cbe281811                    0.0s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/composetest_web                                                              0.0s</span><br><span class="line">Successfully built fa0cb4f4c056d1b79ddddb5ec6e21659cb3d84cad4a28d361775161cbe281811</span><br><span class="line">WARNING: Image for service web was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.</span><br><span class="line">Pulling redis (redis:alpine)...</span><br><span class="line">alpine: Pulling from library/redis</span><br><span class="line">540db60ca938: Already exists</span><br><span class="line">29712d301e8c: Pull complete</span><br><span class="line">8173c12df40f: Pull complete</span><br><span class="line">0be901b3c77d: Pull complete</span><br><span class="line">c33773bf45b4: Pull complete</span><br><span class="line">6eeb0c30f7e7: Pull complete</span><br><span class="line">Digest: sha256:f9577ac6e68c70b518e691406f2bebee49d8db22118fc87bad3b39c16a1cb46e</span><br><span class="line">Status: Downloaded newer image for redis:alpine</span><br><span class="line">Creating composetest_web_1   ... done</span><br><span class="line">Creating composetest_redis_1 ... done</span><br><span class="line">Attaching to composetest_redis_1, composetest_web_1</span><br><span class="line">redis_1  | 1:C 25 Apr 2021 06:45:13.848 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">redis_1  | 1:C 25 Apr 2021 06:45:13.848 # Redis version=6.2.2, bits=64, commit=00000000, modified=0, pid=1, just started</span><br><span class="line">redis_1  | 1:C 25 Apr 2021 06:45:13.848 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf</span><br><span class="line">redis_1  | 1:M 25 Apr 2021 06:45:13.849 * monotonic clock: POSIX clock_gettime</span><br><span class="line">redis_1  | 1:M 25 Apr 2021 06:45:13.849 * Running mode=standalone, port=6379.</span><br><span class="line">redis_1  | 1:M 25 Apr 2021 06:45:13.849 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">redis_1  | 1:M 25 Apr 2021 06:45:13.849 # Server initialized</span><br><span class="line">redis_1  | 1:M 25 Apr 2021 06:45:13.850 * Ready to accept connections</span><br><span class="line">web_1    |  * Serving Flask app &quot;app.py&quot;</span><br><span class="line">web_1    |  * Environment: production</span><br><span class="line">web_1    |    WARNING: This is a development server. Do not use it in a production deployment.</span><br><span class="line">web_1    |    Use a production WSGI server instead.</span><br><span class="line">web_1    |  * Debug mode: off</span><br><span class="line">web_1    |  * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)</span><br><span class="line">web_1    | 172.20.0.1 - - [25/Apr/2021 06:45:42] &quot;GET / HTTP/1.1&quot; 200 -</span><br><span class="line">web_1    | 172.20.0.1 - - [25/Apr/2021 06:45:42] &quot;GET /favicon.ico HTTP/1.1&quot; 404 -</span><br><span class="line">web_1    | 172.20.0.1 - - [25/Apr/2021 06:45:46] &quot;GET / HTTP/1.1&quot; 200 -</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line"><span class="comment"># CONTAINER ID   IMAGE             COMMAND                  CREATED         STATUS         PORTS                    NAMES</span></span><br><span class="line"><span class="comment"># 621dc8726fe9   composetest_web   &quot;flask run&quot;              8 minutes ago   Up 8 minutes   0.0.0.0:5000-&gt;5000/tcp   composetest_web_1</span></span><br><span class="line"><span class="comment"># 6945405369e2   redis:alpine      &quot;docker-entrypoint.s…&quot;   8 minutes ago   Up 8 minutes   6379/tcp                 composetest_redis_1</span></span><br><span class="line"></span><br><span class="line">docker network ls</span><br><span class="line"><span class="comment"># NETWORK ID     NAME                      DRIVER    SCOPE</span></span><br><span class="line"><span class="comment"># 39a92d7cce05   bridge                    bridge    local</span></span><br><span class="line"><span class="comment"># f713400ac914   composetest_default       bridge    local &lt;- compose 启动之后会创建一个对应的网络，和之前的 log 匹配</span></span><br><span class="line"></span><br><span class="line">docker network inspect composetest_default</span><br><span class="line"><span class="comment"># &quot;Containers&quot;: &#123;</span></span><br><span class="line"><span class="comment">#     &quot;621dc8726fe93265134ead255af6cd572f7a6d82a802a97edd53780248f749dd&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;composetest_web_1&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;000a2b25cc2ffc6b1d86eca556dd06cac05ff6bb70a2cd37d5cce4054559c993&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:ac:14:00:02&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;172.20.0.2/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &quot;6945405369e252c5537743244ed60a7c740f713c20d1df4e0318cf929411f169&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;composetest_redis_1&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;EndpointID&quot;: &quot;857a5962c8220bd8972e6793c5ff521503b6e293d31155b8268a8949bfb4bb72&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;MacAddress&quot;: &quot;02:42:ac:14:00:03&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv4Address&quot;: &quot;172.20.0.3/16&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPv6Address&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># &#125;,</span></span><br></pre></td></tr></table></figure>

<p>注意点：app 中 redis 是通过域名绑定的 <code>cache = redis.Redis(host=&#39;redis&#39;, port=6379)</code> 并不是指定 IP，这里已经用到了 docker 里面的网络了</p>
<h2 id="YAML-规则"><a href="#YAML-规则" class="headerlink" title="YAML 规则"></a>YAML 规则</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 3层</span><br><span class="line"></span><br><span class="line">version: &#x27;&#x27; # 版本</span><br><span class="line">services: # 服务</span><br><span class="line">    服务1: web</span><br><span class="line">        # 服务配置</span><br><span class="line">        images</span><br><span class="line">        build</span><br><span class="line">        network</span><br><span class="line">        ...</span><br><span class="line">    服务2: redis</span><br><span class="line">        ...</span><br><span class="line">    服务2: redis</span><br><span class="line">        ...</span><br><span class="line"># 其他配置 网络/卷，全局规则</span><br><span class="line">volumes:</span><br><span class="line">network:</span><br></pre></td></tr></table></figure>

<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>仿照官方的计数器，写一个 Java 版本的并 compose 启动</p>
<ol>
<li>写项目代码</li>
<li>dockerfile 构建镜像</li>
<li>docker-compose.yml 整合项目</li>
<li>上传服务器 docker-compose up . 启动</li>
</ol>
<p>通过 spring initializr 下载模版，将 spring web + spring data reactive redis 加入依赖</p>
<p>新建 controller 层代码, 目录结构如下</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── CounterApplication.java</span><br><span class="line">└── controller</span><br><span class="line">    └── HelloController.java</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Long views = redisTemplate.opsForValue().increment(<span class="string">&quot;views&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello, counter views: &quot;</span> + views;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置端口，由于配置的是 redis，所以本地启动的时候 redis 是会出问题的，docker 里才 OK</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server.port&#x3D;8080</span><br><span class="line">spring.redis.host&#x3D;redis</span><br></pre></td></tr></table></figure>

<p>maven -&gt; counter -&gt; Lifecycle -&gt; package 打包到 target folder 下</p>
<p>在 target 下新建 Dockerfile 和 docker-compose.yml</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> *.jar /app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;--server.port=8080&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">counterapp:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">counterapp</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;library/redis:alpine&quot;</span></span><br></pre></td></tr></table></figure>

<p>这个有一个东西很奇怪，其实在上面的 Dockerfile 里我是没有指定 docker image 叫什么， 但是下面的 compose file 里直接就拿到了。可能是下面的 <code>build .</code> 的意思是用但前文件加下的 Dockerfile 构建，并取名叫 counterapp </p>
<p>由于我本机就有环境，直接运行即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> target</span><br><span class="line">docker-compose up</span><br><span class="line"></span><br><span class="line"><span class="comment"># network 下会显示 folder 前缀的新网络</span></span><br><span class="line">docker network ls</span><br><span class="line"><span class="comment"># c2b31f70eead   target_default            bridge    local</span></span><br></pre></td></tr></table></figure>

<p>log 输出正常，访问页面正常</p>
<p><code>docker-compose --build</code> 重新构建</p>
<h2 id="Docker-Swarm"><a href="#Docker-Swarm" class="headerlink" title="Docker Swarm"></a>Docker Swarm</h2><p>PS：Mobaxtream multi-execution 简直是太酷炫了！！！</p>
<p>创建 4 个实例并安装 docker，准备实验环境</p>
<p><img src="how_node_work.png" alt="how node works"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">docker swarm --<span class="built_in">help</span>         <span class="comment"># 查看可用命令</span></span><br><span class="line"><span class="comment"># Usage:  docker swarm COMMAND</span></span><br><span class="line"><span class="comment"># Manage Swarm</span></span><br><span class="line"><span class="comment"># Options:</span></span><br><span class="line"><span class="comment">#       --help   Print usage</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Commands:</span></span><br><span class="line"><span class="comment">#   init        Initialize a swarm</span></span><br><span class="line"><span class="comment">#   join        Join a swarm as a node and/or manager</span></span><br><span class="line"><span class="comment">#   join-token  Manage join tokens</span></span><br><span class="line"><span class="comment">#   leave       Leave the swarm</span></span><br><span class="line"><span class="comment">#   unlock      Unlock swarm</span></span><br><span class="line"><span class="comment">#   unlock-key  Manage the unlock key</span></span><br><span class="line"><span class="comment">#   update      Update the swarm</span></span><br><span class="line"></span><br><span class="line">docker swarm init --<span class="built_in">help</span></span><br><span class="line"><span class="comment"># Usage:  docker swarm init [OPTIONS]</span></span><br><span class="line"><span class="comment"># Initialize a swarm</span></span><br><span class="line"><span class="comment"># Options:</span></span><br><span class="line"><span class="comment">#       --advertise-addr string           Advertised address (format: &lt;ip|interface&gt;[:port])</span></span><br><span class="line"><span class="comment">#       --autolock                        Enable manager autolocking (requiring an unlock key to start a stopped manager)</span></span><br><span class="line"><span class="comment">#       --cert-expiry duration            Validity period for node certificates (ns|us|ms|s|m|h) (default 2160h0m0s)</span></span><br><span class="line"><span class="comment">#       --dispatcher-heartbeat duration   Dispatcher heartbeat period (ns|us|ms|s|m|h) (default 5s)</span></span><br><span class="line"><span class="comment">#       --external-ca external-ca         Specifications of one or more certificate signing endpoints</span></span><br><span class="line"><span class="comment">#       --force-new-cluster               Force create a new cluster from current state</span></span><br><span class="line"><span class="comment">#       --help                            Print usage</span></span><br><span class="line"><span class="comment">#       --listen-addr node-addr           Listen address (format: &lt;ip|interface&gt;[:port]) (default 0.0.0.0:2377)</span></span><br><span class="line"><span class="comment">#       --max-snapshots uint              Number of additional Raft snapshots to retain</span></span><br><span class="line"><span class="comment">#       --snapshot-interval uint          Number of log entries between Raft snapshots (default 10000)</span></span><br><span class="line"><span class="comment">#       --task-history-limit int          Task history retention limit (default 5)</span></span><br><span class="line"></span><br><span class="line">docker swarm init --advertise-addr 172.28.231.215       <span class="comment"># 创建 swarm 集群，提供两个可用命令，一个用于添加 worker 节点，一个用于添加 manager 节点</span></span><br><span class="line"><span class="comment"># Swarm initialized: current node (abele1bkn04awsnvvfzj0dof2) is now a manager.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To add a worker to this swarm, run the following command:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     docker swarm join \</span></span><br><span class="line"><span class="comment">#     --token SWMTKN-1-2n1wgk8ws8ca2bz2kr5nkqefrngtizuum901cv7hmhgqnsjuc1-3gwzzivpm27xfqk8ddclf6fth \</span></span><br><span class="line"><span class="comment">#     172.28.231.215:2377</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To add a manager to this swarm, run &#x27;docker swarm join-token manager&#x27; and follow the instructions.</span></span><br><span class="line"></span><br><span class="line">docker node ls              <span class="comment"># 显示集群节点状态</span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2 *  iZuf6brcie4578p0e13tg9Z  Ready   Active        Leader</span></span><br><span class="line"></span><br><span class="line">docker swarm join \</span><br><span class="line">    --token SWMTKN-1-2n1wgk8ws8ca2bz2kr5nkqefrngtizuum901cv7hmhgqnsjuc1-3gwzzivpm27xfqk8ddclf6fth \</span><br><span class="line">    172.28.231.215:2377      <span class="comment"># 挑选一个可用节点，作为一个 worker 节点加入</span></span><br><span class="line"><span class="comment"># This node joined a swarm as a worker.</span></span><br><span class="line"></span><br><span class="line">docker node ls              <span class="comment"># 再次查看节点状态，节点加入成功   </span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># 9xujdtp2c7dob2t1o704tgwvl    iZuf6brcie4578p0e13tg8Z  Ready   Active</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2 *  iZuf6brcie4578p0e13tg9Z  Ready   Active        Leader</span></span><br><span class="line"></span><br><span class="line">docker swarm join-token manager     <span class="comment"># 生成 manager 节点 token</span></span><br><span class="line"><span class="comment"># To add a manager to this swarm, run the following command:</span></span><br><span class="line"><span class="comment">#     docker swarm join \</span></span><br><span class="line"><span class="comment">#     --token SWMTKN-1-2n1wgk8ws8ca2bz2kr5nkqefrngtizuum901cv7hmhgqnsjuc1-392uyq8gmjgp9dj484y8id8jq \</span></span><br><span class="line"><span class="comment">#     172.28.231.215:2377</span></span><br><span class="line"></span><br><span class="line">docker swarm join \</span><br><span class="line">&gt;     --token SWMTKN-1-2n1wgk8ws8ca2bz2kr5nkqefrngtizuum901cv7hmhgqnsjuc1-392uyq8gmjgp9dj484y8id8jq \</span><br><span class="line">&gt;     172.28.231.215:2377       <span class="comment"># 挑选一个可用节点，作为 manager 节点加入集群</span></span><br><span class="line"><span class="comment"># This node joined a swarm as a manager.</span></span><br></pre></td></tr></table></figure>

<h2 id="Raft-协议"><a href="#Raft-协议" class="headerlink" title="Raft 协议"></a>Raft 协议</h2><p>保证大多数节点存活才可用，只要 &gt;1， 集群则要求 &gt; 3</p>
<p>实验：双主双从的情况加，一个主机 down, 另一个主机还是不能使用，并不能达到备份的效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker       <span class="comment"># 停止一个 manager 节点</span></span><br><span class="line"></span><br><span class="line">docker node ls              <span class="comment"># 在另一个 manager 节点上显示 node 信息</span></span><br><span class="line"><span class="comment"># Error response from daemon: rpc error: code = 4 desc = context deadline exceeded</span></span><br><span class="line"></span><br><span class="line">systemctl start docker      <span class="comment"># 重启停止的节点</span></span><br><span class="line"></span><br><span class="line">docker node ls              <span class="comment"># manager 节点的主备节点互换了</span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># 9xujdtp2c7dob2t1o704tgwvl    iZuf6brcie4578p0e13tg8Z  Ready   Active</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2 *  iZuf6brcie4578p0e13tg9Z  Ready   Active        Reachable</span></span><br><span class="line"><span class="comment"># qr1s9a3q7h3j8dw48juw1emg4    myvm01                   Ready   Active        Leader</span></span><br><span class="line"><span class="comment"># y1gs7gsyuwoefjvmw8d9eswrm    iZuf6brcie4578p0e13tgaZ  Ready   Active</span></span><br><span class="line"></span><br><span class="line">docker swarm leave         <span class="comment"># 选取一个 worker 节点，起开集群</span></span><br><span class="line"></span><br><span class="line">docker node ls              <span class="comment"># manager 节点显示，上面的节点 down 了</span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># 9xujdtp2c7dob2t1o704tgwvl    iZuf6brcie4578p0e13tg8Z  Down    Active</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2 *  iZuf6brcie4578p0e13tg9Z  Ready   Active        Reachable</span></span><br><span class="line"><span class="comment"># qr1s9a3q7h3j8dw48juw1emg4    myvm01                   Ready   Active        Leader</span></span><br><span class="line"><span class="comment"># y1gs7gsyuwoefjvmw8d9eswrm    iZuf6brcie4578p0e13tgaZ  Ready   Active</span></span><br><span class="line"></span><br><span class="line">docker swarm join \</span><br><span class="line">     --token SWMTKN-1-2n1wgk8ws8ca2bz2kr5nkqefrngtizuum901cv7hmhgqnsjuc1-392uyq8gmjgp9dj484y8id8jq \</span><br><span class="line">     172.28.231.215:2377        <span class="comment"># 将其开的节点设置为 manger 节点</span></span><br><span class="line"><span class="comment"># This node joined a swarm as a manager.</span></span><br><span class="line"></span><br><span class="line">docker node ls                  <span class="comment"># 显示由三个 manager 节点</span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># 9xujdtp2c7dob2t1o704tgwvl    iZuf6brcie4578p0e13tg8Z  Down    Active</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2    iZuf6brcie4578p0e13tg9Z  Ready   Active        Reachable</span></span><br><span class="line"><span class="comment"># o97d3m17864yftbmq6kdaxel4 *  iZuf6brcie4578p0e13tg8Z  Ready   Active        Reachable</span></span><br><span class="line"><span class="comment"># qr1s9a3q7h3j8dw48juw1emg4    myvm01                   Ready   Active        Leader</span></span><br><span class="line"><span class="comment"># y1gs7gsyuwoefjvmw8d9eswrm    iZuf6brcie4578p0e13tgaZ  Ready   Active</span></span><br><span class="line"></span><br><span class="line">system stop  docker             <span class="comment"># 重复之前的实验，停止一个 manager 节点</span></span><br><span class="line"></span><br><span class="line">docker node ls                  <span class="comment"># 到备用 manager 节点，测试节点信息，可用</span></span><br><span class="line"><span class="comment"># ID                           HOSTNAME                 STATUS  AVAILABILITY  MANAGER STATUS</span></span><br><span class="line"><span class="comment"># 9xujdtp2c7dob2t1o704tgwvl    iZuf6brcie4578p0e13tg8Z  Down    Active</span></span><br><span class="line"><span class="comment"># abele1bkn04awsnvvfzj0dof2    iZuf6brcie4578p0e13tg9Z  Down    Active        Unreachable</span></span><br><span class="line"><span class="comment"># o97d3m17864yftbmq6kdaxel4    iZuf6brcie4578p0e13tg8Z  Ready   Active        Reachable</span></span><br><span class="line"><span class="comment"># qr1s9a3q7h3j8dw48juw1emg4 *  myvm01                   Ready   Active        Leader</span></span><br><span class="line"><span class="comment"># y1gs7gsyuwoefjvmw8d9eswrm    iZuf6brcie4578p0e13tgaZ  Ready   Active</span></span><br></pre></td></tr></table></figure>

<h2 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h2><p>docker-compose up 项目，单机</p>
<p>swarm 集群 services 高可用</p>
<p>容器 -&gt; 服务 -&gt; 副本</p>
<ul>
<li>docker run 容器启动，不能扩容</li>
<li>docker service 服务，可扩容</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker service</span><br><span class="line"><span class="comment"># Usage:  docker service COMMAND</span></span><br><span class="line"><span class="comment"># Manage services</span></span><br><span class="line"><span class="comment"># Options:</span></span><br><span class="line"><span class="comment">#       --help   Print usage</span></span><br><span class="line"><span class="comment"># Commands:</span></span><br><span class="line"><span class="comment">#   create      Create a new service</span></span><br><span class="line"><span class="comment">#   inspect     Display detailed information on one or more services</span></span><br><span class="line"><span class="comment">#   ls          List services</span></span><br><span class="line"><span class="comment">#   ps          List the tasks of a service</span></span><br><span class="line"><span class="comment">#   rm          Remove one or more services</span></span><br><span class="line"><span class="comment">#   scale       Scale one or multiple replicated services</span></span><br><span class="line"><span class="comment">#   update      Update a service</span></span><br><span class="line"><span class="comment"># Run &#x27;docker service COMMAND --help&#x27; for more information on a command.</span></span><br></pre></td></tr></table></figure>

<p>创建服务实践</p>
<ul>
<li>docker run: 单个容器, 不能扩缩容</li>
<li>docker service: 服务，可以扩缩容，可以滚动更新</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">docker service create -p 8888:80 --name my-nginx nginx      <span class="comment"># 创建服务</span></span><br><span class="line"></span><br><span class="line">docker service ps my-nginx</span><br><span class="line"><span class="comment"># ID            NAME        IMAGE         NODE    DESIRED STATE  CURRENT STATE               ERROR  PORTS</span></span><br><span class="line"><span class="comment"># yb78d9o2lsyp  my-nginx.1  nginx:latest  myvm01  Running        Running about a minute ago</span></span><br><span class="line"></span><br><span class="line">docker service ls</span><br><span class="line"><span class="comment"># ID            NAME      MODE        REPLICAS  IMAGE</span></span><br><span class="line"><span class="comment"># sgcat9l69srz  my-nginx  replicated  1/1       nginx:latest</span></span><br><span class="line"></span><br><span class="line">docker ps           <span class="comment"># 这个服务是随机创建在 manager 节点上的</span></span><br><span class="line"></span><br><span class="line">docker service update --replicas 3 my-nginx     <span class="comment"># 添加三个副本</span></span><br><span class="line"></span><br><span class="line">docker ps           <span class="comment"># 去各个节点上看可以看到如下信息，names 为 1-3</span></span><br><span class="line"><span class="comment"># CONTAINER ID        IMAGE                                                                           COMMAND                  CREATED             STATUS              PORTS               NAMES</span></span><br><span class="line"><span class="comment"># 902bbdf9eb3a        nginx@sha256:75a55d33ecc73c2a242450a9f1cc858499d468f077ea942867e662c247b5e412   &quot;/docker-entrypoin...&quot;   9 minutes ago       Up 9 minutes        80/tcp              my-nginx.1.yb78d9o2lsyp0wg7558vn0eew</span></span><br><span class="line"></span><br><span class="line">curl 172.28.231.213:8888        <span class="comment"># 挑选一个节点访问其他节点 nginx 服务，可达</span></span><br><span class="line"><span class="comment"># &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="comment"># &lt;html&gt;</span></span><br><span class="line"><span class="comment"># &lt;head&gt;</span></span><br><span class="line"><span class="comment"># &lt;title&gt;Welcome to nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="comment"># ....</span></span><br><span class="line"><span class="comment"># &lt;/body&gt;</span></span><br><span class="line"><span class="comment"># &lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line">docker service ls</span><br><span class="line"><span class="comment"># ID            NAME      MODE        REPLICAS  IMAGE</span></span><br><span class="line"><span class="comment"># sgcat9l69srz  my-nginx  replicated  10/10     nginx:latest</span></span><br><span class="line"></span><br><span class="line">docker service update --replicas 10 my-nginx     <span class="comment"># 弹性扩缩容</span></span><br><span class="line">docker service update --replicas 1 my-nginx</span><br><span class="line"></span><br><span class="line">docker service scale my-nginx=4                  <span class="comment"># 效果一样，更方便一点</span></span><br><span class="line"><span class="comment"># my-nginx scaled to 4</span></span><br><span class="line"></span><br><span class="line">docker service rm my-nginx                       <span class="comment"># 移除服务</span></span><br></pre></td></tr></table></figure>

<h2 id="概念总结"><a href="#概念总结" class="headerlink" title="概念总结"></a>概念总结</h2><ul>
<li>swarm: 集群的管理和编排。 docker 可以创建一个集群，其他节点可以加入(worker, manager)</li>
<li>Node: docker节点(我觉得理解为虚拟机会比较好)，多个节点组成集群网络</li>
<li>service: 任务，可以在管理节点或工作节点运行</li>
<li>Task: 容器内的命令，细节任务</li>
</ul>
<p>命令 -&gt; 管理节点 -&gt; api -&gt; 调度 -&gt; 工作节点</p>
<p>Publish Mode:</p>
<ul>
<li>swarm</li>
<li>Overlay</li>
<li>ingress - 特殊的 overlay 网络，由负载均衡功能</li>
</ul>
<p><code>docker network ls</code> + <code>docker network inspect ingress</code> 可以看到 swarm 集群中的机子都在这个网络中</p>
<h2 id="以后还要学-Go"><a href="#以后还要学-Go" class="headerlink" title="以后还要学 Go"></a>以后还要学 Go</h2><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>Q: 在最后的 spring 项目实战的 dockerfile 中我明明写了 EXPOSE 8080 为什么我在 run 的时候还要加 p 参数？<br>A: 查看了一下文档，发现这个 EXPOSE 只是起说明作用， run 的时候并不会自动暴露，但是他有一个好处，就是你写了之后，如果用 P 随机的模式的话，他会自动暴露</p>
<p>官方定义如下</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXPOSE 指令是声明容器运行时提供服务的端口，这只是一个声明，在容器运行时并不会因为这个声明应用就会开启这个端口的服务。在 Dockerfile 中写入这样的声明有两个好处，一个是帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射；</span><br><span class="line"></span><br><span class="line">另一个用处则是在运行时使用随机端口映射时，也就是 docker run -P 时，会自动随机映射 EXPOSE 的端口。</span><br><span class="line">要将 EXPOSE 和在运行时使用 -p &lt;宿主端口&gt;:&lt;容器端口&gt; 区分开来。-p，是映射宿主端口和容器端口，换句话说，就是将容器的对应端口服务公开给外界访问，而 EXPOSE 仅仅是声明容器打算使用什么端口而已，并不会自动在宿主进行端口映射。</span><br></pre></td></tr></table></figure>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Jack Zheng
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://jack-zheng.github.io/hexo/2021/04/15/Docker-quick-start/" title="Docker 弹射起步">https://jack-zheng.github.io/hexo/2021/04/15/Docker-quick-start/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/hexo/tags/docker/" rel="tag"># docker</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/hexo/2021/04/13/Design-pattern-decorator/" rel="next" title="装饰器模式">
                  <i class="fa fa-chevron-left"></i> 装饰器模式
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/hexo/2021/04/16/Design-pattern-iterator/" rel="prev" title="迭代器模式">
                  迭代器模式 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%A6%E5%90%8E%E6%80%BB%E7%BB%93"><span class="nav-number">1.</span> <span class="nav-text">学后总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA-Vs-%E5%AE%B9%E5%99%A8"><span class="nav-number">2.</span> <span class="nav-text">虚拟机 Vs 容器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">3.</span> <span class="nav-text">常用命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E9%95%9C%E5%83%8F%E6%93%8D%E4%BD%9C%E5%AE%9E%E8%B7%B5"><span class="nav-number">4.</span> <span class="nav-text">Nginx 镜像操作实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tomcat-%E9%95%9C%E5%83%8F%E6%93%8D%E4%BD%9C%E5%AE%9E%E8%B7%B5"><span class="nav-number">5.</span> <span class="nav-text">Tomcat 镜像操作实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-ES-kibana-%E6%93%8D%E4%BD%9C%E5%AE%9E%E8%B7%B5"><span class="nav-number">6.</span> <span class="nav-text">部署 ES + kibana 操作实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">7.</span> <span class="nav-text">可视化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-%E9%95%9C%E5%83%8F%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86"><span class="nav-number">8.</span> <span class="nav-text">Docker 镜像加载原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F"><span class="nav-number">9.</span> <span class="nav-text">制作镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="nav-number">10.</span> <span class="nav-text">数据卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-MySQL-%E6%93%8D%E4%BD%9C%E5%AE%9E%E8%B7%B5"><span class="nav-number">11.</span> <span class="nav-text">安装 MySQL 操作实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B7%E5%90%8D%E6%8C%82%E8%BD%BD-Vs-%E5%8C%BF%E5%90%8D%E6%8C%82%E8%BD%BD"><span class="nav-number">12.</span> <span class="nav-text">具名挂载 Vs 匿名挂载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB"><span class="nav-number">13.</span> <span class="nav-text">数据共享</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E8%AF%86-Dockerfile"><span class="nav-number">14.</span> <span class="nav-text">初识 Dockerfile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dockerfile"><span class="nav-number">15.</span> <span class="nav-text">Dockerfile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CMD-Vs-ENTRYPOINT"><span class="nav-number">16.</span> <span class="nav-text">CMD Vs ENTRYPOINT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%EF%BC%9A-%E5%88%B6%E4%BD%9C-Tomcat-%E9%95%9C%E5%83%8F"><span class="nav-number">17.</span> <span class="nav-text">实战： 制作 Tomcat 镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker0-%E7%BD%91%E7%BB%9C%E8%AF%A6%E8%A7%A3"><span class="nav-number">18.</span> <span class="nav-text">docker0 网络详解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%80%93link"><span class="nav-number">19.</span> <span class="nav-text">–link</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C"><span class="nav-number">20.</span> <span class="nav-text">自定义网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E8%81%94%E9%80%9A"><span class="nav-number">21.</span> <span class="nav-text">网络联通</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%EF%BC%9A%E9%83%A8%E7%BD%B2-Redis-%E9%9B%86%E7%BE%A4"><span class="nav-number">22.</span> <span class="nav-text">实战：部署 Redis 集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringBoot-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%89%93%E5%8C%85-Docker-%E9%95%9C%E5%83%8F"><span class="nav-number">23.</span> <span class="nav-text">SpringBoot 微服务打包 Docker 镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-Compose"><span class="nav-number">24.</span> <span class="nav-text">Docker Compose</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">25.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E8%B5%B7%E6%AD%A5%E6%95%99%E7%A8%8B"><span class="nav-number">26.</span> <span class="nav-text">官方起步教程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YAML-%E8%A7%84%E5%88%99"><span class="nav-number">27.</span> <span class="nav-text">YAML 规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98"><span class="nav-number">28.</span> <span class="nav-text">实战</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-Swarm"><span class="nav-number">29.</span> <span class="nav-text">Docker Swarm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Raft-%E5%8D%8F%E8%AE%AE"><span class="nav-number">30.</span> <span class="nav-text">Raft 协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-number">31.</span> <span class="nav-text">搭建集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5%E6%80%BB%E7%BB%93"><span class="nav-number">32.</span> <span class="nav-text">概念总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A5%E5%90%8E%E8%BF%98%E8%A6%81%E5%AD%A6-Go"><span class="nav-number">33.</span> <span class="nav-text">以后还要学 Go</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">34.</span> <span class="nav-text">问题</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jack Zheng"
      src="/hexo/images/jack.jpg">
  <p class="site-author-name" itemprop="name">Jack Zheng</p>
  <div class="site-description" itemprop="description">我是张江搬砖小码农, 知识搬运工</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/hexo/archives/">
        
          <span class="site-state-item-count">167</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/hexo/categories/">
          
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/hexo/tags/">
          
        <span class="site-state-item-count">186</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack Zheng</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">846k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">12:50</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v5.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.5.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/hexo/lib/anime.min.js"></script>
  <script src="/hexo/lib/velocity/velocity.min.js"></script>
  <script src="/hexo/lib/velocity/velocity.ui.min.js"></script>

<script src="/hexo/js/utils.js"></script>

<script src="/hexo/js/motion.js"></script>


<script src="/hexo/js/schemes/muse.js"></script>


<script src="/hexo/js/next-boot.js"></script>




  




  
<script src="/hexo/js/local-search.js"></script>














  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: 'd444c814810f7e73ee3a',
      clientSecret: '9b3c417a0c1076887b3cf583c7d7a27456b708ef',
      repo: 'hexo-comments',
      owner: 'jack-zheng',
      admin: ['jack-zheng'],
      id: 'ad9e18d52ce68a8d71df1fcfb612f8f2',
        language: '',
      distractionFreeMode: 'true'
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
</script>

</body>
</html>
